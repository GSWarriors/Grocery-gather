"use strict";
/*
 * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ControlResponseBuilder = void 0;
/**
 * A specialized ResponseBuilder for use with Controls framework
 *
 * This differs from the the regular @see ResponseBuilder in a couple of ways:
 * 1. prompt and reprompt can be built up incrementally via `addPromptFragment()` and `addRepromptFragment()`
 * 2. withShouldEndSession is disabled as the information should be provided via see `ControlResultBuilder`
 *   during `Control.handle()` and `Control.takeInitiative()`
 */
class ControlResponseBuilder {
    constructor(responseBuilder) {
        this.promptFragments = [];
        this.repromptFragments = [];
        this.coreBuilder = responseBuilder;
    }
    /**
     * Determines if a 'display or  APL' directive has been added to the Response.
     */
    isDisplayUsed() {
        return this.displayUsed;
    }
    /**
     * Set the displayUsed flag to indicate if the Response includes content for the device display.
     *
     * Note: calling `.withSimpleCard()`, `.withStandardCard()`, `.addAPLRenderDocumentDirective()` or `.addDirective(type=Alexa.Presentation)` sets this to `true` automatically.
     *
     * Usage:
     *  * If you wish to keep existing APL active on device without resending, setting `displayUsed = true` to communicate this.
     */
    setDisplayUsed(used = true) {
        this.displayUsed = used;
    }
    build() {
        const prompt = this.getPrompt();
        const reprompt = this.getReprompt();
        this.coreBuilder
            .speak(prompt, this.promptPlayBehavior)
            .reprompt(reprompt, this.repromptPlayBehavior);
        return this.coreBuilder.getResponse();
    }
    getPrompt() {
        return this.promptFragments.join(' ');
    }
    getReprompt() {
        return this.repromptFragments.join(' ');
    }
    /**
     * Add the provided speech fragment to the prompt.
     * @param {string} speechOutput
     */
    addPromptFragment(speechOutput) {
        this.promptFragments.push(speechOutput);
        return this;
    }
    /**
     * Add the provided speech fragment to the reprompt.
     * @param {string} speechOutput
     */
    addRepromptFragment(speechOutput) {
        this.repromptFragments.push(speechOutput);
        return this;
    }
    withPromptPlayBehavior(playBehavior) {
        if (this.promptPlayBehavior !== undefined) {
            throw new Error("Play behavior is already set");
        }
        this.promptPlayBehavior = playBehavior;
        return this;
    }
    withRepromptPlayBehavior(playBehavior) {
        if (this.repromptPlayBehavior !== undefined) {
            throw new Error("Play behavior is already set");
        }
        this.repromptPlayBehavior = playBehavior;
        return this;
    }
    // --------------------------------------
    // pass through methods
    speak(speechOutput, playBehavior) {
        throw new Error("Use addPromptFragment and withPromptPlayBehavior instead.");
    }
    reprompt(repromptSpeechOutput, playBehavior) {
        throw new Error("Use addRepromptFragment and withRepromptPlayBehavior instead.");
    }
    withSimpleCard(cardTitle, cardContent) {
        this.coreBuilder.withSimpleCard(cardTitle, cardContent);
        this.displayUsed = true;
        return this;
    }
    withStandardCard(cardTitle, cardContent, smallImageUrl, largeImageUrl) {
        this.coreBuilder.withStandardCard(cardTitle, cardContent, smallImageUrl, largeImageUrl);
        this.displayUsed = true;
        return this;
    }
    withLinkAccountCard() {
        this.coreBuilder.withLinkAccountCard();
        return this;
    }
    withAskForPermissionsConsentCard(permissionArray) {
        this.coreBuilder.withAskForPermissionsConsentCard(permissionArray);
        return this;
    }
    addDelegateDirective(updatedIntent) {
        this.coreBuilder.addDelegateDirective(updatedIntent);
        return this;
    }
    addElicitSlotDirective(slotToElicit, updatedIntent) {
        this.coreBuilder.addElicitSlotDirective(slotToElicit, updatedIntent);
        return this;
    }
    addConfirmSlotDirective(slotToConfirm, updatedIntent) {
        this.coreBuilder.addConfirmSlotDirective(slotToConfirm, updatedIntent);
        return this;
    }
    addConfirmIntentDirective(updatedIntent) {
        this.coreBuilder.addConfirmIntentDirective(updatedIntent);
        return this;
    }
    addAudioPlayerPlayDirective(playBehavior, url, token, offsetInMilliseconds, expectedPreviousToken, audioItemMetadata) {
        this.coreBuilder.addAudioPlayerPlayDirective(playBehavior, url, token, offsetInMilliseconds, expectedPreviousToken);
        return this;
    }
    addAudioPlayerStopDirective() {
        this.coreBuilder.addAudioPlayerStopDirective();
        return this;
    }
    addAudioPlayerClearQueueDirective(clearBehavior) {
        this.coreBuilder.addAudioPlayerClearQueueDirective(clearBehavior);
        return this;
    }
    addRenderTemplateDirective(template) {
        this.coreBuilder.addRenderTemplateDirective(template);
        this.displayUsed = true;
        return this;
    }
    addHintDirective(text) {
        this.coreBuilder.addHintDirective(text);
        return this;
    }
    addVideoAppLaunchDirective(source, title, subtitle) {
        this.coreBuilder.addVideoAppLaunchDirective(source, title, subtitle);
        return this;
    }
    withCanFulfillIntent(canFulfillIntent) {
        this.coreBuilder.withCanFulfillIntent(canFulfillIntent);
        return this;
    }
    withShouldEndSession(val) {
        throw new Error('Do not set this here.. use methods on ControlResultBuilder instead.');
    }
    addDirective(directive) {
        if (directive.type.startsWith('Alexa.Presentation')) {
            this.displayUsed = true;
        }
        this.coreBuilder.addDirective(directive);
        return this;
    }
    // helpers for common directives (incomplete)
    addDynamicEntitiesDirective(dynamicEntitiesDirective) {
        this.coreBuilder.addDirective(dynamicEntitiesDirective);
    }
    addAPLRenderDocumentDirective(token, document, datasources, packages) {
        this.coreBuilder.addDirective({
            type: 'Alexa.Presentation.APL.RenderDocument',
            token,
            document,
            datasources,
            packages
        });
        this.displayUsed = true;
    }
    getResponse() {
        return this.build();
    }
}
exports.ControlResponseBuilder = ControlResponseBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udHJvbFJlc3BvbnNlQnVpbGRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9yZXNwb25zZUdlbmVyYXRpb24vQ29udHJvbFJlc3BvbnNlQnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7OztBQU1IOzs7Ozs7O0dBT0c7QUFDSCxNQUFhLHNCQUFzQjtJQVUvQixZQUFZLGVBQWdDO1FBUHBDLG9CQUFlLEdBQWEsRUFBRSxDQUFDO1FBRS9CLHNCQUFpQixHQUFhLEVBQUUsQ0FBQztRQU1yQyxJQUFJLENBQUMsV0FBVyxHQUFHLGVBQWUsQ0FBQztJQUN2QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxhQUFhO1FBQ1QsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzVCLENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0gsY0FBYyxDQUFDLE9BQWdCLElBQUk7UUFDL0IsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7SUFDNUIsQ0FBQztJQUVELEtBQUs7UUFDRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDaEMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBRXBDLElBQUksQ0FBQyxXQUFXO2FBQ1gsS0FBSyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUM7YUFDdEMsUUFBUSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUVuRCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDMUMsQ0FBQztJQUVELFNBQVM7UUFDTCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFRCxXQUFXO1FBQ1AsT0FBTyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FB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QyxXQUFXLENBQUMsb0JBQW9CLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN4RCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBQ0Qsb0JBQW9CLENBQUMsR0FBWTtRQUM3QixNQUFNLElBQUksS0FBSyxDQUFDLHFFQUFxRSxDQUFDLENBQUM7SUFDM0YsQ0FBQztJQUNELFlBQVksQ0FBQyxTQUFvQjtRQUM3QixJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLG9CQUFvQixDQUFDLEVBQUU7WUFDakQsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7U0FDM0I7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN6QyxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsNkNBQTZDO0lBQzdDLDJCQUEyQixDQUFDLHdCQUF5RDtRQUNqRixJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFDRCw2QkFBNkIsQ0FBQyxLQUFjLEVBQUUsUUFBaUMsRUFBRSxXQUFxQyxFQUFFLFFBQWdCO1FBQ3BJLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUN6QjtZQUNJLElBQUksRUFBRSx1Q0FBdUM7WUFDN0MsS0FBSztZQUNMLFFBQVE7WUFDUixXQUFXO1lBQ1gsUUFBUTtTQUNYLENBQ0osQ0FBQztRQUNGLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO0lBQzVCLENBQUM7SUFFRCxXQUFXO1FBQ1AsT0FBTyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDeEIsQ0FBQztDQUNKO0FBOUxELHdEQThMQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOSBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS5cbiAqIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIG9yIGluIHRoZSBcImxpY2Vuc2VcIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZFxuICogb24gYW4gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyXG4gKiBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZ1xuICogcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IHVpLCBJbnRlbnQsIGludGVyZmFjZXMsIERpcmVjdGl2ZSwgUmVzcG9uc2UsIGRpYWxvZywgY2FuZnVsZmlsbCB9IGZyb20gXCJhc2stc2RrLW1vZGVsXCI7XG5pbXBvcnQgeyBSZXNwb25zZUJ1aWxkZXIsIFJlc3BvbnNlRmFjdG9yeSB9IGZyb20gJ2Fzay1zZGstY29yZSc7XG5cblxuLyoqXG4gKiBBIHNwZWNpYWxpemVkIFJlc3BvbnNlQnVpbGRlciBmb3IgdXNlIHdpdGggQ29udHJvbHMgZnJhbWV3b3JrXG4gKiBcbiAqIFRoaXMgZGlmZmVycyBmcm9tIHRoZSB0aGUgcmVndWxhciBAc2VlIFJlc3BvbnNlQnVpbGRlciBpbiBhIGNvdXBsZSBvZiB3YXlzOlxuICogMS4gcHJvbXB0IGFuZCByZXByb21wdCBjYW4gYmUgYnVpbHQgdXAgaW5jcmVtZW50YWxseSB2aWEgYGFkZFByb21wdEZyYWdtZW50KClgIGFuZCBgYWRkUmVwcm9tcHRGcmFnbWVudCgpYFxuICogMi4gd2l0aFNob3VsZEVuZFNlc3Npb24gaXMgZGlzYWJsZWQgYXMgdGhlIGluZm9ybWF0aW9uIHNob3VsZCBiZSBwcm92aWRlZCB2aWEgc2VlIGBDb250cm9sUmVzdWx0QnVpbGRlcmBcbiAqICAgZHVyaW5nIGBDb250cm9sLmhhbmRsZSgpYCBhbmQgYENvbnRyb2wudGFrZUluaXRpYXRpdmUoKWBcbiAqL1xuZXhwb3J0IGNsYXNzIENvbnRyb2xSZXNwb25zZUJ1aWxkZXIgaW1wbGVtZW50cyBSZXNwb25zZUJ1aWxkZXIge1xuICAgIGNvcmVCdWlsZGVyOiBSZXNwb25zZUJ1aWxkZXI7XG5cbiAgICBwcml2YXRlIHByb21wdEZyYWdtZW50czogc3RyaW5nW10gPSBbXTtcbiAgICBwcml2YXRlIHByb21wdFBsYXlCZWhhdmlvcj86IHVpLlBsYXlCZWhhdmlvcjtcbiAgICBwcml2YXRlIHJlcHJvbXB0RnJhZ21lbnRzOiBzdHJpbmdbXSA9IFtdO1xuICAgIHByaXZhdGUgcmVwcm9tcHRQbGF5QmVoYXZpb3I/OiB1aS5QbGF5QmVoYXZpb3I7XG5cbiAgICBwcml2YXRlIGRpc3BsYXlVc2VkOiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3IocmVzcG9uc2VCdWlsZGVyOiBSZXNwb25zZUJ1aWxkZXIpIHtcbiAgICAgICAgdGhpcy5jb3JlQnVpbGRlciA9IHJlc3BvbnNlQnVpbGRlcjtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZXRlcm1pbmVzIGlmIGEgJ2Rpc3BsYXkgb3IgIEFQTCcgZGlyZWN0aXZlIGhhcyBiZWVuIGFkZGVkIHRvIHRoZSBSZXNwb25zZS5cbiAgICAgKi9cbiAgICBpc0Rpc3BsYXlVc2VkKCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5kaXNwbGF5VXNlZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTZXQgdGhlIGRpc3BsYXlVc2VkIGZsYWcgdG8gaW5kaWNhdGUgaWYgdGhlIFJlc3BvbnNlIGluY2x1ZGVzIGNvbnRlbnQgZm9yIHRoZSBkZXZpY2UgZGlzcGxheS5cbiAgICAgKiBcbiAgICAgKiBOb3RlOiBjYWxsaW5nIGAud2l0aFNpbXBsZUNhcmQoKWAsIGAud2l0aFN0YW5kYXJkQ2FyZCgpYCwgYC5hZGRBUExSZW5kZXJEb2N1bWVudERpcmVjdGl2ZSgpYCBvciBgLmFkZERpcmVjdGl2ZSh0eXBlPUFsZXhhLlByZXNlbnRhdGlvbilgIHNldHMgdGhpcyB0byBgdHJ1ZWAgYXV0b21hdGljYWxseS5cbiAgICAgKiBcbiAgICAgKiBVc2FnZTpcbiAgICAgKiAgKiBJZiB5b3Ugd2lzaCB0byBrZWVwIGV4aXN0aW5nIEFQTCBhY3RpdmUgb24gZGV2aWNlIHdpdGhvdXQgcmVzZW5kaW5nLCBzZXR0aW5nIGBkaXNwbGF5VXNlZCA9IHRydWVgIHRvIGNvbW11bmljYXRlIHRoaXMuXG4gICAgICovXG4gICAgc2V0RGlzcGxheVVzZWQodXNlZDogYm9vbGVhbiA9IHRydWUpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kaXNwbGF5VXNlZCA9IHVzZWQ7XG4gICAgfVxuXG4gICAgYnVpbGQoKTogUmVzcG9uc2Uge1xuICAgICAgICBjb25zdCBwcm9tcHQgPSB0aGlzLmdldFByb21wdCgpO1xuICAgICAgICBjb25zdCByZXByb21wdCA9IHRoaXMuZ2V0UmVwcm9tcHQoKTtcblxuICAgICAgICB0aGlzLmNvcmVCdWlsZGVyXG4gICAgICAgICAgICAuc3BlYWsocHJvbXB0LCB0aGlzLnByb21wdFBsYXlCZWhhdmlvcilcbiAgICAgICAgICAgIC5yZXByb21wdChyZXByb21wdCwgdGhpcy5yZXByb21wdFBsYXlCZWhhdmlvcik7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY29yZUJ1aWxkZXIuZ2V0UmVzcG9uc2UoKTtcbiAgICB9XG5cbiAgICBnZXRQcm9tcHQoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvbXB0RnJhZ21lbnRzLmpvaW4oJyAnKTtcbiAgICB9XG5cbiAgICBnZXRSZXByb21wdCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXByb21wdEZyYWdtZW50cy5qb2luKCcgJyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIHRoZSBwcm92aWRlZCBzcGVlY2ggZnJhZ21lbnQgdG8gdGhlIHByb21wdC5cbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc3BlZWNoT3V0cHV0XG4gICAgICovXG4gICAgYWRkUHJvbXB0RnJhZ21lbnQoc3BlZWNoT3V0cHV0OiBzdHJpbmcpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5wcm9tcHRGcmFnbWVudHMucHVzaChzcGVlY2hPdXRwdXQpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgdGhlIHByb3ZpZGVkIHNwZWVjaCBmcmFnbWVudCB0byB0aGUgcmVwcm9tcHQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHNwZWVjaE91dHB1dFxuICAgICAqL1xuICAgIGFkZFJlcHJvbXB0RnJhZ21lbnQoc3BlZWNoT3V0cHV0OiBzdHJpbmcpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5yZXByb21wdEZyYWdtZW50cy5wdXNoKHNwZWVjaE91dHB1dCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIHdpdGhQcm9tcHRQbGF5QmVoYXZpb3IocGxheUJlaGF2aW9yPzogdWkuUGxheUJlaGF2aW9yKTogdGhpcyB7XG4gICAgICAgIGlmICh0aGlzLnByb21wdFBsYXlCZWhhdmlvciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJQbGF5IGJlaGF2aW9yIGlzIGFscmVhZHkgc2V0XCIpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucHJvbXB0UGxheUJlaGF2aW9yID0gcGxheUJlaGF2aW9yO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICB3aXRoUmVwcm9tcHRQbGF5QmVoYXZpb3IocGxheUJlaGF2aW9yPzogdWkuUGxheUJlaGF2aW9yKTogdGhpcyB7XG4gICAgICAgIGlmICh0aGlzLnJlcHJvbXB0UGxheUJlaGF2aW9yICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlBsYXkgYmVoYXZpb3IgaXMgYWxyZWFkeSBzZXRcIik7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5yZXByb21wdFBsYXlCZWhhdmlvciA9IHBsYXlCZWhhdmlvcjtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG5cbiAgICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAgIC8vIHBhc3MgdGhyb3VnaCBtZXRob2RzXG5cbiAgICBzcGVhayhzcGVlY2hPdXRwdXQ6IHN0cmluZywgcGxheUJlaGF2aW9yPzogXCJFTlFVRVVFXCIgfCBcIlJFUExBQ0VfQUxMXCIgfCBcIlJFUExBQ0VfRU5RVUVVRURcIiB8IHVuZGVmaW5lZCk6IHRoaXMge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVc2UgYWRkUHJvbXB0RnJhZ21lbnQgYW5kIHdpdGhQcm9tcHRQbGF5QmVoYXZpb3IgaW5zdGVhZC5cIik7XG4gICAgfVxuICAgIHJlcHJvbXB0KHJlcHJvbXB0U3BlZWNoT3V0cHV0OiBzdHJpbmcsIHBsYXlCZWhhdmlvcj86IFwiRU5RVUVVRVwiIHwgXCJSRVBMQUNFX0FMTFwiIHwgXCJSRVBMQUNFX0VOUVVFVUVEXCIgfCB1bmRlZmluZWQpOiB0aGlzIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVXNlIGFkZFJlcHJvbXB0RnJhZ21lbnQgYW5kIHdpdGhSZXByb21wdFBsYXlCZWhhdmlvciBpbnN0ZWFkLlwiKTtcbiAgICB9XG4gICAgd2l0aFNpbXBsZUNhcmQoY2FyZFRpdGxlOiBzdHJpbmcsIGNhcmRDb250ZW50OiBzdHJpbmcpOiB0aGlzIHtcbiAgICAgICAgdGhpcy5jb3JlQnVpbGRlci53aXRoU2ltcGxlQ2FyZChjYXJkVGl0bGUsIGNhcmRDb250ZW50KTtcbiAgICAgICAgdGhpcy5kaXNwbGF5VXNlZCA9IHRydWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICB3aXRoU3RhbmRhcmRDYXJkKGNhcmRUaXRsZTogc3RyaW5nLCBjYXJkQ29udGVudDogc3RyaW5nLCBzbWFsbEltYWdlVXJsPzogc3RyaW5nIHwgdW5kZWZpbmVkLCBsYXJnZUltYWdlVXJsPzogc3RyaW5nIHwgdW5kZWZpbmVkKTogdGhpcyB7XG4gICAgICAgIHRoaXMuY29yZUJ1aWxkZXIud2l0aFN0YW5kYXJkQ2FyZChjYXJkVGl0bGUsIGNhcmRDb250ZW50LCBzbWFsbEltYWdlVXJsLCBsYXJnZUltYWdlVXJsKTtcbiAgICAgICAgdGhpcy5kaXNwbGF5VXNlZCA9IHRydWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICB3aXRoTGlua0FjY291bnRDYXJkKCk6IHRoaXMge1xuICAgICAgICB0aGlzLmNvcmVCdWlsZGVyLndpdGhMaW5rQWNjb3VudENhcmQoKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIHdpdGhBc2tGb3JQZXJtaXNzaW9uc0NvbnNlbnRDYXJkKHBlcm1pc3Npb25BcnJheTogc3RyaW5nW10pOiB0aGlzIHtcbiAgICAgICAgdGhpcy5jb3JlQnVpbGRlci53aXRoQXNrRm9yUGVybWlzc2lvbnNDb25zZW50Q2FyZChwZXJtaXNzaW9uQXJyYXkpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgYWRkRGVsZWdhdGVEaXJlY3RpdmUodXBkYXRlZEludGVudD86IEludGVudCB8IHVuZGVmaW5lZCk6IHRoaXMge1xuICAgICAgICB0aGlzLmNvcmVCdWlsZGVyLmFkZERlbGVnYXRlRGlyZWN0aXZlKHVwZGF0ZWRJbnRlbnQpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgYWRkRWxpY2l0U2xvdERpcmVjdGl2ZShzbG90VG9FbGljaXQ6IHN0cmluZywgdXBkYXRlZEludGVudD86IEludGVudCB8IHVuZGVmaW5lZCk6IHRoaXMge1xuICAgICAgICB0aGlzLmNvcmVCdWlsZGVyLmFkZEVsaWNpdFNsb3REaXJlY3RpdmUoc2xvdFRvRWxpY2l0LCB1cGRhdGVkSW50ZW50KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIGFkZENvbmZpcm1TbG90RGlyZWN0aXZlKHNsb3RUb0NvbmZpcm06IHN0cmluZywgdXBkYXRlZEludGVudD86IEludGVudCB8IHVuZGVmaW5lZCk6IHRoaXMge1xuICAgICAgICB0aGlzLmNvcmVCdWlsZGVyLmFkZENvbmZpcm1TbG90RGlyZWN0aXZlKHNsb3RUb0NvbmZpcm0sIHVwZGF0ZWRJbnRlbnQpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgYWRkQ29uZmlybUludGVudERpcmVjdGl2ZSh1cGRhdGVkSW50ZW50PzogSW50ZW50IHwgdW5kZWZpbmVkKTogdGhpcyB7XG4gICAgICAgIHRoaXMuY29yZUJ1aWxkZXIuYWRkQ29uZmlybUludGVudERpcmVjdGl2ZSh1cGRhdGVkSW50ZW50KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIGFkZEF1ZGlvUGxheWVyUGxheURpcmVjdGl2ZShwbGF5QmVoYXZpb3I6IHVpLlBsYXlCZWhhdmlvciwgdXJsOiBzdHJpbmcsIHRva2VuOiBzdHJpbmcsIG9mZnNldEluTWlsbGlzZWNvbmRzOiBudW1iZXIsIGV4cGVjdGVkUHJldmlvdXNUb2tlbj86IHN0cmluZyB8IHVuZGVmaW5lZCwgYXVkaW9JdGVtTWV0YWRhdGE/OiBpbnRlcmZhY2VzLmF1ZGlvcGxheWVyLkF1ZGlvSXRlbU1ldGFkYXRhIHwgdW5kZWZpbmVkKTogdGhpcyB7XG4gICAgICAgIHRoaXMuY29yZUJ1aWxkZXIuYWRkQXVkaW9QbGF5ZXJQbGF5RGlyZWN0aXZlKHBsYXlCZWhhdmlvciwgdXJsLCB0b2tlbiwgb2Zmc2V0SW5NaWxsaXNlY29uZHMsIGV4cGVjdGVkUHJldmlvdXNUb2tlbik7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICBhZGRBdWRpb1BsYXllclN0b3BEaXJlY3RpdmUoKTogdGhpcyB7XG4gICAgICAgIHRoaXMuY29yZUJ1aWxkZXIuYWRkQXVkaW9QbGF5ZXJTdG9wRGlyZWN0aXZlKCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICBhZGRBdWRpb1BsYXllckNsZWFyUXVldWVEaXJlY3RpdmUoY2xlYXJCZWhhdmlvcjogaW50ZXJmYWNlcy5hdWRpb3BsYXllci5DbGVhckJlaGF2aW9yKTogdGhpcyB7XG4gICAgICAgIHRoaXMuY29yZUJ1aWxkZXIuYWRkQXVkaW9QbGF5ZXJDbGVhclF1ZXVlRGlyZWN0aXZlKGNsZWFyQmVoYXZpb3IpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgYWRkUmVuZGVyVGVtcGxhdGVEaXJlY3RpdmUodGVtcGxhdGU6IGludGVyZmFjZXMuZGlzcGxheS5UZW1wbGF0ZSk6IHRoaXMge1xuICAgICAgICB0aGlzLmNvcmVCdWlsZGVyLmFkZFJlbmRlclRlbXBsYXRlRGlyZWN0aXZlKHRlbXBsYXRlKTtcbiAgICAgICAgdGhpcy5kaXNwbGF5VXNlZCA9IHRydWU7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICBhZGRIaW50RGlyZWN0aXZlKHRleHQ6IHN0cmluZyk6IHRoaXMge1xuICAgICAgICB0aGlzLmNvcmVCdWlsZGVyLmFkZEhpbnREaXJlY3RpdmUodGV4dCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICBhZGRWaWRlb0FwcExhdW5jaERpcmVjdGl2ZShzb3VyY2U6IHN0cmluZywgdGl0bGU/OiBzdHJpbmcgfCB1bmRlZmluZWQsIHN1YnRpdGxlPzogc3RyaW5nIHwgdW5kZWZpbmVkKTogdGhpcyB7XG4gICAgICAgIHRoaXMuY29yZUJ1aWxkZXIuYWRkVmlkZW9BcHBMYXVuY2hEaXJlY3RpdmUoc291cmNlLCB0aXRsZSwgc3VidGl0bGUpO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgd2l0aENhbkZ1bGZpbGxJbnRlbnQoY2FuRnVsZmlsbEludGVudDogY2FuZnVsZmlsbC5DYW5GdWxmaWxsSW50ZW50KTogdGhpcyB7XG4gICAgICAgIHRoaXMuY29yZUJ1aWxkZXIud2l0aENhbkZ1bGZpbGxJbnRlbnQoY2FuRnVsZmlsbEludGVudCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICB3aXRoU2hvdWxkRW5kU2Vzc2lvbih2YWw6IGJvb2xlYW4pOiB0aGlzIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdEbyBub3Qgc2V0IHRoaXMgaGVyZS4uIHVzZSBtZXRob2RzIG9uIENvbnRyb2xSZXN1bHRCdWlsZGVyIGluc3RlYWQuJyk7XG4gICAgfVxuICAgIGFkZERpcmVjdGl2ZShkaXJlY3RpdmU6IERpcmVjdGl2ZSk6IHRoaXMge1xuICAgICAgICBpZiAoZGlyZWN0aXZlLnR5cGUuc3RhcnRzV2l0aCgnQWxleGEuUHJlc2VudGF0aW9uJykpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzcGxheVVzZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuY29yZUJ1aWxkZXIuYWRkRGlyZWN0aXZlKGRpcmVjdGl2ZSk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIC8vIGhlbHBlcnMgZm9yIGNvbW1vbiBkaXJlY3RpdmVzIChpbmNvbXBsZXRlKVxuICAgIGFkZER5bmFtaWNFbnRpdGllc0RpcmVjdGl2ZShkeW5hbWljRW50aXRpZXNEaXJlY3RpdmU6IGRpYWxvZy5EeW5hbWljRW50aXRpZXNEaXJlY3RpdmUpIHtcbiAgICAgICAgdGhpcy5jb3JlQnVpbGRlci5hZGREaXJlY3RpdmUoZHluYW1pY0VudGl0aWVzRGlyZWN0aXZlKTtcbiAgICB9XG4gICAgYWRkQVBMUmVuZGVyRG9jdW1lbnREaXJlY3RpdmUodG9rZW4/OiBzdHJpbmcsIGRvY3VtZW50PzogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgZGF0YXNvdXJjZXM/OiB7IFtrZXk6IHN0cmluZ106IGFueTsgfSwgcGFja2FnZXM/OiBhbnlbXSkge1xuICAgICAgICB0aGlzLmNvcmVCdWlsZGVyLmFkZERpcmVjdGl2ZShcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnQWxleGEuUHJlc2VudGF0aW9uLkFQTC5SZW5kZXJEb2N1bWVudCcsXG4gICAgICAgICAgICAgICAgdG9rZW4sXG4gICAgICAgICAgICAgICAgZG9jdW1lbnQsXG4gICAgICAgICAgICAgICAgZGF0YXNvdXJjZXMsXG4gICAgICAgICAgICAgICAgcGFja2FnZXNcbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5kaXNwbGF5VXNlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgZ2V0UmVzcG9uc2UoKTogUmVzcG9uc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5idWlsZCgpO1xuICAgIH1cbn0iXX0=