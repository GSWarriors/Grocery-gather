"use strict";
/*
 * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.findTargetCategory = exports.handleCustomSlots = exports.generateDatesInputGroups = void 0;
const tslib_1 = require("tslib");
// Convert complicated utterance into one or two simple tasks
// E.G. Set date from A to B -> [Set startDate to A, Set endDate to B]
// This function also translate action & target to actionCateGory & targetCategory
// Thus no need to translate action & target in reset of the code
const lodash_1 = tslib_1.__importDefault(require("lodash"));
const DateRangeControl_1 = require("./DateRangeControl");
const DateRangeControlIntent_1 = require("../../intents/DateRangeControlIntent");
const DateHelper_1 = require("./DateHelper");
// Break down complicated utterance into two simple utterances
// E.G. Set start date to 2017 and end date to 2018 --> ['set start date to 2017', 'set end date to 2018']
function generateDatesInputGroups(props, input) {
    // translate all custom target slotTypes to targetCategory
    handleCustomSlots(props.interactionModel, input);
    const inputs = [];
    const inputA = {
        action: undefined,
        target: undefined,
        value: ''
    };
    const inputB = {
        action: undefined,
        target: undefined,
        value: ''
    };
    // Action exist
    if (DateRangeControlIntent_1.hasOneOrMoreActions(input)) {
        if (input.action !== undefined) {
            inputA.action = input.action;
            inputB.action = input.action;
        }
        else {
            inputA.action = input['action.a'];
            inputB.action = input['action.b'];
        }
    }
    // Target exist
    if (DateRangeControlIntent_1.hasOneOrMoreTargets(input)) {
        if (input.target !== undefined) {
            inputA.target = input.target;
            inputB.target = input.target;
        }
        else {
            inputA.target = input['target.a'];
            inputB.target = input['target.b'];
        }
    }
    // value exist
    if (DateRangeControlIntent_1.hasOneOrMoreValues(input)) {
        if (input['AMAZON.DATE'] !== undefined) {
            inputA.value = input['AMAZON.DATE'];
            inputB.value = input['AMAZON.DATE'];
        }
        else {
            inputA.value = input['AMAZON.DATE.a'];
            inputB.value = input['AMAZON.DATE.b'];
        }
    }
    // deduplicate
    // E.G. 'set date to 2019' will be converted to [{'set', 'date', '2019'}, {'set', 'date', '2019'}]
    // need to delete the duplicate one in this scenario
    if (inputA.action === inputB.action && inputA.target === inputB.target && inputA.value === inputB.value) {
        inputs.push(inputA);
    }
    else {
        inputs.push(inputA);
        inputs.push(inputB);
    }
    resolveAmbiguityTargets(inputs);
    return inputs;
}
exports.generateDatesInputGroups = generateDatesInputGroups;
// translate custom target to TargetCategory
function handleCustomSlots(nlu, input) {
    var _a, _b, _c;
    // map target to right targetCategory
    input.target = (_a = findTargetCategory(nlu.targets, input.target)) !== null && _a !== void 0 ? _a : undefined;
    input['target.a'] = (_b = findTargetCategory(nlu.targets, input['target.a'])) !== null && _b !== void 0 ? _b : undefined;
    input['target.b'] = (_c = findTargetCategory(nlu.targets, input['target.b'])) !== null && _c !== void 0 ? _c : undefined;
}
exports.handleCustomSlots = handleCustomSlots;
// Translate slotValue id into target category
function findTargetCategory(targets, input) {
    // E.G. 'date' is an ambiguity target, which may refer to start date or end date
    if (lodash_1.default.includes(targets.startDate, input) && lodash_1.default.includes(targets.endDate, input)) {
        return DateRangeControl_1.TargetCategory.Either;
    }
    if (lodash_1.default.includes(targets.startDate, input)) {
        return DateRangeControl_1.TargetCategory.StartDate;
    }
    if (lodash_1.default.includes(targets.endDate, input)) {
        return DateRangeControl_1.TargetCategory.EndDate;
    }
    return undefined;
}
exports.findTargetCategory = findTargetCategory;
// Only TargetCategory.StartDate and TargetCategory.EndDate is regarded as clear target
function isNotClearTarget(input) {
    if (input === undefined) {
        return true;
    }
    if (input === DateRangeControl_1.TargetCategory.Either || input === DateRangeControl_1.TargetCategory.Both || input === DateRangeControl_1.TargetCategory.Neither) {
        return true;
    }
    return false;
}
// if two values provided without clear target
// generate clear targets, the earlier date will be considered as start date
// E.G. 2020 back to 2017 --> startDate: 2017, endDate: 2020
function resolveAmbiguityTargets(inputs) {
    if (inputs[0] !== undefined && inputs[1] !== undefined && isNotClearTarget(inputs[0].target) && isNotClearTarget(inputs[1].target)) {
        const date1 = DateHelper_1.alexaDateFormatToDate(inputs[0].value);
        const date2 = DateHelper_1.alexaDateFormatToDate(inputs[0].value);
        if (date1 > date2) {
            inputs[0].target = DateRangeControl_1.TargetCategory.EndDate;
            inputs[1].target = DateRangeControl_1.TargetCategory.StartDate;
        }
        else {
            inputs[0].target = DateRangeControl_1.TargetCategory.StartDate;
            inputs[1].target = DateRangeControl_1.TargetCategory.EndDate;
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0ZVJhbmdlTkxVSGVscGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbW1vbkNvbnRyb2xzL2RhdGVSYW5nZUNvbnRyb2wvRGF0ZVJhbmdlTkxVSGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7R0FXRzs7OztBQUVILDZEQUE2RDtBQUM3RCxzRUFBc0U7QUFDdEUsa0ZBQWtGO0FBQ2xGLGlFQUFpRTtBQUVqRSw0REFBdUI7QUFDdkIseURBQStJO0FBQy9JLGlGQUFpSjtBQUNqSiw2Q0FBcUQ7QUFTckQsOERBQThEO0FBQzlELDBHQUEwRztBQUMxRyxTQUFnQix3QkFBd0IsQ0FBQyxLQUEwQyxFQUFFLEtBQWtDO0lBQ25ILDBEQUEwRDtJQUMxRCxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFakQsTUFBTSxNQUFNLEdBQWtDLEVBQUUsQ0FBQztJQUNqRCxNQUFNLE1BQU0sR0FBZ0M7UUFDeEMsTUFBTSxFQUFFLFNBQVM7UUFDakIsTUFBTSxFQUFFLFNBQVM7UUFDakIsS0FBSyxFQUFFLEVBQUU7S0FDWixDQUFDO0lBRUYsTUFBTSxNQUFNLEdBQWdDO1FBQ3hDLE1BQU0sRUFBRSxTQUFTO1FBQ2pCLE1BQU0sRUFBRSxTQUFTO1FBQ2pCLEtBQUssRUFBRSxFQUFFO0tBQ1osQ0FBQztJQUNGLGVBQWU7SUFDZixJQUFJLDRDQUFtQixDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQzVCLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxTQUFTLEVBQUU7WUFDNUIsTUFBTSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1lBQzdCLE1BQU0sQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztTQUNoQzthQUFNO1lBQ0gsTUFBTSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsVUFBVSxDQUFFLENBQUM7WUFDbkMsTUFB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QyxDQUFDLE1BQU0sR0FBRyxpQ0FBYyxDQUFDLFNBQVMsQ0FBQztTQUMvQzthQUFNO1lBQ0gsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxpQ0FBYyxDQUFDLFNBQVMsQ0FBQztZQUM1QyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLGlDQUFjLENBQUMsT0FBTyxDQUFDO1NBQzdDO0tBQ0o7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE5IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLlxuICogWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogb3IgaW4gdGhlIFwibGljZW5zZVwiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkXG4gKiBvbiBhbiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXJcbiAqIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nXG4gKiBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLy8gQ29udmVydCBjb21wbGljYXRlZCB1dHRlcmFuY2UgaW50byBvbmUgb3IgdHdvIHNpbXBsZSB0YXNrc1xuLy8gRS5HLiBTZXQgZGF0ZSBmcm9tIEEgdG8gQiAtPiBbU2V0IHN0YXJ0RGF0ZSB0byBBLCBTZXQgZW5kRGF0ZSB0byBCXVxuLy8gVGhpcyBmdW5jdGlvbiBhbHNvIHRyYW5zbGF0ZSBhY3Rpb24gJiB0YXJnZXQgdG8gYWN0aW9uQ2F0ZUdvcnkgJiB0YXJnZXRDYXRlZ29yeVxuLy8gVGh1cyBubyBuZWVkIHRvIHRyYW5zbGF0ZSBhY3Rpb24gJiB0YXJnZXQgaW4gcmVzZXQgb2YgdGhlIGNvZGVcblxuaW1wb3J0IF8gZnJvbSBcImxvZGFzaFwiO1xuaW1wb3J0IHsgVGFyZ2V0Q2F0ZWdvcnksIERhdGVSYW5nZUNvbnRyb2xUYXJnZXRQcm9wcywgRGF0ZVJhbmdlQ29udHJvbEludGVyYWN0aW9uTW9kZWxQcm9wcywgRGF0ZVJhbmdlQ29udHJvbFByb3BzIH0gZnJvbSAnLi9EYXRlUmFuZ2VDb250cm9sJztcbmltcG9ydCB7IERhdGVSYW5nZUNvbnRyb2xJbnRlbnRTbG90cywgaGFzT25lT3JNb3JlQWN0aW9ucywgaGFzT25lT3JNb3JlVGFyZ2V0cywgaGFzT25lT3JNb3JlVmFsdWVzIH0gZnJvbSAnLi4vLi4vaW50ZW50cy9EYXRlUmFuZ2VDb250cm9sSW50ZW50JztcbmltcG9ydCB7IGFsZXhhRGF0ZUZvcm1hdFRvRGF0ZSB9IGZyb20gJy4vRGF0ZUhlbHBlcic7XG5pbXBvcnQgeyBEZWVwUmVxdWlyZWQgfSBmcm9tICcuLi8uLi91dGlscy9EZWVwUmVxdWlyZWQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIERhdGVSYW5nZUNvbnRyb2xJbnRlbnRJbnB1dCB7XG4gICAgYWN0aW9uOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gICAgdGFyZ2V0OiBUYXJnZXRDYXRlZ29yeSB8IHVuZGVmaW5lZCxcbiAgICB2YWx1ZTogc3RyaW5nXG59XG5cbi8vIEJyZWFrIGRvd24gY29tcGxpY2F0ZWQgdXR0ZXJhbmNlIGludG8gdHdvIHNpbXBsZSB1dHRlcmFuY2VzXG4vLyBFLkcuIFNldCBzdGFydCBkYXRlIHRvIDIwMTcgYW5kIGVuZCBkYXRlIHRvIDIwMTggLS0+IFsnc2V0IHN0YXJ0IGRhdGUgdG8gMjAxNycsICdzZXQgZW5kIGRhdGUgdG8gMjAxOCddXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGVEYXRlc0lucHV0R3JvdXBzKHByb3BzOiBEZWVwUmVxdWlyZWQ8RGF0ZVJhbmdlQ29udHJvbFByb3BzPiwgaW5wdXQ6IERhdGVSYW5nZUNvbnRyb2xJbnRlbnRTbG90cyk6IERhdGVSYW5nZUNvbnRyb2xJbnRlbnRJbnB1dFtdIHtcbiAgICAvLyB0cmFuc2xhdGUgYWxsIGN1c3RvbSB0YXJnZXQgc2xvdFR5cGVzIHRvIHRhcmdldENhdGVnb3J5XG4gICAgaGFuZGxlQ3VzdG9tU2xvdHMocHJvcHMuaW50ZXJhY3Rpb25Nb2RlbCwgaW5wdXQpO1xuXG4gICAgY29uc3QgaW5wdXRzOiBEYXRlUmFuZ2VDb250cm9sSW50ZW50SW5wdXRbXSA9IFtdO1xuICAgIGNvbnN0IGlucHV0QTogRGF0ZVJhbmdlQ29udHJvbEludGVudElucHV0ID0ge1xuICAgICAgICBhY3Rpb246IHVuZGVmaW5lZCxcbiAgICAgICAgdGFyZ2V0OiB1bmRlZmluZWQsXG4gICAgICAgIHZhbHVlOiAnJ1xuICAgIH07XG5cbiAgICBjb25zdCBpbnB1dEI6IERhdGVSYW5nZUNvbnRyb2xJbnRlbnRJbnB1dCA9IHtcbiAgICAgICAgYWN0aW9uOiB1bmRlZmluZWQsXG4gICAgICAgIHRhcmdldDogdW5kZWZpbmVkLFxuICAgICAgICB2YWx1ZTogJydcbiAgICB9O1xuICAgIC8vIEFjdGlvbiBleGlzdFxuICAgIGlmIChoYXNPbmVPck1vcmVBY3Rpb25zKGlucHV0KSkge1xuICAgICAgICBpZiAoaW5wdXQuYWN0aW9uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGlucHV0QS5hY3Rpb24gPSBpbnB1dC5hY3Rpb247XG4gICAgICAgICAgICBpbnB1dEIuYWN0aW9uID0gaW5wdXQuYWN0aW9uO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaW5wdXRBLmFjdGlvbiA9IGlucHV0WydhY3Rpb24uYSddITtcbiAgICAgICAgICAgIGlucHV0Qi5hY3Rpb24gPSBpbnB1dFsnYWN0aW9uLmInXSE7XG4gICAgICAgIH1cbiAgICB9IFxuXG4gICAgLy8gVGFyZ2V0IGV4aXN0XG4gICAgaWYgKGhhc09uZU9yTW9yZVRhcmdldHMoaW5wdXQpKSB7XG4gICAgICAgIGlmIChpbnB1dC50YXJnZXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgaW5wdXRBLnRhcmdldCA9IGlucHV0LnRhcmdldCBhcyBUYXJnZXRDYXRlZ29yeTtcbiAgICAgICAgICAgIGlucHV0Qi50YXJnZXQgPSBpbnB1dC50YXJnZXQgYXMgVGFyZ2V0Q2F0ZWdvcnk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpbnB1dEEudGFyZ2V0ID0gaW5wdXRbJ3RhcmdldC5hJ10hIGFzIFRhcmdldENhdGVnb3J5O1xuICAgICAgICAgICAgaW5wdXRCLnRhcmdldCA9IGlucHV0Wyd0YXJnZXQuYiddISBhcyBUYXJnZXRDYXRlZ29yeTtcbiAgICAgICAgfVxuXG4gICAgfVxuICAgIC8vIHZhbHVlIGV4aXN0XG4gICAgaWYgKGhhc09uZU9yTW9yZVZhbHVlcyhpbnB1dCkpIHtcblxuICAgICAgICBpZiAoaW5wdXRbJ0FNQVpPTi5EQVRFJ10gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgaW5wdXRBLnZhbHVlID0gaW5wdXRbJ0FNQVpPTi5EQVRFJ107XG4gICAgICAgICAgICBpbnB1dEIudmFsdWUgPSBpbnB1dFsnQU1BWk9OLkRBVEUnXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlucHV0QS52YWx1ZSA9IGlucHV0WydBTUFaT04uREFURS5hJ10hO1xuICAgICAgICAgICAgaW5wdXRCLnZhbHVlID0gaW5wdXRbJ0FNQVpPTi5EQVRFLmInXSE7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBkZWR1cGxpY2F0ZVxuICAgIC8vIEUuRy4gJ3NldCBkYXRlIHRvIDIwMTknIHdpbGwgYmUgY29udmVydGVkIHRvIFt7J3NldCcsICdkYXRlJywgJzIwMTknfSwgeydzZXQnLCAnZGF0ZScsICcyMDE5J31dXG4gICAgLy8gbmVlZCB0byBkZWxldGUgdGhlIGR1cGxpY2F0ZSBvbmUgaW4gdGhpcyBzY2VuYXJpb1xuICAgIGlmIChpbnB1dEEuYWN0aW9uID09PSBpbnB1dEIuYWN0aW9uICYmIGlucHV0QS50YXJnZXQgPT09IGlucHV0Qi50YXJnZXQgJiYgaW5wdXRBLnZhbHVlID09PSBpbnB1dEIudmFsdWUpIHtcbiAgICAgICAgaW5wdXRzLnB1c2goaW5wdXRBKTtcbiAgICB9IGVsc2Uge1xuICAgICAgICBpbnB1dHMucHVzaChpbnB1dEEpO1xuICAgICAgICBpbnB1dHMucHVzaChpbnB1dEIpO1xuICAgIH1cblxuICAgIHJlc29sdmVBbWJpZ3VpdHlUYXJnZXRzKGlucHV0cyk7XG5cbiAgICByZXR1cm4gaW5wdXRzO1xufVxuXG4vLyB0cmFuc2xhdGUgY3VzdG9tIHRhcmdldCB0byBUYXJnZXRDYXRlZ29yeVxuZXhwb3J0IGZ1bmN0aW9uIGhhbmRsZUN1c3RvbVNsb3RzKG5sdTogUmVxdWlyZWQ8RGF0ZVJhbmdlQ29udHJvbEludGVyYWN0aW9uTW9kZWxQcm9wcz4sIGlucHV0OiBEYXRlUmFuZ2VDb250cm9sSW50ZW50U2xvdHMpOiB2b2lkIHtcblxuICAgIC8vIG1hcCB0YXJnZXQgdG8gcmlnaHQgdGFyZ2V0Q2F0ZWdvcnlcbiAgICBpbnB1dC50YXJnZXQgPSBmaW5kVGFyZ2V0Q2F0ZWdvcnkobmx1LnRhcmdldHMsIGlucHV0LnRhcmdldCkgPz8gdW5kZWZpbmVkO1xuICAgIGlucHV0Wyd0YXJnZXQuYSddID0gZmluZFRhcmdldENhdGVnb3J5KG5sdS50YXJnZXRzLCBpbnB1dFsndGFyZ2V0LmEnXSkgPz8gdW5kZWZpbmVkO1xuICAgIGlucHV0Wyd0YXJnZXQuYiddID0gZmluZFRhcmdldENhdGVnb3J5KG5sdS50YXJnZXRzLCBpbnB1dFsndGFyZ2V0LmInXSkgPz8gdW5kZWZpbmVkO1xufVxuXG4vLyBUcmFuc2xhdGUgc2xvdFZhbHVlIGlkIGludG8gdGFyZ2V0IGNhdGVnb3J5XG5leHBvcnQgZnVuY3Rpb24gZmluZFRhcmdldENhdGVnb3J5KHRhcmdldHM6IERhdGVSYW5nZUNvbnRyb2xUYXJnZXRQcm9wcywgaW5wdXQ6IHN0cmluZyB8IHVuZGVmaW5lZCk6IFRhcmdldENhdGVnb3J5IHwgdW5kZWZpbmVkIHtcbiAgICAvLyBFLkcuICdkYXRlJyBpcyBhbiBhbWJpZ3VpdHkgdGFyZ2V0LCB3aGljaCBtYXkgcmVmZXIgdG8gc3RhcnQgZGF0ZSBvciBlbmQgZGF0ZVxuICAgIGlmIChfLmluY2x1ZGVzKHRhcmdldHMuc3RhcnREYXRlLCBpbnB1dCkgJiYgXy5pbmNsdWRlcyh0YXJnZXRzLmVuZERhdGUsIGlucHV0KSkge1xuICAgICAgICByZXR1cm4gVGFyZ2V0Q2F0ZWdvcnkuRWl0aGVyO1xuICAgIH1cbiAgICBpZiAoXy5pbmNsdWRlcyh0YXJnZXRzLnN0YXJ0RGF0ZSwgaW5wdXQpKSB7XG4gICAgICAgIHJldHVybiBUYXJnZXRDYXRlZ29yeS5TdGFydERhdGU7XG4gICAgfVxuICAgIGlmIChfLmluY2x1ZGVzKHRhcmdldHMuZW5kRGF0ZSwgaW5wdXQpKSB7XG4gICAgICAgIHJldHVybiBUYXJnZXRDYXRlZ29yeS5FbmREYXRlO1xuICAgIH1cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG4vLyBPbmx5IFRhcmdldENhdGVnb3J5LlN0YXJ0RGF0ZSBhbmQgVGFyZ2V0Q2F0ZWdvcnkuRW5kRGF0ZSBpcyByZWdhcmRlZCBhcyBjbGVhciB0YXJnZXRcbmZ1bmN0aW9uIGlzTm90Q2xlYXJUYXJnZXQoaW5wdXQ6IFRhcmdldENhdGVnb3J5IHwgdW5kZWZpbmVkKTogYm9vbGVhbiB7XG4gICAgaWYgKGlucHV0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIGlmIChpbnB1dCA9PT0gVGFyZ2V0Q2F0ZWdvcnkuRWl0aGVyIHx8IGlucHV0ID09PSBUYXJnZXRDYXRlZ29yeS5Cb3RoIHx8IGlucHV0ID09PSBUYXJnZXRDYXRlZ29yeS5OZWl0aGVyKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG59XG5cbi8vIGlmIHR3byB2YWx1ZXMgcHJvdmlkZWQgd2l0aG91dCBjbGVhciB0YXJnZXRcbi8vIGdlbmVyYXRlIGNsZWFyIHRhcmdldHMsIHRoZSBlYXJsaWVyIGRhdGUgd2lsbCBiZSBjb25zaWRlcmVkIGFzIHN0YXJ0IGRhdGVcbi8vIEUuRy4gMjAyMCBiYWNrIHRvIDIwMTcgLS0+IHN0YXJ0RGF0ZTogMjAxNywgZW5kRGF0ZTogMjAyMFxuZnVuY3Rpb24gcmVzb2x2ZUFtYmlndWl0eVRhcmdldHMoaW5wdXRzOiBEYXRlUmFuZ2VDb250cm9sSW50ZW50SW5wdXRbXSk6IHZvaWQge1xuICAgIFxuICAgIGlmIChpbnB1dHNbMF0gIT09IHVuZGVmaW5lZCAmJiBpbnB1dHNbMV0gIT09IHVuZGVmaW5lZCAmJiBpc05vdENsZWFyVGFyZ2V0KGlucHV0c1swXS50YXJnZXQpICYmIGlzTm90Q2xlYXJUYXJnZXQoaW5wdXRzWzFdLnRhcmdldCkpIHtcbiAgICAgICAgY29uc3QgZGF0ZTE6IERhdGUgPSBhbGV4YURhdGVGb3JtYXRUb0RhdGUoaW5wdXRzWzBdLnZhbHVlKTtcbiAgICAgICAgY29uc3QgZGF0ZTI6IERhdGUgPSBhbGV4YURhdGVGb3JtYXRUb0RhdGUoaW5wdXRzWzBdLnZhbHVlKTtcbiAgICAgICAgaWYgKGRhdGUxID4gZGF0ZTIpIHtcbiAgICAgICAgICAgIGlucHV0c1swXS50YXJnZXQgPSBUYXJnZXRDYXRlZ29yeS5FbmREYXRlO1xuICAgICAgICAgICAgaW5wdXRzWzFdLnRhcmdldCA9IFRhcmdldENhdGVnb3J5LlN0YXJ0RGF0ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGlucHV0c1swXS50YXJnZXQgPSBUYXJnZXRDYXRlZ29yeS5TdGFydERhdGU7XG4gICAgICAgICAgICBpbnB1dHNbMV0udGFyZ2V0ID0gVGFyZ2V0Q2F0ZWdvcnkuRW5kRGF0ZTtcbiAgICAgICAgfVxuICAgIH1cbn0iXX0=