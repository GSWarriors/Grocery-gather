"use strict";
/*
 * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.tryGetForId = exports.ContainerControl = exports.ContainerControlCompleteProps = exports.ContainerControlProps = exports.ContainerControlState = void 0;
const tslib_1 = require("tslib");
const lodash_1 = tslib_1.__importDefault(require("lodash"));
const __1 = require("..");
const Logger_1 = require("../logging/Logger");
const Control_1 = require("./Control");
const log = new Logger_1.Logger('AskSdkControls:ContainerControl');
/**
 * Container state for use in arbitration
 */
class ContainerControlState {
}
exports.ContainerControlState = ContainerControlState;
class ContainerControlProps {
}
exports.ContainerControlProps = ContainerControlProps;
class ContainerControlCompleteProps {
}
exports.ContainerControlCompleteProps = ContainerControlCompleteProps;
/**
 *  Basic container for managing a set of child controls
 *
 *  The basic container does not handle inputs or takes initiative itself but sub-classes
 *  of `ContainerControl` can and should add high-level behaviors and respond to high-level intents.
 *
 *  Container controls should forward simple inputs to the child controls whenever possible in order
 *  to share the load and achieve scalable logic.
 *
 *  Container controls should explicitly decide which child will handle an input or take the initiative
 *  in situations where there are multiple children that respond `canHandle = true` or `canTakeInitiative = true`.
 *
 *  The default decision logic in decideHandlingChild / decideInitiativeChild:
 *   1. Choose the most-recent initiative control if is a candidate.
 *   2. Otherwise, choose the first candidate in the positional order of the `this.children` array.
 *   3. In the special case of input===FallbackIntent, only the most-recent initiative control is considered.
 *      If it is not a candidate, then no child is selected.
 *
 *  Usage:
 *   * Use a ContainerControl to organize and manage a set of child controls.
 *   * Typically a sub-class of ContainerControl is most useful as it allows for customization
 *     of logic before and after delegating to the children.  A sub-class can also customize the
 *     decision logic when multiple children are competing to handle an input or take the initiative.
 */
class ContainerControl extends Control_1.Control {
    constructor(props) {
        super(props.id);
        this.children = [];
        this.rawProps = props;
        this.props = ContainerControl.mergeWithDefaultProps(props);
        this.state = new ContainerControlState();
    }
    static mergeWithDefaultProps(props) {
        const defaults = {
            id: 'dummy',
        };
        return lodash_1.default.merge(defaults, props);
    }
    /**
     *
     * @param control
     * @returns the container
     */
    addChild(control) {
        this.children.push(control);
        return this;
    }
    async canHandle(input) {
        return this.canHandleByChild(input);
    }
    /**
     * Handle the request
     */
    async handle(input, resultBuilder) {
        return this.handleByChild(input, resultBuilder);
    }
    async canTakeInitiative(input) {
        return this.canTakeInitiativeByChild(input);
    }
    async takeInitiative(input, resultBuilder) {
        return this.takeInitiativeByChild(input, resultBuilder);
    }
    stringifyStateForDiagram() {
        return ''; // nothing special to report.
    }
    async canHandleByChild(input) {
        const candidates = await this.gatherHandlingCandidates(input);
        this.selectedHandlingChild = await this.decideHandlingChild(candidates, input);
        if (this.selectedHandlingChild !== undefined) {
            log.debug(`${this.id} canHandleByChild=true. selectedHandlingChild = ${this.selectedHandlingChild.id}`);
            return true;
        }
        log.debug(`${this.id} canHandleByChild=false.`);
        return false;
    }
    async handleByChild(input, resultBuilder) {
        if (!this.selectedHandlingChild) {
            throw new Error('this.selectedHandlingChild is undefined. Did you call canHandle() first? Did it update this.selectedHandlingChild?');
        }
        await this.selectedHandlingChild.handle(input, resultBuilder);
        this.state.lastHandlingControl = { controlId: this.selectedHandlingChild.id, turnNumber: input.turnNumber };
        if (resultBuilder.hasInitiativeAct()) {
            this.state.lastInitiativeChild = { controlId: this.selectedHandlingChild.id, turnNumber: input.turnNumber };
        }
        return;
    }
    async gatherHandlingCandidates(input) {
        const candidates = [];
        for (const child of this.children) {
            const response = await child.canHandle(input);
            if (response) {
                candidates.push(child);
            }
        }
        return candidates;
    }
    /**
     * Decide a winner (or none at all) from the canHandle candidates
     *
     * The eligible candidates are child controls for which `canHandle(input) = true`
     *
     * Default: The default candidate-selection logic is:
     *  1. Choose the  most-recent initiative control if is a candidate.
     *  2. Otherwise, choose the first candidate in the positional order of the `this.children` array.
     *  3. In the special case of input===FallbackIntent, only the most-recent initiative control is considered.
     *     If it is not a candidate, then no child is selected and this method returns undefined.
     *
     * Remarks:
     *  * The special case for FallbackIntent exists because that intent is not user-initiative -- rather it indicates
     *    a failure to understanding the user.  In cases of misunderstanding, only active controls should be considered.
     *
     * @param container
     * @param candidates
     * @param input
     */
    async decideHandlingChild(candidates, input) {
        var _a, _b;
        if (candidates.length === 0) {
            return undefined;
        }
        if (__1.InputUtil.isFallbackIntent(input)) {
            const last = tryGetForId(candidates, (_a = this.state.lastInitiativeChild) === null || _a === void 0 ? void 0 : _a.controlId);
            return last ? last : undefined;
        }
        const mruMatch = tryGetForId(candidates, (_b = this.state.lastInitiativeChild) === null || _b === void 0 ? void 0 : _b.controlId);
        return mruMatch !== null && mruMatch !== void 0 ? mruMatch : candidates[0];
    }
    // -----
    async canTakeInitiativeByChild(input) {
        const candidates = await this.gatherInitiativeCandidates(input);
        this.selectedInitiativeChild = await this.decideInitiativeChild(candidates, input);
        if (this.selectedInitiativeChild !== undefined) {
            log.debug(`${this.id} canTakeInitiative=true. this.selectedInitiativeChild = ${this.selectedInitiativeChild.id}`);
            return true;
        }
        else {
            log.debug(`${this.id} canTakeInitiative=false. No child wants it`);
            return false;
        }
    }
    async takeInitiativeByChild(input, resultBuilder) {
        if (!this.selectedInitiativeChild) {
            throw new Error('this.selectedInitiativeChild is undefined. Did you call canTakeInitiative() first? Did it update this.selectedInitiativeChild?');
        }
        await this.selectedInitiativeChild.takeInitiative(input, resultBuilder);
        this.state.lastInitiativeChild = { controlId: this.selectedInitiativeChild.id, turnNumber: input.turnNumber };
        return;
    }
    async gatherInitiativeCandidates(input) {
        const candidates = [];
        for (const child of this.children) {
            const response = await child.canTakeInitiative(input);
            if (response) {
                candidates.push(child);
            }
        }
        return candidates;
    }
    /**
     * Decide a winner (or none at all) from the canTakeInitiative candidates
     *
     * The eligible candidates are child controls for which `canTakeInitiative(input) = true`
     *
     * Default: The default candidate-selection logic is:
     *  1. choose the most-recent initiative control if is a candidate.
     *  2. otherwise choose the first candidate in the positional order of the `this.children` array.
     *
     * @param container
     * @param candidates
     * @param input
     */
    async decideInitiativeChild(candidates, input) {
        var _a;
        if (candidates.length === 0) {
            return undefined;
        }
        const mruMatch = tryGetForId(candidates, (_a = this.state.lastInitiativeChild) === null || _a === void 0 ? void 0 : _a.controlId);
        return mruMatch !== null && mruMatch !== void 0 ? mruMatch : candidates[0];
    }
}
exports.ContainerControl = ContainerControl;
function tryGetForId(options, childId) {
    if (childId === undefined) {
        return undefined;
    }
    return options.find(c => c.id === childId);
}
exports.tryGetForId = tryGetForId;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udGFpbmVyQ29udHJvbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jb250cm9scy9Db250YWluZXJDb250cm9sLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7R0FXRzs7OztBQUdILDREQUF1QjtBQUN2QiwwQkFBK0I7QUFDL0IsOENBQTJDO0FBQzNDLHVDQUFnRTtBQUtoRSxNQUFNLEdBQUcsR0FBRyxJQUFJLGVBQU0sQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0FBWTFEOztHQUVHO0FBQ0gsTUFBYSxxQkFBcUI7Q0FJakM7QUFKRCxzREFJQztBQUVELE1BQWEscUJBQXFCO0NBRWpDO0FBRkQsc0RBRUM7QUFFRCxNQUFhLDZCQUE2QjtDQUV6QztBQUZELHNFQUVDO0FBR0Q7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBdUJHO0FBQ0gsTUFBYSxnQkFBaUIsU0FBUSxpQkFBTztJQVN6QyxZQUFZLEtBQTRCO1FBQ3BDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7UUFScEIsYUFBUSxHQUFjLEVBQUUsQ0FBQztRQVNyQixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUN0QixJQUFJLENBQUMsS0FBSyxHQUFHLGdCQUFnQixDQUFDLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzNELElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxxQkFBcUIsRUFBRSxDQUFDO0lBQzdDLENBQUM7SUFFRCxNQUFNLENBQUMscUJBQXFCLENBQUMsS0FBNEI7UUFDckQsTUFBTSxRQUFRLEdBQ2Q7WUFDSSxFQUFFLEVBQUUsT0FBTztTQUNkLENBQUM7UUFDRixPQUFPLGdCQUFDLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILFFBQVEsQ0FBQyxPQUFnQjtRQUNyQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUks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ckMsQ0FBQztDQUNKO0FBekxELDRDQXlMQztBQUVELFNBQWdCLFdBQVcsQ0FBQyxPQUFrQixFQUFFLE9BQWdCO0lBQzVELElBQUksT0FBTyxLQUFLLFNBQVMsRUFBRTtRQUN2QixPQUFPLFNBQVMsQ0FBQztLQUNwQjtJQUNELE9BQU8sT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssT0FBTyxDQUFDLENBQUM7QUFDL0MsQ0FBQztBQUxELGtDQUtDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE5IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLlxuICogWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogb3IgaW4gdGhlIFwibGljZW5zZVwiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkXG4gKiBvbiBhbiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXJcbiAqIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nXG4gKiBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuXG5pbXBvcnQgXyBmcm9tIFwibG9kYXNoXCI7XG5pbXBvcnQgeyBJbnB1dFV0aWwgfSBmcm9tICcuLic7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9sb2dnaW5nL0xvZ2dlcic7XG5pbXBvcnQgeyBDb250cm9sLCBDb250cm9sUHJvcHMsIENvbnRyb2xTdGF0ZSB9IGZyb20gJy4vQ29udHJvbCc7XG5pbXBvcnQgeyBDb250cm9sSW5wdXQgfSBmcm9tICcuL0NvbnRyb2xJbnB1dCc7XG5pbXBvcnQgeyBDb250cm9sUmVzdWx0QnVpbGRlciB9IGZyb20gJy4vQ29udHJvbFJlc3VsdCc7XG5pbXBvcnQgeyBJQ29udGFpbmVyQ29udHJvbCB9IGZyb20gJy4vaW50ZXJmYWNlcy9JQ29udGFpbmVyQ29udHJvbCc7XG5cbmNvbnN0IGxvZyA9IG5ldyBMb2dnZXIoJ0Fza1Nka0NvbnRyb2xzOkNvbnRhaW5lckNvbnRyb2wnKTtcblxuXG5cbi8qKlxuICogUmVjb3JkIHRyYWNraW5nIHRoZSB0dXJuIHRoYXQgYSBjaGlsZCBkaWQgc29tZXRoaW5nXG4gKi9cbmludGVyZmFjZSBDaGlsZEFjdGl2aXR5UmVjb3JkIHtcbiAgICBjb250cm9sSWQ6IHN0cmluZztcbiAgICB0dXJuTnVtYmVyOiBudW1iZXI7XG59XG5cbi8qKlxuICogQ29udGFpbmVyIHN0YXRlIGZvciB1c2UgaW4gYXJiaXRyYXRpb25cbiAqL1xuZXhwb3J0IGNsYXNzIENvbnRhaW5lckNvbnRyb2xTdGF0ZSBpbXBsZW1lbnRzIENvbnRyb2xTdGF0ZSB7XG4gICAgdmFsdWU/OiBhbnk7XG4gICAgbGFzdEhhbmRsaW5nQ29udHJvbD86IENoaWxkQWN0aXZpdHlSZWNvcmQ7ICAvLyBUT0RPOiAgbmFtZSBjaGFuZ2UgdG8gbGFzdEhhbmRsaW5nQ29udHJvbEluZm8gfCBsYXN0SGFuZGxpbmdDb250cm9sUmVjb3JkXG4gICAgbGFzdEluaXRpYXRpdmVDaGlsZD86IENoaWxkQWN0aXZpdHlSZWNvcmQ7ICAvLyBkaXR0by5cbn1cblxuZXhwb3J0IGNsYXNzIENvbnRhaW5lckNvbnRyb2xQcm9wcyBpbXBsZW1lbnRzIENvbnRyb2xQcm9wcyB7XG4gICAgaWQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIENvbnRhaW5lckNvbnRyb2xDb21wbGV0ZVByb3BzIGltcGxlbWVudHMgQ29udHJvbFByb3BzIHtcbiAgICBpZDogc3RyaW5nO1xufVxuXG5cbi8qKlxuICogIEJhc2ljIGNvbnRhaW5lciBmb3IgbWFuYWdpbmcgYSBzZXQgb2YgY2hpbGQgY29udHJvbHNcbiAqXG4gKiAgVGhlIGJhc2ljIGNvbnRhaW5lciBkb2VzIG5vdCBoYW5kbGUgaW5wdXRzIG9yIHRha2VzIGluaXRpYXRpdmUgaXRzZWxmIGJ1dCBzdWItY2xhc3Nlc1xuICogIG9mIGBDb250YWluZXJDb250cm9sYCBjYW4gYW5kIHNob3VsZCBhZGQgaGlnaC1sZXZlbCBiZWhhdmlvcnMgYW5kIHJlc3BvbmQgdG8gaGlnaC1sZXZlbCBpbnRlbnRzLlxuICpcbiAqICBDb250YWluZXIgY29udHJvbHMgc2hvdWxkIGZvcndhcmQgc2ltcGxlIGlucHV0cyB0byB0aGUgY2hpbGQgY29udHJvbHMgd2hlbmV2ZXIgcG9zc2libGUgaW4gb3JkZXJcbiAqICB0byBzaGFyZSB0aGUgbG9hZCBhbmQgYWNoaWV2ZSBzY2FsYWJsZSBsb2dpYy5cbiAqXG4gKiAgQ29udGFpbmVyIGNvbnRyb2xzIHNob3VsZCBleHBsaWNpdGx5IGRlY2lkZSB3aGljaCBjaGlsZCB3aWxsIGhhbmRsZSBhbiBpbnB1dCBvciB0YWtlIHRoZSBpbml0aWF0aXZlXG4gKiAgaW4gc2l0dWF0aW9ucyB3aGVyZSB0aGVyZSBhcmUgbXVsdGlwbGUgY2hpbGRyZW4gdGhhdCByZXNwb25kIGBjYW5IYW5kbGUgPSB0cnVlYCBvciBgY2FuVGFrZUluaXRpYXRpdmUgPSB0cnVlYC5cbiAqXG4gKiAgVGhlIGRlZmF1bHQgZGVjaXNpb24gbG9naWMgaW4gZGVjaWRlSGFuZGxpbmdDaGlsZCAvIGRlY2lkZUluaXRpYXRpdmVDaGlsZDpcbiAqICAgMS4gQ2hvb3NlIHRoZSBtb3N0LXJlY2VudCBpbml0aWF0aXZlIGNvbnRyb2wgaWYgaXMgYSBjYW5kaWRhdGUuXG4gKiAgIDIuIE90aGVyd2lzZSwgY2hvb3NlIHRoZSBmaXJzdCBjYW5kaWRhdGUgaW4gdGhlIHBvc2l0aW9uYWwgb3JkZXIgb2YgdGhlIGB0aGlzLmNoaWxkcmVuYCBhcnJheS5cbiAqICAgMy4gSW4gdGhlIHNwZWNpYWwgY2FzZSBvZiBpbnB1dD09PUZhbGxiYWNrSW50ZW50LCBvbmx5IHRoZSBtb3N0LXJlY2VudCBpbml0aWF0aXZlIGNvbnRyb2wgaXMgY29uc2lkZXJlZC5cbiAqICAgICAgSWYgaXQgaXMgbm90IGEgY2FuZGlkYXRlLCB0aGVuIG5vIGNoaWxkIGlzIHNlbGVjdGVkLlxuICpcbiAqICBVc2FnZTpcbiAqICAgKiBVc2UgYSBDb250YWluZXJDb250cm9sIHRvIG9yZ2FuaXplIGFuZCBtYW5hZ2UgYSBzZXQgb2YgY2hpbGQgY29udHJvbHMuXG4gKiAgICogVHlwaWNhbGx5IGEgc3ViLWNsYXNzIG9mIENvbnRhaW5lckNvbnRyb2wgaXMgbW9zdCB1c2VmdWwgYXMgaXQgYWxsb3dzIGZvciBjdXN0b21pemF0aW9uXG4gKiAgICAgb2YgbG9naWMgYmVmb3JlIGFuZCBhZnRlciBkZWxlZ2F0aW5nIHRvIHRoZSBjaGlsZHJlbi4gIEEgc3ViLWNsYXNzIGNhbiBhbHNvIGN1c3RvbWl6ZSB0aGVcbiAqICAgICBkZWNpc2lvbiBsb2dpYyB3aGVuIG11bHRpcGxlIGNoaWxkcmVuIGFyZSBjb21wZXRpbmcgdG8gaGFuZGxlIGFuIGlucHV0IG9yIHRha2UgdGhlIGluaXRpYXRpdmUuXG4gKi9cbmV4cG9ydCBjbGFzcyBDb250YWluZXJDb250cm9sIGV4dGVuZHMgQ29udHJvbCBpbXBsZW1lbnRzIElDb250YWluZXJDb250cm9sIHtcblxuICAgIGNoaWxkcmVuOiBDb250cm9sW10gPSBbXTtcbiAgICBzdGF0ZTogQ29udGFpbmVyQ29udHJvbFN0YXRlO1xuICAgIHJhd1Byb3BzOiBDb250YWluZXJDb250cm9sUHJvcHM7XG4gICAgcHJvcHM6IENvbnRhaW5lckNvbnRyb2xDb21wbGV0ZVByb3BzO1xuICAgIHNlbGVjdGVkSGFuZGxpbmdDaGlsZDogQ29udHJvbCB8IHVuZGVmaW5lZDtcbiAgICBzZWxlY3RlZEluaXRpYXRpdmVDaGlsZDogQ29udHJvbCB8IHVuZGVmaW5lZDtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBDb250YWluZXJDb250cm9sUHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMuaWQpO1xuICAgICAgICB0aGlzLnJhd1Byb3BzID0gcHJvcHM7XG4gICAgICAgIHRoaXMucHJvcHMgPSBDb250YWluZXJDb250cm9sLm1lcmdlV2l0aERlZmF1bHRQcm9wcyhwcm9wcyk7XG4gICAgICAgIHRoaXMuc3RhdGUgPSBuZXcgQ29udGFpbmVyQ29udHJvbFN0YXRlKCk7XG4gICAgfVxuXG4gICAgc3RhdGljIG1lcmdlV2l0aERlZmF1bHRQcm9wcyhwcm9wczogQ29udGFpbmVyQ29udHJvbFByb3BzKTogYW55IHtcbiAgICAgICAgY29uc3QgZGVmYXVsdHM6IENvbnRhaW5lckNvbnRyb2xDb21wbGV0ZVByb3BzID1cbiAgICAgICAge1xuICAgICAgICAgICAgaWQ6ICdkdW1teScsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBfLm1lcmdlKGRlZmF1bHRzLCBwcm9wcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKiBAcGFyYW0gY29udHJvbFxuICAgICAqIEByZXR1cm5zIHRoZSBjb250YWluZXJcbiAgICAgKi9cbiAgICBhZGRDaGlsZChjb250cm9sOiBDb250cm9sKTogdGhpcyB7XG4gICAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjb250cm9sKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYXN5bmMgY2FuSGFuZGxlKGlucHV0OiBDb250cm9sSW5wdXQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuSGFuZGxlQnlDaGlsZChpbnB1dCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSGFuZGxlIHRoZSByZXF1ZXN0XG4gICAgICovXG4gICAgYXN5bmMgaGFuZGxlKGlucHV0OiBDb250cm9sSW5wdXQsIHJlc3VsdEJ1aWxkZXI6IENvbnRyb2xSZXN1bHRCdWlsZGVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhbmRsZUJ5Q2hpbGQoaW5wdXQsIHJlc3VsdEJ1aWxkZXIpO1xuICAgIH1cblxuICAgIGFzeW5jIGNhblRha2VJbml0aWF0aXZlKGlucHV0OiBDb250cm9sSW5wdXQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuVGFrZUluaXRpYXRpdmVCeUNoaWxkKGlucHV0KTtcbiAgICB9XG5cbiAgICBhc3luYyB0YWtlSW5pdGlhdGl2ZShpbnB1dDogQ29udHJvbElucHV0LCByZXN1bHRCdWlsZGVyOiBDb250cm9sUmVzdWx0QnVpbGRlcik6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gdGhpcy50YWtlSW5pdGlhdGl2ZUJ5Q2hpbGQoaW5wdXQsIHJlc3VsdEJ1aWxkZXIpO1xuICAgIH1cblxuICAgIHN0cmluZ2lmeVN0YXRlRm9yRGlhZ3JhbSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gJyc7IC8vIG5vdGhpbmcgc3BlY2lhbCB0byByZXBvcnQuXG4gICAgfVxuXG5cbiAgICBhc3luYyBjYW5IYW5kbGVCeUNoaWxkKGlucHV0OiBDb250cm9sSW5wdXQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgY2FuZGlkYXRlcyA9IGF3YWl0IHRoaXMuZ2F0aGVySGFuZGxpbmdDYW5kaWRhdGVzKGlucHV0KTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZEhhbmRsaW5nQ2hpbGQgPSBhd2FpdCB0aGlzLmRlY2lkZUhhbmRsaW5nQ2hpbGQoY2FuZGlkYXRlcywgaW5wdXQpO1xuICAgICAgICBpZiAodGhpcy5zZWxlY3RlZEhhbmRsaW5nQ2hpbGQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKGAke3RoaXMuaWR9IGNhbkhhbmRsZUJ5Q2hpbGQ9dHJ1ZS4gc2VsZWN0ZWRIYW5kbGluZ0NoaWxkID0gJHt0aGlzLnNlbGVjdGVkSGFuZGxpbmdDaGlsZC5pZH1gKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgbG9nLmRlYnVnKGAke3RoaXMuaWR9IGNhbkhhbmRsZUJ5Q2hpbGQ9ZmFsc2UuYCk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcblxuICAgIH1cblxuICAgIGFzeW5jIGhhbmRsZUJ5Q2hpbGQoaW5wdXQ6IENvbnRyb2xJbnB1dCwgcmVzdWx0QnVpbGRlcjogQ29udHJvbFJlc3VsdEJ1aWxkZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKCF0aGlzLnNlbGVjdGVkSGFuZGxpbmdDaGlsZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd0aGlzLnNlbGVjdGVkSGFuZGxpbmdDaGlsZCBpcyB1bmRlZmluZWQuIERpZCB5b3UgY2FsbCBjYW5IYW5kbGUoKSBmaXJzdD8gRGlkIGl0IHVwZGF0ZSB0aGlzLnNlbGVjdGVkSGFuZGxpbmdDaGlsZD8nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMuc2VsZWN0ZWRIYW5kbGluZ0NoaWxkLmhhbmRsZShpbnB1dCwgcmVzdWx0QnVpbGRlcik7XG4gICAgICAgIHRoaXMuc3RhdGUubGFzdEhhbmRsaW5nQ29udHJvbCA9IHsgY29udHJvbElkOiB0aGlzLnNlbGVjdGVkSGFuZGxpbmdDaGlsZC5pZCwgdHVybk51bWJlcjogaW5wdXQudHVybk51bWJlciB9O1xuXG4gICAgICAgIGlmIChyZXN1bHRCdWlsZGVyLmhhc0luaXRpYXRpdmVBY3QoKSl7XG4gICAgICAgICAgICB0aGlzLnN0YXRlLmxhc3RJbml0aWF0aXZlQ2hpbGQgPSB7IGNvbnRyb2xJZDogdGhpcy5zZWxlY3RlZEhhbmRsaW5nQ2hpbGQuaWQsIHR1cm5OdW1iZXI6IGlucHV0LnR1cm5OdW1iZXIgfTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBhc3luYyBnYXRoZXJIYW5kbGluZ0NhbmRpZGF0ZXMoaW5wdXQ6IENvbnRyb2xJbnB1dCk6IFByb21pc2U8Q29udHJvbFtdPiB7XG4gICAgICAgIGNvbnN0IGNhbmRpZGF0ZXM6IENvbnRyb2xbXSA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2hpbGQuY2FuSGFuZGxlKGlucHV0KTtcbiAgICAgICAgICAgIGlmIChyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIGNhbmRpZGF0ZXMucHVzaChjaGlsZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNhbmRpZGF0ZXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVjaWRlIGEgd2lubmVyIChvciBub25lIGF0IGFsbCkgZnJvbSB0aGUgY2FuSGFuZGxlIGNhbmRpZGF0ZXNcbiAgICAgKlxuICAgICAqIFRoZSBlbGlnaWJsZSBjYW5kaWRhdGVzIGFyZSBjaGlsZCBjb250cm9scyBmb3Igd2hpY2ggYGNhbkhhbmRsZShpbnB1dCkgPSB0cnVlYFxuICAgICAqXG4gICAgICogRGVmYXVsdDogVGhlIGRlZmF1bHQgY2FuZGlkYXRlLXNlbGVjdGlvbiBsb2dpYyBpczpcbiAgICAgKiAgMS4gQ2hvb3NlIHRoZSAgbW9zdC1yZWNlbnQgaW5pdGlhdGl2ZSBjb250cm9sIGlmIGlzIGEgY2FuZGlkYXRlLlxuICAgICAqICAyLiBPdGhlcndpc2UsIGNob29zZSB0aGUgZmlyc3QgY2FuZGlkYXRlIGluIHRoZSBwb3NpdGlvbmFsIG9yZGVyIG9mIHRoZSBgdGhpcy5jaGlsZHJlbmAgYXJyYXkuXG4gICAgICogIDMuIEluIHRoZSBzcGVjaWFsIGNhc2Ugb2YgaW5wdXQ9PT1GYWxsYmFja0ludGVudCwgb25seSB0aGUgbW9zdC1yZWNlbnQgaW5pdGlhdGl2ZSBjb250cm9sIGlzIGNvbnNpZGVyZWQuXG4gICAgICogICAgIElmIGl0IGlzIG5vdCBhIGNhbmRpZGF0ZSwgdGhlbiBubyBjaGlsZCBpcyBzZWxlY3RlZCBhbmQgdGhpcyBtZXRob2QgcmV0dXJucyB1bmRlZmluZWQuXG4gICAgICpcbiAgICAgKiBSZW1hcmtzOlxuICAgICAqICAqIFRoZSBzcGVjaWFsIGNhc2UgZm9yIEZhbGxiYWNrSW50ZW50IGV4aXN0cyBiZWNhdXNlIHRoYXQgaW50ZW50IGlzIG5vdCB1c2VyLWluaXRpYXRpdmUgLS0gcmF0aGVyIGl0IGluZGljYXRlc1xuICAgICAqICAgIGEgZmFpbHVyZSB0byB1bmRlcnN0YW5kaW5nIHRoZSB1c2VyLiAgSW4gY2FzZXMgb2YgbWlzdW5kZXJzdGFuZGluZywgb25seSBhY3RpdmUgY29udHJvbHMgc2hvdWxkIGJlIGNvbnNpZGVyZWQuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gY29udGFpbmVyXG4gICAgICogQHBhcmFtIGNhbmRpZGF0ZXNcbiAgICAgKiBAcGFyYW0gaW5wdXRcbiAgICAgKi9cbiAgICBhc3luYyBkZWNpZGVIYW5kbGluZ0NoaWxkKGNhbmRpZGF0ZXM6IENvbnRyb2xbXSwgaW5wdXQ6IENvbnRyb2xJbnB1dCk6IFByb21pc2U8Q29udHJvbCB8IHVuZGVmaW5lZD4ge1xuICAgICAgICBpZiAoY2FuZGlkYXRlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKElucHV0VXRpbC5pc0ZhbGxiYWNrSW50ZW50KGlucHV0KSkge1xuICAgICAgICAgICAgY29uc3QgbGFzdCA9IHRyeUdldEZvcklkKGNhbmRpZGF0ZXMsIHRoaXMuc3RhdGUubGFzdEluaXRpYXRpdmVDaGlsZD8uY29udHJvbElkKTtcbiAgICAgICAgICAgIHJldHVybiBsYXN0ID8gbGFzdCA6IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBtcnVNYXRjaCA9IHRyeUdldEZvcklkKGNhbmRpZGF0ZXMsIHRoaXMuc3RhdGUubGFzdEluaXRpYXRpdmVDaGlsZD8uY29udHJvbElkKTtcbiAgICAgICAgcmV0dXJuIG1ydU1hdGNoID8/IGNhbmRpZGF0ZXNbMF07XG4gICAgfVxuXG5cbiAgICAvLyAtLS0tLVxuXG4gICAgYXN5bmMgY2FuVGFrZUluaXRpYXRpdmVCeUNoaWxkKGlucHV0OiBDb250cm9sSW5wdXQpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgY29uc3QgY2FuZGlkYXRlcyA9IGF3YWl0IHRoaXMuZ2F0aGVySW5pdGlhdGl2ZUNhbmRpZGF0ZXMoaW5wdXQpO1xuICAgICAgICB0aGlzLnNlbGVjdGVkSW5pdGlhdGl2ZUNoaWxkID0gYXdhaXQgdGhpcy5kZWNpZGVJbml0aWF0aXZlQ2hpbGQoY2FuZGlkYXRlcywgaW5wdXQpO1xuICAgICAgICBpZiAodGhpcy5zZWxlY3RlZEluaXRpYXRpdmVDaGlsZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBsb2cuZGVidWcoYCR7dGhpcy5pZH0gY2FuVGFrZUluaXRpYXRpdmU9dHJ1ZS4gdGhpcy5zZWxlY3RlZEluaXRpYXRpdmVDaGlsZCA9ICR7dGhpcy5zZWxlY3RlZEluaXRpYXRpdmVDaGlsZC5pZH1gKTtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgbG9nLmRlYnVnKGAke3RoaXMuaWR9IGNhblRha2VJbml0aWF0aXZlPWZhbHNlLiBObyBjaGlsZCB3YW50cyBpdGApO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgdGFrZUluaXRpYXRpdmVCeUNoaWxkKGlucHV0OiBDb250cm9sSW5wdXQsIHJlc3VsdEJ1aWxkZXI6IENvbnRyb2xSZXN1bHRCdWlsZGVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGlmICghdGhpcy5zZWxlY3RlZEluaXRpYXRpdmVDaGlsZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd0aGlzLnNlbGVjdGVkSW5pdGlhdGl2ZUNoaWxkIGlzIHVuZGVmaW5lZC4gRGlkIHlvdSBjYWxsIGNhblRha2VJbml0aWF0aXZlKCkgZmlyc3Q/IERpZCBpdCB1cGRhdGUgdGhpcy5zZWxlY3RlZEluaXRpYXRpdmVDaGlsZD8nKTtcbiAgICAgICAgfVxuICAgICAgICBhd2FpdCB0aGlzLnNlbGVjdGVkSW5pdGlhdGl2ZUNoaWxkLnRha2VJbml0aWF0aXZlKGlucHV0LCByZXN1bHRCdWlsZGVyKTtcbiAgICAgICAgdGhpcy5zdGF0ZS5sYXN0SW5pdGlhdGl2ZUNoaWxkID0geyBjb250cm9sSWQ6IHRoaXMuc2VsZWN0ZWRJbml0aWF0aXZlQ2hpbGQuaWQsIHR1cm5OdW1iZXI6IGlucHV0LnR1cm5OdW1iZXIgfTtcblxuICAgICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgYXN5bmMgZ2F0aGVySW5pdGlhdGl2ZUNhbmRpZGF0ZXMoaW5wdXQ6IENvbnRyb2xJbnB1dCk6IFByb21pc2U8Q29udHJvbFtdPiB7XG4gICAgICAgIGNvbnN0IGNhbmRpZGF0ZXM6IENvbnRyb2xbXSA9IFtdO1xuICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHRoaXMuY2hpbGRyZW4pIHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2hpbGQuY2FuVGFrZUluaXRpYXRpdmUoaW5wdXQpO1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgY2FuZGlkYXRlcy5wdXNoKGNoaWxkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gY2FuZGlkYXRlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZWNpZGUgYSB3aW5uZXIgKG9yIG5vbmUgYXQgYWxsKSBmcm9tIHRoZSBjYW5UYWtlSW5pdGlhdGl2ZSBjYW5kaWRhdGVzXG4gICAgICpcbiAgICAgKiBUaGUgZWxpZ2libGUgY2FuZGlkYXRlcyBhcmUgY2hpbGQgY29udHJvbHMgZm9yIHdoaWNoIGBjYW5UYWtlSW5pdGlhdGl2ZShpbnB1dCkgPSB0cnVlYFxuICAgICAqXG4gICAgICogRGVmYXVsdDogVGhlIGRlZmF1bHQgY2FuZGlkYXRlLXNlbGVjdGlvbiBsb2dpYyBpczpcbiAgICAgKiAgMS4gY2hvb3NlIHRoZSBtb3N0LXJlY2VudCBpbml0aWF0aXZlIGNvbnRyb2wgaWYgaXMgYSBjYW5kaWRhdGUuXG4gICAgICogIDIuIG90aGVyd2lzZSBjaG9vc2UgdGhlIGZpcnN0IGNhbmRpZGF0ZSBpbiB0aGUgcG9zaXRpb25hbCBvcmRlciBvZiB0aGUgYHRoaXMuY2hpbGRyZW5gIGFycmF5LlxuICAgICAqXG4gICAgICogQHBhcmFtIGNvbnRhaW5lclxuICAgICAqIEBwYXJhbSBjYW5kaWRhdGVzXG4gICAgICogQHBhcmFtIGlucHV0XG4gICAgICovXG4gICAgYXN5bmMgZGVjaWRlSW5pdGlhdGl2ZUNoaWxkKGNhbmRpZGF0ZXM6IENvbnRyb2xbXSwgaW5wdXQ6IENvbnRyb2xJbnB1dCk6IFByb21pc2U8Q29udHJvbCB8IHVuZGVmaW5lZD4ge1xuICAgICAgICBpZiAoY2FuZGlkYXRlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbXJ1TWF0Y2ggPSB0cnlHZXRGb3JJZChjYW5kaWRhdGVzLCB0aGlzLnN0YXRlLmxhc3RJbml0aWF0aXZlQ2hpbGQ/LmNvbnRyb2xJZCk7XG4gICAgICAgIHJldHVybiBtcnVNYXRjaCA/PyBjYW5kaWRhdGVzWzBdO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRyeUdldEZvcklkKG9wdGlvbnM6IENvbnRyb2xbXSwgY2hpbGRJZD86IHN0cmluZykge1xuICAgIGlmIChjaGlsZElkID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgcmV0dXJuIG9wdGlvbnMuZmluZChjID0+IGMuaWQgPT09IGNoaWxkSWQpO1xufVxuIl19