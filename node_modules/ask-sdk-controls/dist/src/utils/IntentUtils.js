"use strict";
/*
 * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.getMVSSlotResolutions = exports.SimplifiedMVSIntent = exports.getSlotResolutions = exports.SimplifiedIntent = exports.IntentBuilder = void 0;
class IntentBuilder {
    static of(name, slotValues) {
        const intent = {
            name,
            confirmationStatus: 'NONE',
            slots: {}
        };
        for (const prop of Object.entries(slotValues !== null && slotValues !== void 0 ? slotValues : {})) {
            const name = prop[0];
            const value = prop[1];
            if (Array.isArray(value)) {
                if (value.length === 0) {
                    throw new Error('Slot of empty-array is not supported');
                }
                // Multi-value slot
                intent.slots[name] = {
                    name,
                    slotValue: {
                        type: 'List',
                        values: value.map(item => ({
                            type: 'Simple',
                            value: item
                        }))
                    },
                    confirmationStatus: 'NONE'
                };
            }
            else {
                // Single-value slot
                intent.slots[name] = {
                    name,
                    value: value !== undefined ? value : '',
                    confirmationStatus: 'NONE'
                };
            }
        }
        return intent;
    }
}
exports.IntentBuilder = IntentBuilder;
// TODO:retire this class once SimplifiedMVSIntent is covering all cases successfully.
class SimplifiedIntent {
    constructor(name, slotResolutions) {
        this.name = name;
        this.slotResolutions = slotResolutions;
    }
    static fromIntent(intent) {
        const slotResolutions = {};
        if (intent.slots) {
            for (const [name, slot] of Object.entries(intent.slots)) {
                const slotObject = getSlotResolutions(slot);
                if (Array.isArray(slotObject)) {
                    throw new Error("Slot is multi-valued.  Use SimplifiedMVSIntent");
                }
                else {
                    slotResolutions[name] = slotObject !== undefined ? slotObject : undefined;
                }
            }
        }
        return new SimplifiedIntent(intent.name, slotResolutions);
    }
    toString() {
        return JSON.stringify(this);
    }
}
exports.SimplifiedIntent = SimplifiedIntent;
// TODO:retire this func once SimplifiedMVSIntent is covering all cases successfully.
/**
 * If there is an ER-Success, this returns the canonical value id of the first match resolution along with
 * isEntityResolutionMatch: boolean to indicate the status of ER_SUCCESS_MATCH
 * Otherwise this returns the object of literal slot value and isEntityResolutionMatch set to false.
 *
 * @param slot
 */
function getSlotResolutions(slot) {
    if (slot === undefined || slot.value === undefined || slot.value.length === 0) {
        return undefined;
    }
    // regular single-value handling
    if (slot.resolutions && slot.resolutions.resolutionsPerAuthority && slot.resolutions.resolutionsPerAuthority.length > 0) {
        for (const resolutionsPerAuthority of slot.resolutions.resolutionsPerAuthority) {
            if (resolutionsPerAuthority.status.code === 'ER_SUCCESS_MATCH') {
                return { slotValue: resolutionsPerAuthority.values[0].value.id, isEntityResolutionMatch: true };
            }
        }
    }
    return { slotValue: slot.value, isEntityResolutionMatch: false };
}
exports.getSlotResolutions = getSlotResolutions;
// ---- MVS support ----
class SimplifiedMVSIntent {
    constructor(name, slotResolutions) {
        this.name = name;
        this.slotResolutions = slotResolutions;
    }
    static fromIntent(intent) {
        const slotResolutions = {};
        if (intent.slots) {
            for (const [name, slot] of Object.entries(intent.slots)) {
                const slotObject = getMVSSlotResolutions(slot);
                slotResolutions[name] = slotObject !== undefined ? slotObject : undefined;
            }
        }
        return new SimplifiedMVSIntent(intent.name, slotResolutions);
    }
    toString() {
        return JSON.stringify(this);
    }
}
exports.SimplifiedMVSIntent = SimplifiedMVSIntent;
/**
 * If there is an ER-Success, this returns the canonical value id of the first match resolution along with
 * isEntityResolutionMatch: boolean to indicate the status of ER_SUCCESS_MATCH
 * Otherwise this returns the object of literal slot value and isEntityResolutionMatch set to false.
 *
 * @param slot
 */
function getMVSSlotResolutions(slot) {
    if (slot === undefined) {
        return undefined;
    }
    {
        // handling for MVS which isn't in ask-sdk yet.
        const slotValue = slot.slotValue;
        // eslint-disable-next-line no-empty
        if (slotValue !== undefined && slotValue.type === 'List' && slotValue.values.length > 0) {
            const slotValuesAsSlots = slotValue.values;
            const values = slotValuesAsSlots.map(slot => {
                var _a, _b, _c;
                if (slot.resolutions && slot.resolutions.resolutionsPerAuthority && slot.resolutions.resolutionsPerAuthority.length > 0) {
                    for (const resolutionsPerAuthority of slot.resolutions.resolutionsPerAuthority) {
                        if (resolutionsPerAuthority.status.code === 'ER_SUCCESS_MATCH') {
                            return { slotValue: resolutionsPerAuthority.values[0].value.id, isEntityResolutionMatch: true };
                        }
                        else {
                            return { slotValue: (_a = slot.value) !== null && _a !== void 0 ? _a : "", isEntityResolutionMatch: false };
                        }
                    }
                    return { slotValue: (_b = slot.value) !== null && _b !== void 0 ? _b : "", isEntityResolutionMatch: false };
                }
                else {
                    return { slotValue: (_c = slot.value) !== null && _c !== void 0 ? _c : "", isEntityResolutionMatch: false };
                }
            });
            return values;
        }
    }
    if (slot.value === undefined || slot.value.length === 0) {
        return undefined;
    }
    // regular single-value handling
    if (slot.resolutions && slot.resolutions.resolutionsPerAuthority && slot.resolutions.resolutionsPerAuthority.length > 0) {
        for (const resolutionsPerAuthority of slot.resolutions.resolutionsPerAuthority) {
            if (resolutionsPerAuthority.status.code === 'ER_SUCCESS_MATCH') {
                return { slotValue: resolutionsPerAuthority.values[0].value.id, isEntityResolutionMatch: true };
            }
        }
    }
    return { slotValue: slot.value, isEntityResolutionMatch: false };
}
exports.getMVSSlotResolutions = getMVSSlotResolutions;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW50ZW50VXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvdXRpbHMvSW50ZW50VXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7OztHQVdHOzs7QUFJSCxNQUFhLGFBQWE7SUFDdEIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxJQUFZLEVBQUUsVUFBaUM7UUFDckQsTUFBTSxNQUFNLEdBQVc7WUFDbkIsSUFBSTtZQUNKLGtCQUFrQixFQUFFLE1BQU07WUFDMUIsS0FBSyxFQUFFLEVBQUU7U0FDWixDQUFDO1FBRUYsS0FBSyxNQUFNLElBQUksSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFVBQVUsYUFBVixVQUFVLGNBQVYsVUFBVSxHQUFJLEVBQUUsQ0FBQyxFQUFFO1lBQ2pELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFFdEIsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFDO2dCQUNyQixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFDO29CQUNuQixNQUFNLElBQUksS0FBSyxDQUFDLHNDQUFzQyxDQUFDLENBQUM7aUJBQzNEO2dCQUVELG1CQUFtQjtnQkFDbkIsTUFBTSxDQUFDLEtBQU0sQ0FBQyxJQUFJLENBQUMsR0FBRztvQkFDbEIsSUFBSTtvQkFDSixTQUFTLEVBQUU7d0JBQ1AsSUFBSSxFQUFFLE1BQU07d0JBQ1osTUFBTSxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQ2IsSUFBSSxDQUFBLEVBQUUsQ0FBQSxDQUFDOzRCQUNILElBQUksRUFBRSxRQUFROzRCQUNkLEtBQUssRUFBRSxJQUFJO3lCQUNkLENBQUMsQ0FDTDtxQkFFSjtvQkFDRCxrQkFBa0IsRUFBRSxNQUFNO2lCQUNyQixDQUFDO2FBRWI7aUJBQ0k7Z0JBQ0Qsb0JBQW9CO2dC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QUU7WUFDNUUsSUFBSSx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLGtCQUFrQixFQUFFO2dCQUM1RCxPQUFPLEVBQUUsU0FBUyxFQUFFLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUUsQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFLHVCQUF1QixFQUFFLElBQUksRUFBRSxDQUFDO2FBQ3BHO1NBQ0o7S0FDSjtJQUNELE9BQU8sRUFBRSxTQUFTLEVBQUUsSUFBSSxDQUFDLEtBQU0sRUFBRSx1QkFBdUIsRUFBRSxLQUFLLEVBQUUsQ0FBQztBQUN0RSxDQUFDO0FBNUNELHNEQTRDQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBDb3B5cmlnaHQgMjAxOSBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICogTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS5cbiAqIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIG9yIGluIHRoZSBcImxpY2Vuc2VcIiBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZFxuICogb24gYW4gXCJBUyBJU1wiIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyXG4gKiBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZ1xuICogcGVybWlzc2lvbnMgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEludGVudCwgU2xvdCB9IGZyb20gXCJhc2stc2RrLW1vZGVsXCI7XG5cbmV4cG9ydCBjbGFzcyBJbnRlbnRCdWlsZGVyIHtcbiAgICBzdGF0aWMgb2YobmFtZTogc3RyaW5nLCBzbG90VmFsdWVzPzogeyBbazogc3RyaW5nXTogYW55IH0pOiBJbnRlbnQge1xuICAgICAgICBjb25zdCBpbnRlbnQ6IEludGVudCA9IHtcbiAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICBjb25maXJtYXRpb25TdGF0dXM6ICdOT05FJyxcbiAgICAgICAgICAgIHNsb3RzOiB7fVxuICAgICAgICB9O1xuXG4gICAgICAgIGZvciAoY29uc3QgcHJvcCBvZiBPYmplY3QuZW50cmllcyhzbG90VmFsdWVzID8/IHt9KSkge1xuICAgICAgICAgICAgY29uc3QgbmFtZSA9IHByb3BbMF07XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHByb3BbMV07XG5cbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSl7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gMCl7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignU2xvdCBvZiBlbXB0eS1hcnJheSBpcyBub3Qgc3VwcG9ydGVkJyk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy8gTXVsdGktdmFsdWUgc2xvdFxuICAgICAgICAgICAgICAgIGludGVudC5zbG90cyFbbmFtZV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIG5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHNsb3RWYWx1ZToge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ0xpc3QnLFxuICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzOiB2YWx1ZS5tYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbT0+KHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1NpbXBsZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBpdGVtXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIClcblxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBjb25maXJtYXRpb25TdGF0dXM6ICdOT05FJ1xuICAgICAgICAgICAgICAgIH0gYXMgU2xvdDtcblxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgLy8gU2luZ2xlLXZhbHVlIHNsb3RcbiAgICAgICAgICAgICAgICBpbnRlbnQuc2xvdHMhW25hbWVdID0ge1xuICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUgIT09IHVuZGVmaW5lZCA/IHZhbHVlIDogJycsXG4gICAgICAgICAgICAgICAgICAgIGNvbmZpcm1hdGlvblN0YXR1czogJ05PTkUnXG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGludGVudDtcbiAgICB9XG59XG5leHBvcnQgaW50ZXJmYWNlIFNsb3RSZXNvbHV0aW9uVmFsdWUge1xuICAgIHNsb3RWYWx1ZTogc3RyaW5nLFxuICAgIGlzRW50aXR5UmVzb2x1dGlvbk1hdGNoOiBib29sZWFuXG59XG5cbi8vIFRPRE86cmV0aXJlIHRoaXMgY2xhc3Mgb25jZSBTaW1wbGlmaWVkTVZTSW50ZW50IGlzIGNvdmVyaW5nIGFsbCBjYXNlcyBzdWNjZXNzZnVsbHkuXG5leHBvcnQgY2xhc3MgU2ltcGxpZmllZEludGVudCB7XG4gICAgcHVibGljIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcbiAgICBwdWJsaWMgcmVhZG9ubHkgc2xvdFJlc29sdXRpb25zOiB7IFtrOiBzdHJpbmddOiBTbG90UmVzb2x1dGlvblZhbHVlIHwgdW5kZWZpbmVkIH07XG4gICAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nLCBzbG90UmVzb2x1dGlvbnM6IHsgW2s6IHN0cmluZ106IFNsb3RSZXNvbHV0aW9uVmFsdWUgfCB1bmRlZmluZWQgfSkge1xuICAgICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgICB0aGlzLnNsb3RSZXNvbHV0aW9ucyA9IHNsb3RSZXNvbHV0aW9ucztcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGZyb21JbnRlbnQoaW50ZW50OiBJbnRlbnQpOiBTaW1wbGlmaWVkSW50ZW50IHtcbiAgICAgICAgY29uc3Qgc2xvdFJlc29sdXRpb25zOiB7IFtrOiBzdHJpbmddOiBTbG90UmVzb2x1dGlvblZhbHVlIHwgdW5kZWZpbmVkIH0gPSB7fTtcblxuICAgICAgICBpZiAoaW50ZW50LnNsb3RzKSB7XG4gICAgICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCBzbG90XSBvZiBPYmplY3QuZW50cmllcyhpbnRlbnQuc2xvdHMpKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc2xvdE9iamVjdCA9IGdldFNsb3RSZXNvbHV0aW9ucyhzbG90KTtcbiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShzbG90T2JqZWN0KSl7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlNsb3QgaXMgbXVsdGktdmFsdWVkLiAgVXNlIFNpbXBsaWZpZWRNVlNJbnRlbnRcIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBzbG90UmVzb2x1dGlvbnNbbmFtZV0gPSBzbG90T2JqZWN0ICE9PSB1bmRlZmluZWQgPyBzbG90T2JqZWN0IDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgU2ltcGxpZmllZEludGVudChpbnRlbnQubmFtZSwgc2xvdFJlc29sdXRpb25zKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdG9TdHJpbmcoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMpO1xuICAgIH1cbn1cblxuLy8gVE9ETzpyZXRpcmUgdGhpcyBmdW5jIG9uY2UgU2ltcGxpZmllZE1WU0ludGVudCBpcyBjb3ZlcmluZyBhbGwgY2FzZXMgc3VjY2Vzc2Z1bGx5LlxuLyoqXG4gKiBJZiB0aGVyZSBpcyBhbiBFUi1TdWNjZXNzLCB0aGlzIHJldHVybnMgdGhlIGNhbm9uaWNhbCB2YWx1ZSBpZCBvZiB0aGUgZmlyc3QgbWF0Y2ggcmVzb2x1dGlvbiBhbG9uZyB3aXRoXG4gKiBpc0VudGl0eVJlc29sdXRpb25NYXRjaDogYm9vbGVhbiB0byBpbmRpY2F0ZSB0aGUgc3RhdHVzIG9mIEVSX1NVQ0NFU1NfTUFUQ0hcbiAqIE90aGVyd2lzZSB0aGlzIHJldHVybnMgdGhlIG9iamVjdCBvZiBsaXRlcmFsIHNsb3QgdmFsdWUgYW5kIGlzRW50aXR5UmVzb2x1dGlvbk1hdGNoIHNldCB0byBmYWxzZS5cbiAqXG4gKiBAcGFyYW0gc2xvdFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0U2xvdFJlc29sdXRpb25zKHNsb3Q6IFNsb3QgfCB1bmRlZmluZWQpOiBTbG90UmVzb2x1dGlvblZhbHVlIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoc2xvdCA9PT0gdW5kZWZpbmVkIHx8IHNsb3QudmFsdWUgPT09IHVuZGVmaW5lZCB8fCBzbG90LnZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgICAvLyByZWd1bGFyIHNpbmdsZS12YWx1ZSBoYW5kbGluZ1xuICAgIGlmIChzbG90LnJlc29sdXRpb25zICYmIHNsb3QucmVzb2x1dGlvbnMucmVzb2x1dGlvbnNQZXJBdXRob3JpdHkgJiYgc2xvdC5yZXNvbHV0aW9ucy5yZXNvbHV0aW9uc1BlckF1dGhvcml0eS5sZW5ndGggPiAwKSB7XG4gICAgICAgIGZvciAoY29uc3QgcmVzb2x1dGlvbnNQZXJBdXRob3JpdHkgb2Ygc2xvdC5yZXNvbHV0aW9ucy5yZXNvbHV0aW9uc1BlckF1dGhvcml0eSkge1xuICAgICAgICAgICAgaWYgKHJlc29sdXRpb25zUGVyQXV0aG9yaXR5LnN0YXR1cy5jb2RlID09PSAnRVJfU1VDQ0VTU19NQVRDSCcpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyBzbG90VmFsdWU6IHJlc29sdXRpb25zUGVyQXV0aG9yaXR5LnZhbHVlc1swXSEudmFsdWUuaWQsIGlzRW50aXR5UmVzb2x1dGlvbk1hdGNoOiB0cnVlIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHsgc2xvdFZhbHVlOiBzbG90LnZhbHVlISwgaXNFbnRpdHlSZXNvbHV0aW9uTWF0Y2g6IGZhbHNlIH07XG59XG5cblxuXG4vLyAtLS0tIE1WUyBzdXBwb3J0IC0tLS1cblxuZXhwb3J0IGNsYXNzIFNpbXBsaWZpZWRNVlNJbnRlbnQge1xuICAgIHB1YmxpYyByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gICAgcHVibGljIHJlYWRvbmx5IHNsb3RSZXNvbHV0aW9uczogeyBbazogc3RyaW5nXTogU2xvdFJlc29sdXRpb25WYWx1ZSB8IFNsb3RSZXNvbHV0aW9uVmFsdWVbXSB8IHVuZGVmaW5lZCB9O1xuICAgIGNvbnN0cnVjdG9yKG5hbWU6IHN0cmluZywgc2xvdFJlc29sdXRpb25zOiB7IFtrOiBzdHJpbmddOiBTbG90UmVzb2x1dGlvblZhbHVlIHwgU2xvdFJlc29sdXRpb25WYWx1ZVtdIHwgdW5kZWZpbmVkIH0pIHtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy5zbG90UmVzb2x1dGlvbnMgPSBzbG90UmVzb2x1dGlvbnM7XG4gICAgfVxuXG4gICAgcHVibGljIHN0YXRpYyBmcm9tSW50ZW50KGludGVudDogSW50ZW50KTogU2ltcGxpZmllZE1WU0ludGVudCB7XG4gICAgICAgIGNvbnN0IHNsb3RSZXNvbHV0aW9uczogeyBbazogc3RyaW5nXTogU2xvdFJlc29sdXRpb25WYWx1ZSB8IFNsb3RSZXNvbHV0aW9uVmFsdWVbXSB8IHVuZGVmaW5lZCB9ID0ge307XG5cbiAgICAgICAgaWYgKGludGVudC5zbG90cykge1xuICAgICAgICAgICAgZm9yIChjb25zdCBbbmFtZSwgc2xvdF0gb2YgT2JqZWN0LmVudHJpZXMoaW50ZW50LnNsb3RzKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNsb3RPYmplY3QgPSBnZXRNVlNTbG90UmVzb2x1dGlvbnMoc2xvdCk7XG4gICAgICAgICAgICAgICAgc2xvdFJlc29sdXRpb25zW25hbWVdID0gc2xvdE9iamVjdCAhPT0gdW5kZWZpbmVkID8gc2xvdE9iamVjdCA6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IFNpbXBsaWZpZWRNVlNJbnRlbnQoaW50ZW50Lm5hbWUsIHNsb3RSZXNvbHV0aW9ucyk7XG4gICAgfVxuXG4gICAgcHVibGljIHRvU3RyaW5nKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzKTtcbiAgICB9XG59XG5cblxuLyoqXG4gKiBJZiB0aGVyZSBpcyBhbiBFUi1TdWNjZXNzLCB0aGlzIHJldHVybnMgdGhlIGNhbm9uaWNhbCB2YWx1ZSBpZCBvZiB0aGUgZmlyc3QgbWF0Y2ggcmVzb2x1dGlvbiBhbG9uZyB3aXRoXG4gKiBpc0VudGl0eVJlc29sdXRpb25NYXRjaDogYm9vbGVhbiB0byBpbmRpY2F0ZSB0aGUgc3RhdHVzIG9mIEVSX1NVQ0NFU1NfTUFUQ0hcbiAqIE90aGVyd2lzZSB0aGlzIHJldHVybnMgdGhlIG9iamVjdCBvZiBsaXRlcmFsIHNsb3QgdmFsdWUgYW5kIGlzRW50aXR5UmVzb2x1dGlvbk1hdGNoIHNldCB0byBmYWxzZS5cbiAqXG4gKiBAcGFyYW0gc2xvdFxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0TVZTU2xvdFJlc29sdXRpb25zKHNsb3Q6IFNsb3QgfCB1bmRlZmluZWQpOiBTbG90UmVzb2x1dGlvblZhbHVlIHwgU2xvdFJlc29sdXRpb25WYWx1ZVtdIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoc2xvdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAge1xuICAgICAgICAvLyBoYW5kbGluZyBmb3IgTVZTIHdoaWNoIGlzbid0IGluIGFzay1zZGsgeWV0LlxuICAgICAgICBjb25zdCBzbG90VmFsdWU6IGFueSA9IChzbG90IGFzIGFueSkuc2xvdFZhbHVlO1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tZW1wdHlcbiAgICAgICAgaWYgKHNsb3RWYWx1ZSAhPT0gdW5kZWZpbmVkICYmIHNsb3RWYWx1ZS50eXBlID09PSAnTGlzdCcgJiYgc2xvdFZhbHVlLnZhbHVlcy5sZW5ndGggPiAwKXtcbiAgICAgICAgICAgIGNvbnN0IHNsb3RWYWx1ZXNBc1Nsb3RzID0gc2xvdFZhbHVlLnZhbHVlcyBhcyBTbG90W107XG4gICAgICAgICAgICBjb25zdCB2YWx1ZXMgPSBzbG90VmFsdWVzQXNTbG90cy5tYXAoc2xvdCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHNsb3QucmVzb2x1dGlvbnMgJiYgc2xvdC5yZXNvbHV0aW9ucy5yZXNvbHV0aW9uc1BlckF1dGhvcml0eSAmJiBzbG90LnJlc29sdXRpb25zLnJlc29sdXRpb25zUGVyQXV0aG9yaXR5Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCByZXNvbHV0aW9uc1BlckF1dGhvcml0eSBvZiBzbG90LnJlc29sdXRpb25zLnJlc29sdXRpb25zUGVyQXV0aG9yaXR5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzb2x1dGlvbnNQZXJBdXRob3JpdHkuc3RhdHVzLmNvZGUgPT09ICdFUl9TVUNDRVNTX01BVENIJykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7IHNsb3RWYWx1ZTogcmVzb2x1dGlvbnNQZXJBdXRob3JpdHkudmFsdWVzWzBdIS52YWx1ZS5pZCwgaXNFbnRpdHlSZXNvbHV0aW9uTWF0Y2g6IHRydWUgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7IHNsb3RWYWx1ZTogc2xvdC52YWx1ZSA/PyBcIlwiLCBpc0VudGl0eVJlc29sdXRpb25NYXRjaDogZmFsc2UgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBzbG90VmFsdWU6IHNsb3QudmFsdWUgPz8gXCJcIiwgaXNFbnRpdHlSZXNvbHV0aW9uTWF0Y2g6IGZhbHNlIH07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4geyBzbG90VmFsdWU6IHNsb3QudmFsdWUgPz8gXCJcIiwgaXNFbnRpdHlSZXNvbHV0aW9uTWF0Y2g6IGZhbHNlIH07XG4gICAgICAgICAgICAgICAgfX0pO1xuXG4gICAgICAgICAgICByZXR1cm4gdmFsdWVzO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHNsb3QudmFsdWUgPT09IHVuZGVmaW5lZCB8fCBzbG90LnZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8vIHJlZ3VsYXIgc2luZ2xlLXZhbHVlIGhhbmRsaW5nXG4gICAgaWYgKHNsb3QucmVzb2x1dGlvbnMgJiYgc2xvdC5yZXNvbHV0aW9ucy5yZXNvbHV0aW9uc1BlckF1dGhvcml0eSAmJiBzbG90LnJlc29sdXRpb25zLnJlc29sdXRpb25zUGVyQXV0aG9yaXR5Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgZm9yIChjb25zdCByZXNvbHV0aW9uc1BlckF1dGhvcml0eSBvZiBzbG90LnJlc29sdXRpb25zLnJlc29sdXRpb25zUGVyQXV0aG9yaXR5KSB7XG4gICAgICAgICAgICBpZiAocmVzb2x1dGlvbnNQZXJBdXRob3JpdHkuc3RhdHVzLmNvZGUgPT09ICdFUl9TVUNDRVNTX01BVENIJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB7IHNsb3RWYWx1ZTogcmVzb2x1dGlvbnNQZXJBdXRob3JpdHkudmFsdWVzWzBdIS52YWx1ZS5pZCwgaXNFbnRpdHlSZXNvbHV0aW9uTWF0Y2g6IHRydWUgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4geyBzbG90VmFsdWU6IHNsb3QudmFsdWUhLCBpc0VudGl0eVJlc29sdXRpb25NYXRjaDogZmFsc2UgfTtcbn1cblxuIl19