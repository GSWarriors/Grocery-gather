"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.generateModelData = exports.ControlInteractionModelGenerator = void 0;
const tslib_1 = require("tslib");
const lodash_1 = tslib_1.__importDefault(require("lodash"));
const i18next_1 = tslib_1.__importDefault(require("i18next"));
const GeneralControlIntent_1 = require("../intents/GeneralControlIntent");
const SingleValueControlIntent_1 = require("../intents/SingleValueControlIntent");
const ConjunctionControlIntent_1 = require("../intents/ConjunctionControlIntent");
const DateRangeControlIntent_1 = require("../intents/DateRangeControlIntent");
const OrdinalControlIntent_1 = require("../intents/OrdinalControlIntent");
const NumberControlIntent_1 = require("../intents/NumberControlIntent");
const DateControlIntent_1 = require("../intents/DateControlIntent");
const Logger_1 = require("../logging/Logger");
const InteractionModelGenerator_1 = require("./InteractionModelGenerator");
const ModelTypes_1 = require("./ModelTypes");
const log = new Logger_1.Logger('AskSdkControls:ControlInteractionModelGenerator');
const dummyPrompts = [
    {
        id: "Slot.Validation.564246223579.1467418044248.678461230495",
        variations: [
            {
                type: "PlainText",
                value: "This prompt is a dummy included only to ensure there is a dialog model present."
            }
        ]
    }
];
class ControlInteractionModelGenerator extends InteractionModelGenerator_1.InteractionModelGenerator {
    constructor() {
        super(...arguments);
        this.targetSlotIds = new Set();
    }
    /**
     * Update the interaction model for a controlManager
     * It calls the controlManager.buildInteractionModel function to update IM
     * And add dummy dialogModel if SimpleControlIntent is used in control
     *
     * Usage:
     * If the ControlManager is lacking data for the chosen locale, the appropriate data should be add by user themselves
     * User would need to update the ModelDataMap instance and provide it to ControlManager's constructor
     * @param rootControl
     * @param locale The locale code, E.G. 'en-US', 'de-DE', 'ja-JP'. REF: https://developer.amazon.com/en-US/docs/alexa/custom-skills/develop-skills-in-multiple-languages.html#h2-code-changes
     */
    buildCoreModelForControls(controlManager) {
        controlManager.buildInteractionModel(this);
        ensureDialogModel(this, this.intents);
        return this;
    }
    build() {
        const interactionModelData = super.build();
        validateTargetSlots(interactionModelData, this.targetSlotIds);
        return interactionModelData;
    }
    /**
     * Add built-ins AMAZON.YesIntent and AMAZON.NoIntent intents to all built-in controls.
     */
    addYesAndNoIntents() {
        this.addIntent({ name: 'AMAZON.YesIntent' });
        this.addIntent({ name: 'AMAZON.NoIntent' });
        return this;
    }
    addControlIntent(controlIntent, controlIMData) {
        var _a;
        // used to record all present basic slotTypes
        const presentSlotTypesSet = new Set();
        const controlIntentUtterances = generateCompleteIntent(controlIntent, controlIMData);
        this.addIntents(controlIntentUtterances);
        (_a = controlIntentUtterances.slots) === null || _a === void 0 ? void 0 : _a.map((slot) => {
            presentSlotTypesSet.add(slot.name);
        });
        // Loop all SharedSlotTypes
        // if it present in the set, add slotTypes to IM
        for (const slotTypeName of Object.values(ModelTypes_1.SharedSlotType)) {
            // The slotType get from ControlIntent is just a skeleton without values
            // The complete definition should be found in controlIMData
            if (presentSlotTypesSet.has(slotTypeName)) {
                const slotTypes = controlIMData.slotTypes.find((slotType) => slotType.name === slotTypeName);
                if (!slotTypes) {
                    throw new Error(`SlotType ${slotTypeName} doesn't have values registered in the ModelData.`);
                }
                this.addOrMergeSlotTypes(slotTypes);
            }
        }
        return this;
    }
}
exports.ControlInteractionModelGenerator = ControlInteractionModelGenerator;
// Convert Intent to DialogIntent
function buildDialogIntent(intent) {
    const dialogIntent = lodash_1.default.cloneDeep(intent);
    delete dialogIntent.samples;
    dialogIntent.delegationStrategy = 'SKILL_RESPONSE';
    return dialogIntent;
}
/**
 * Generate complete intent with intent samples attached
 * @param controlIntent
 * @param controlIMData
 */
function generateCompleteIntent(controlIntent, controlIMData) {
    var _a;
    // Special logic for SingleValueControlIntent
    if (controlIntent.name.includes('ValueControlIntent')) {
        return handleValueControlIntent(controlIntent, controlIMData);
    }
    const intent = controlIntent.generateIntent();
    const samples = (_a = controlIMData.intentValues.find((intentValue) => intentValue.name === controlIntent.name)) === null || _a === void 0 ? void 0 : _a.samples;
    if (samples === undefined) {
        throw new Error(`${controlIntent.name} doesn't have samples registered in the ModelData.`);
    }
    intent.samples = samples;
    return intent;
}
function handleValueControlIntent(controlIntent, controlIMData) {
    var _a;
    const intent = controlIntent.generateIntent();
    const samples = (_a = controlIMData.intentValues.find((intentValue) => intentValue.name === SingleValueControlIntent_1.SingleValueControlIntent.name)) === null || _a === void 0 ? void 0 : _a.samples;
    if (samples === undefined) {
        throw new Error('Can not find SingleValueControlIntent samples in ModelData');
    }
    const slotType = controlIntent.valueSlotType;
    const replacement = `{${slotType}}`;
    intent.samples = intent.samples || [];
    samples.map((sample) => {
        intent.samples.push(sample.replace('[[valueSlotType]]', replacement));
    });
    return intent;
}
// This method adds a dummy dialogModel so that Dialog directives such as Dialog.ElicitSlotDirective can be used.
// 1. Add dummy validation rule to SimpleControlIntent' target slot
// 2. Add dummy prompt
function ensureDialogModel(generator, intents) {
    var _a;
    // Since one dummy validation is enough to meet slotElicitation requirement
    // And all the builtin controls integrate with the SimpleControlIntent
    // Thus add this dummy validation to the first target type slotType
    const simpleControlIntent = intents.find((intent) => intent.name === GeneralControlIntent_1.GeneralControlIntent.name);
    if (!simpleControlIntent) {
        return;
    }
    const dialogSimpleControlIntent = buildDialogIntent(simpleControlIntent);
    generator.addDialogIntents(dialogSimpleControlIntent);
    const targetSlot = (_a = dialogSimpleControlIntent.slots) === null || _a === void 0 ? void 0 : _a.find((slot) => slot.type === 'target');
    if (targetSlot === undefined) {
        throw new Error('target slot is not present in SimpleControlIntent');
    }
    addDummyValidationRule(targetSlot);
    generator.addPrompts(...dummyPrompts);
}
/**
 *  Add dummy dialog validation rule to the input slot
 * @param targetSlot
 */
function addDummyValidationRule(targetSlot) {
    targetSlot.elicitationRequired = false;
    targetSlot.confirmationRequired = false;
    // The particular dummy model comprises a single slot-validation that will always pass.
    targetSlot.validations = [{
            type: "isNotInSet",
            prompt: "Slot.Validation.564246223579.1467418044248.678461230495",
            values: [
                "This prompt is a dummy included only to ensure there is a dialog model present."
            ]
        }];
}
/**
 * Validate the target slotIds in Controls are present in InteractionModel
 * @param interactionModel
 * @param targetSlotIDs
 */
function validateTargetSlots(interactionModel, targetSlotIds) {
    var _a, _b;
    const presentSlotTypes = (_b = (_a = interactionModel.interactionModel) === null || _a === void 0 ? void 0 : _a.languageModel) === null || _b === void 0 ? void 0 : _b.types;
    for (const targetSlotId of targetSlotIds) {
        if (presentSlotTypes === undefined) {
            log.warn(`target slot with id ${targetSlotId} is not present in InteractionModel.`);
            continue;
        }
        const match = presentSlotTypes.find((slotType) => { var _a; return (_a = slotType.values) === null || _a === void 0 ? void 0 : _a.find((value) => value.id === targetSlotId); });
        if (match === undefined) {
            log.warn(`target slot with id ${targetSlotId} is not present in InteractionModel.`);
        }
    }
}
/**
 * Generate the modelData Object by reading the i18n instance
 */
function generateModelData() {
    const slotTypes = [];
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_FEEDBACK', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_HEAD', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_TAIL', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_CONJUNCTION', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_PREPOSITION', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_ACTION', { returnObjects: true }));
    slotTypes.push(i18next_1.default.t('SHARED_SLOT_TYPES_TARGET', { returnObjects: true }));
    const intentValues = [];
    intentValues.push({
        name: ConjunctionControlIntent_1.ConjunctionControlIntent.name,
        samples: i18next_1.default.t('CONJUNCTION_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    intentValues.push({
        name: DateControlIntent_1.DateControlIntent.name,
        samples: i18next_1.default.t('DATE_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    intentValues.push({
        name: DateRangeControlIntent_1.DateRangeControlIntent.name,
        samples: i18next_1.default.t('DATE_RANGE_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    intentValues.push({
        name: GeneralControlIntent_1.GeneralControlIntent.name,
        samples: i18next_1.default.t('GENERAL_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    intentValues.push({
        name: NumberControlIntent_1.NumberControlIntent.name,
        samples: i18next_1.default.t('NUMBER_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    intentValues.push({
        name: OrdinalControlIntent_1.OrdinalControlIntent.name,
        samples: i18next_1.default.t('ORDINAL_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    intentValues.push({
        name: SingleValueControlIntent_1.SingleValueControlIntent.name,
        samples: i18next_1.default.t('SINGLE_VALUE_CONTROL_INTENT_SAMPLES', { returnObjects: true })
    });
    return {
        slotTypes,
        intentValues
    };
}
exports.generateModelData = generateModelData;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvaW50ZXJhY3Rpb25Nb2RlbEdlbmVyYXRpb24vQ29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQWFBLDREQUF1QjtBQUN2Qiw4REFBOEI7QUFHOUIsMEVBQXVFO0FBQ3ZFLGtGQUErRTtBQUMvRSxrRkFBK0U7QUFDL0UsOEVBQTJFO0FBQzNFLDBFQUF1RTtBQUN2RSx3RUFBcUU7QUFDckUsb0VBQWlFO0FBQ2pFLDhDQUEyQztBQUMzQywyRUFBd0U7QUFDeEUsNkNBQTJFO0FBUTNFLE1BQU0sR0FBRyxHQUFHLElBQUksZUFBTSxDQUFDLGlEQUFpRCxDQUFDLENBQUM7QUFFMUUsTUFBTSxZQUFZLEdBQWE7SUFDM0I7UUFDSSxFQUFFLEVBQUUseURBQXlEO1FBQzdELFVBQVUsRUFBRTtZQUNSO2dCQUNJLElBQUksRUFBRSxXQUFXO2dCQUNqQixLQUFLLEVBQUUsaUZBQWlGO2FBQzNGO1NBQ0o7S0FDSjtDQUNKLENBQUM7QUFFRixNQUFhLGdDQUFpQyxTQUFRLHFEQUF5QjtJQUEvRTs7UUFDVyxrQkFBYSxHQUFnQixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBNkRsRCxDQUFDO0lBNURHOzs7Ozs7Ozs7O09BVUc7SUFDSCx5QkFBeUIsQ0FBQyxjQUE4QjtRQUVwRCxjQUFjLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0MsaUJBQWlCLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0QyxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsS0FBSztRQUNELE1BQU0sb0JBQW9CLEdBQXlCLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNqRSxtQkFBbUIsQ0FBQyxvQkFBb0IsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFOUQsT0FBTyxvQkFBb0IsQ0FBQztJQUNoQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxrQkFBa0I7UUFDZCxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLGtCQUFrQixFQUFFLENBQUMsQ0FBQztRQUM3QyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsSUFBSSxFQUFFLGlCQUFpQixFQUFFLENBQUMsQ0FBQztRQUM1QyxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsZ0JBQWdCLENBQUMsYUFBZ0MsRUFBRSxhQUF3Qjs7UUFDdkUsNkNBQTZDO1FBQzdDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQztRQUU5QyxNQUFNLHVCQUF1QixHQUFHLHNCQUFzQixDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUNyRixJQUFJLENBQUMsVUFBVSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFFekMsTUFBQSx1QkFBdUIsQ0FBQyxLQUFLLDBDQUFFLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ3hDLG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSyxDQUFDLENBQUM7UUFDeEMsQ0FBQyxFQUFFO1FBRUgsMkJBQTJCO1FBQzNCLGdEQUFnRDtRQUNoRCxLQUFLLE1BQU0sWUFBWSxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsMkJBQWMsQ0FBQyxFQUFFO1lBQ3RELHdFQUF3RTtZQUN4RSwyREFBMkQ7WUFDM0QsSUFBSSxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLEVBQUU7Z0JBQ3ZDLE1BQU0sU0FBUyxHQUFHLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLFlBQVksQ0FBQyxDQUFDO2dCQUM3RixJQUFJLENBQUMsU0FBUyxFQUFFO29CQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMsWUFBWSxZQUFZLG1EQUFtRCxDQUFDLENBQUM7aUJBQ2hHO2dCQUNELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUN2QztTQUNKO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKO0FBOURELDRFQThEQztBQUVELGlDQUFpQztBQUNqQyxTQUFTLGlCQUFpQixDQUFDLE1BQWM7SUFDckMsTUFBTSxZQUFZLEdBQUcsZ0JBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDekMsT0FBTyxZQUFZLENBQUMsT0FBTyxDQUFDO0lBQzNCLFlBQTZCLENBQUMsa0JBQWtCLEdBQUcsZ0JBQWdCLENBQUM7SUFFckUsT0FBTyxZQUFZLENBQUM7QUFDeEIsQ0FBQztBQUVEOzs7O0dBSUc7QUFDSCxTQUFTLHNCQUFzQixDQUFDLGFBQWdDLEVBQUUsYUFBd0I7O0lBRXRGLDZDQUE2QztJQUM3QyxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLG9CQUFvQixDQUFDLEVBQUU7UUFDbkQsT0FBTyx3QkFBd0IsQ0FBQyxhQUF5QyxFQUFFLGFBQWEsQ0FBQyxDQUFDO0tBQzdGO0lBRUQsTUFBTSxNQUFNLEdBQVcsYUFBYSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3RELE1BQU0sT0FBTyxTQUF5QixhQUFhLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDLFdBQVcsRUFBRSxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxhQUFhLENBQUMsSUFBSSxDQUFDLDBDQUFFLE9BQU8sQ0FBQztJQUV6SSxJQUFJLE9BQU8sS0FBSyxTQUFTLEVBQUU7UUFDdkIsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLGFBQWEsQ0FBQyxJQUFJLG9EQUFvRCxDQUFDLENBQUM7S0FDOUY7SUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztJQUV6QixPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBR0QsU0FBUyx3QkFBd0IsQ0FBQyxhQUF1QyxFQUFFLGFBQXdCOztJQUMvRixNQUFNLE1BQU0sR0FBVyxhQUFhLENBQUMsY0FBYyxFQUFFLENBQUM7SUFDdEQsTUFBTSxPQUFPLFNBQXlCLGFBQWEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxXQUFXLENBQUMsSUFBSSxLQUFLLG1EQUF3QixDQUFDLElBQUksQ0FBQywwQ0FBRSxPQUFPLENBQUM7SUFDcEosSUFBSSxPQUFPLEtBQUssU0FBUyxFQUFFO1FBQ3ZCLE1BQU0sSUFBSSxLQUFLLENBQUMsNERBQTRELENBQUMsQ0FBQztLQUNqRjtJQUNELE1BQU0sUUFBUSxHQUFXLGFBQWEsQ0FBQyxhQUFhLENBQUM7SUFDckQsTUFBTSxXQUFXLEdBQVcsSUFBSSxRQUFRLEdBQUcsQ0FBQztJQUM1QyxNQUFNLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQyxPQUFPLElBQUksRUFBRSxDQUFDO0lBQ3RDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRTtRQUNuQixNQUFNLENBQUMsT0FBUSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLG1CQUFtQixFQUFFLFdBQVcsQ0FBQyxDQUFDLENBQUM7SUFDM0UsQ0FBQyxDQUFDLENBQUM7SUFDSCxPQUFPLE1BQU0sQ0FBQztBQUNsQixDQUFDO0FBRUQsaUhBQWlIO0FBQ2pILG1FQUFtRTtBQUNuRSxzQkFBc0I7QUFDdEIsU0FBUyxpQkFBaUIsQ0FBQyxTQUEyQyxFQUFFLE9BQWlCOztJQUVyRiwyRUFBMkU7SUFDM0Usc0VBQXNFO0lBQ3RFLG1FQUFtRTtJQUNuRSxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEtBQUssMkNBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDaEcsSUFBSSxDQUFDLG1CQUFtQixFQUFFO1FBQ3RCLE9BQU87S0FDVjtJQUNELE1BQU0seUJBQXlCLEdBQUcsaUJBQWlCLENBQUMsbUJBQW1CLENBQUMsQ0FBQztJQUN6RSxTQUFTLENBQUMsZ0JBQWdCLENBQUMseUJBQXlCLENBQUMsQ0FBQztJQUV0RCxNQUFNLFVBQVUsU0FBRyx5QkFBeUIsQ0FBQyxLQUFLLDBDQUFFLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxRQUFRLENBQUMsQ0FBQztJQUMzRixJQUFJLFVBQVUsS0FBSyxTQUFTLEVBQUU7UUFDMUIsTUFBTSxJQUFJLEtBQUssQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO0tBQ3hFO0lBQ0Qsc0JBQXNCLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDbkMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLFlBQVksQ0FBQyxDQUFDO0FBQzFDLENBQUM7QUFFRDs7O0dBR0c7QUFDSCxTQUFTLHNCQUFzQixDQUFDLFVBQXFEO0lBQ2pGLFVBQVUsQ0FBQyxtQkFBbUIsR0FBRyxLQUFLLENBQUM7SUFDdkMsVUFBVSxDQUFDLG9CQUFvQixHQUFHLEtBQUssQ0FBQztJQUN4Qyx1RkFBdUY7SUFDdkYsVUFBVSxDQUFDLFdBQVcsR0FBRyxDQUFDO1lBQ3RCLElBQUksRUFBRSxZQUFZO1lBQ2xCLE1BQU0sRUFBRSx5REFBeUQ7WUFDakUsTUFBTSxFQUFFO2dCQUNKLGlGQUFpRjthQUNwRjtTQUNKLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRDs7OztHQUlHO0FBQ0gsU0FBUyxtQkFBbUIsQ0FBQyxnQkFBc0MsRUFBRSxhQUEwQjs7SUFDM0YsTUFBTSxnQkFBZ0IsZUFBMkIsZ0JBQWdCLENBQUMsZ0JBQWdCLDBDQUFFLGFBQWEsMENBQUUsS0FBSyxDQUFDO0lBQ3pHLEtBQUssTUFBTSxZQUFZLElBQUksYUFBYSxFQUFFO1FBQ3RDLElBQUksZ0JBQWdCLEtBQUssU0FBUyxFQUFFO1lBQ2hDLEdBQUcsQ0FBQyxJQUFJLENBQUMsdUJBQXVCLFlBQVksc0NBQXNDLENBQUMsQ0FBQztZQUNwRixTQUFTO1NBQ1o7UUFFRCxNQUFNLEtBQUssR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSx3QkFBQyxRQUFRLENBQUMsTUFBTSwwQ0FBRSxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssWUFBWSxJQUFDLENBQUMsQ0FBQztRQUUvRyxJQUFJLEtBQUssS0FBSyxTQUFTLEVBQUU7WUFDckIsR0FBRyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsWUFBWSxzQ0FBc0MsQ0FBQyxDQUFDO1NBQ3ZGO0tBQ0o7QUFDTCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFnQixpQkFBaUI7SUFDN0IsTUFBTSxTQUFTLEdBQWUsRUFBRSxDQUFDO0lBQ2pDLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQU8sQ0FBQyxDQUFDLENBQUMsNEJBQTRCLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2pGLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQU8sQ0FBQyxDQUFDLENBQUMsd0JBQXdCLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzdFLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQU8sQ0FBQyxDQUFDLENBQUMsd0JBQXdCLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQzdFLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQU8sQ0FBQyxDQUFDLENBQUMsK0JBQStCLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQU8sQ0FBQyxDQUFDLENBQUMsK0JBQStCLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ3BGLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQU8sQ0FBQyxDQUFDLENBQUMsMEJBQTBCLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQy9FLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQU8sQ0FBQyxDQUFDLENBQUMsMEJBQTBCLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBRS9FLE1BQU0sWUFBWSxHQUF1QixFQUFFLENBQUM7SUFDNUMsWUFBWSxDQUFDLElBQUksQ0FBQztRQUNkLElBQUksRUFBRSxtREFBd0IsQ0FBQyxJQUFJO1FBQ25DLE9BQU8sRUFBRSxpQkFBTyxDQUFDLENBQUMsQ0FBQyxvQ0FBb0MsRUFBRSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsQ0FBQztLQUNwRixDQUFDLENBQUM7SUFDSCxZQUFZLENBQUMsSUFBSSxDQUFDO1FBQ2QsSUFBSSxFQUFFLHFDQUFpQixDQUFDLElBQUk7UUFDNUIsT0FBTyxFQUFFLGlCQUFPLENBQUMsQ0FBQyxDQUFDLDZCQUE2QixFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDO0tBQzdFLENBQUMsQ0FBQztJQUNILFlBQVksQ0FBQyxJQUFJLENBQUM7UUFDZCxJQUFJLEVBQUUsK0NBQXNCLENBQUMsSUFBSTtRQUNqQyxPQUFPLEVBQUUsaUJBQU8sQ0FBQyxDQUFDLENBQUMsbUNBQW1DLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUM7S0FDbkYsQ0FBQyxDQUFDO0lBQ0gsWUFBWSxDQUFDLElBQUksQ0FBQztRQUNkLElBQUksRUFBRSwyQ0FBb0IsQ0FBQyxJQUFJO1FBQy9CLE9BQU8sRUFBRSxpQkFBTyxDQUFDLENBQUMsQ0FBQyxnQ0FBZ0MsRUFBRSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsQ0FBQztLQUNoRixDQUFDLENBQUM7SUFDSCxZQUFZLENBQUMsSUFBSSxDQUFDO1FBQ2QsSUFBSSxFQUFFLHlDQUFtQixDQUFDLElBQUk7UUFDOUIsT0FBTyxFQUFFLGlCQUFPLENBQUMsQ0FBQyxDQUFDLCtCQUErQixFQUFFLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDO0tBQy9FLENBQUMsQ0FBQztJQUNILFlBQVksQ0FBQyxJQUFJLENBQUM7UUFDZCxJQUFJLEVBQUUsMkNBQW9CLENBQUMsSUFBSTtRQUMvQixPQUFPLEVBQUUsaUJBQU8sQ0FBQyxDQUFDLENBQUMsZ0NBQWdDLEVBQUUsRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUM7S0FDaEYsQ0FBQyxDQUFDO0lBQ0gsWUFBWSxDQUFDLElBQUksQ0FBQztRQUNkLElBQUksRUFBRSxtREFBd0IsQ0FBQyxJQUFJO1FBQ25DLE9BQU8sRUFBRSxpQkFBTyxDQUFDLENBQUMsQ0FBQyxxQ0FBcUMsRUFBRSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUUsQ0FBQztLQUNyRixDQUFDLENBQUM7SUFFSCxPQUFPO1FBQ0gsU0FBUztRQUNULFlBQVk7S0FDZixDQUFDO0FBQ04sQ0FBQztBQTVDRCw4Q0E0Q0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTkgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuXG4gKiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBvciBpbiB0aGUgXCJsaWNlbnNlXCIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWRcbiAqIG9uIGFuIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlclxuICogZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmdcbiAqIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0IHsgdjEgfSBmcm9tICdhc2stc21hcGktbW9kZWwnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBpMThuZXh0IGZyb20gJ2kxOG5leHQnO1xuaW1wb3J0IHsgQ29udHJvbE1hbmFnZXIgfSBmcm9tICcuLi9jb250cm9scy9Db250cm9sTWFuYWdlcic7XG5pbXBvcnQgeyBCYXNlQ29udHJvbEludGVudCB9IGZyb20gJy4uL2ludGVudHMvQmFzZUNvbnRyb2xJbnRlbnQnO1xuaW1wb3J0IHsgR2VuZXJhbENvbnRyb2xJbnRlbnQgfSBmcm9tICcuLi9pbnRlbnRzL0dlbmVyYWxDb250cm9sSW50ZW50JztcbmltcG9ydCB7IFNpbmdsZVZhbHVlQ29udHJvbEludGVudCB9IGZyb20gJy4uL2ludGVudHMvU2luZ2xlVmFsdWVDb250cm9sSW50ZW50JztcbmltcG9ydCB7IENvbmp1bmN0aW9uQ29udHJvbEludGVudCB9IGZyb20gJy4uL2ludGVudHMvQ29uanVuY3Rpb25Db250cm9sSW50ZW50JztcbmltcG9ydCB7IERhdGVSYW5nZUNvbnRyb2xJbnRlbnQgfSBmcm9tICcuLi9pbnRlbnRzL0RhdGVSYW5nZUNvbnRyb2xJbnRlbnQnO1xuaW1wb3J0IHsgT3JkaW5hbENvbnRyb2xJbnRlbnQgfSBmcm9tICcuLi9pbnRlbnRzL09yZGluYWxDb250cm9sSW50ZW50JztcbmltcG9ydCB7IE51bWJlckNvbnRyb2xJbnRlbnQgfSBmcm9tICcuLi9pbnRlbnRzL051bWJlckNvbnRyb2xJbnRlbnQnO1xuaW1wb3J0IHsgRGF0ZUNvbnRyb2xJbnRlbnQgfSBmcm9tICcuLi9pbnRlbnRzL0RhdGVDb250cm9sSW50ZW50JztcbmltcG9ydCB7IExvZ2dlciB9IGZyb20gJy4uL2xvZ2dpbmcvTG9nZ2VyJztcbmltcG9ydCB7IEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3IgfSBmcm9tICcuL0ludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3InO1xuaW1wb3J0IHsgTW9kZWxEYXRhLCBTaGFyZWRTbG90VHlwZSwgSW50ZW50VXR0ZXJhbmNlcyB9IGZyb20gJy4vTW9kZWxUeXBlcyc7XG5cbmltcG9ydCBJbnRlbnQgPSB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLkludGVudDtcbmltcG9ydCBEaWFsb2dJbnRlbnQgPSB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLkRpYWxvZ0ludGVudHM7XG5pbXBvcnQgUHJvbXB0ID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5Qcm9tcHQ7XG5pbXBvcnQgSW50ZXJhY3Rpb25Nb2RlbERhdGEgPSB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLkludGVyYWN0aW9uTW9kZWxEYXRhO1xuaW1wb3J0IFNsb3RUeXBlID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5TbG90VHlwZTtcblxuY29uc3QgbG9nID0gbmV3IExvZ2dlcignQXNrU2RrQ29udHJvbHM6Q29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3InKTtcblxuY29uc3QgZHVtbXlQcm9tcHRzOiBQcm9tcHRbXSA9IFtcbiAgICB7XG4gICAgICAgIGlkOiBcIlNsb3QuVmFsaWRhdGlvbi41NjQyNDYyMjM1NzkuMTQ2NzQxODA0NDI0OC42Nzg0NjEyMzA0OTVcIixcbiAgICAgICAgdmFyaWF0aW9uczogW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIHR5cGU6IFwiUGxhaW5UZXh0XCIsXG4gICAgICAgICAgICAgICAgdmFsdWU6IFwiVGhpcyBwcm9tcHQgaXMgYSBkdW1teSBpbmNsdWRlZCBvbmx5IHRvIGVuc3VyZSB0aGVyZSBpcyBhIGRpYWxvZyBtb2RlbCBwcmVzZW50LlwiXG4gICAgICAgICAgICB9XG4gICAgICAgIF1cbiAgICB9XG5dO1xuXG5leHBvcnQgY2xhc3MgQ29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3IgZXh0ZW5kcyBJbnRlcmFjdGlvbk1vZGVsR2VuZXJhdG9yIHtcbiAgICBwdWJsaWMgdGFyZ2V0U2xvdElkczogU2V0PHN0cmluZz4gPSBuZXcgU2V0KCk7XG4gICAgLyoqXG4gICAgICogVXBkYXRlIHRoZSBpbnRlcmFjdGlvbiBtb2RlbCBmb3IgYSBjb250cm9sTWFuYWdlclxuICAgICAqIEl0IGNhbGxzIHRoZSBjb250cm9sTWFuYWdlci5idWlsZEludGVyYWN0aW9uTW9kZWwgZnVuY3Rpb24gdG8gdXBkYXRlIElNXG4gICAgICogQW5kIGFkZCBkdW1teSBkaWFsb2dNb2RlbCBpZiBTaW1wbGVDb250cm9sSW50ZW50IGlzIHVzZWQgaW4gY29udHJvbFxuICAgICAqXG4gICAgICogVXNhZ2U6XG4gICAgICogSWYgdGhlIENvbnRyb2xNYW5hZ2VyIGlzIGxhY2tpbmcgZGF0YSBmb3IgdGhlIGNob3NlbiBsb2NhbGUsIHRoZSBhcHByb3ByaWF0ZSBkYXRhIHNob3VsZCBiZSBhZGQgYnkgdXNlciB0aGVtc2VsdmVzXG4gICAgICogVXNlciB3b3VsZCBuZWVkIHRvIHVwZGF0ZSB0aGUgTW9kZWxEYXRhTWFwIGluc3RhbmNlIGFuZCBwcm92aWRlIGl0IHRvIENvbnRyb2xNYW5hZ2VyJ3MgY29uc3RydWN0b3JcbiAgICAgKiBAcGFyYW0gcm9vdENvbnRyb2xcbiAgICAgKiBAcGFyYW0gbG9jYWxlIFRoZSBsb2NhbGUgY29kZSwgRS5HLiAnZW4tVVMnLCAnZGUtREUnLCAnamEtSlAnLiBSRUY6IGh0dHBzOi8vZGV2ZWxvcGVyLmFtYXpvbi5jb20vZW4tVVMvZG9jcy9hbGV4YS9jdXN0b20tc2tpbGxzL2RldmVsb3Atc2tpbGxzLWluLW11bHRpcGxlLWxhbmd1YWdlcy5odG1sI2gyLWNvZGUtY2hhbmdlc1xuICAgICAqL1xuICAgIGJ1aWxkQ29yZU1vZGVsRm9yQ29udHJvbHMoY29udHJvbE1hbmFnZXI6IENvbnRyb2xNYW5hZ2VyKTogQ29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3Ige1xuXG4gICAgICAgIGNvbnRyb2xNYW5hZ2VyLmJ1aWxkSW50ZXJhY3Rpb25Nb2RlbCh0aGlzKTtcbiAgICAgICAgZW5zdXJlRGlhbG9nTW9kZWwodGhpcywgdGhpcy5pbnRlbnRzKTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYnVpbGQoKTogSW50ZXJhY3Rpb25Nb2RlbERhdGEge1xuICAgICAgICBjb25zdCBpbnRlcmFjdGlvbk1vZGVsRGF0YTogSW50ZXJhY3Rpb25Nb2RlbERhdGEgPSBzdXBlci5idWlsZCgpO1xuICAgICAgICB2YWxpZGF0ZVRhcmdldFNsb3RzKGludGVyYWN0aW9uTW9kZWxEYXRhLCB0aGlzLnRhcmdldFNsb3RJZHMpO1xuXG4gICAgICAgIHJldHVybiBpbnRlcmFjdGlvbk1vZGVsRGF0YTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGQgYnVpbHQtaW5zIEFNQVpPTi5ZZXNJbnRlbnQgYW5kIEFNQVpPTi5Ob0ludGVudCBpbnRlbnRzIHRvIGFsbCBidWlsdC1pbiBjb250cm9scy5cbiAgICAgKi9cbiAgICBhZGRZZXNBbmROb0ludGVudHMoKTogQ29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3Ige1xuICAgICAgICB0aGlzLmFkZEludGVudCh7IG5hbWU6ICdBTUFaT04uWWVzSW50ZW50JyB9KTtcbiAgICAgICAgdGhpcy5hZGRJbnRlbnQoeyBuYW1lOiAnQU1BWk9OLk5vSW50ZW50JyB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkQ29udHJvbEludGVudChjb250cm9sSW50ZW50OiBCYXNlQ29udHJvbEludGVudCwgY29udHJvbElNRGF0YTogTW9kZWxEYXRhKTogdGhpcyB7XG4gICAgICAgIC8vIHVzZWQgdG8gcmVjb3JkIGFsbCBwcmVzZW50IGJhc2ljIHNsb3RUeXBlc1xuICAgICAgICBjb25zdCBwcmVzZW50U2xvdFR5cGVzU2V0ID0gbmV3IFNldDxzdHJpbmc+KCk7XG5cbiAgICAgICAgY29uc3QgY29udHJvbEludGVudFV0dGVyYW5jZXMgPSBnZW5lcmF0ZUNvbXBsZXRlSW50ZW50KGNvbnRyb2xJbnRlbnQsIGNvbnRyb2xJTURhdGEpO1xuICAgICAgICB0aGlzLmFkZEludGVudHMoY29udHJvbEludGVudFV0dGVyYW5jZXMpO1xuXG4gICAgICAgIGNvbnRyb2xJbnRlbnRVdHRlcmFuY2VzLnNsb3RzPy5tYXAoKHNsb3QpID0+IHtcbiAgICAgICAgICAgIHByZXNlbnRTbG90VHlwZXNTZXQuYWRkKHNsb3QubmFtZSEpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBMb29wIGFsbCBTaGFyZWRTbG90VHlwZXNcbiAgICAgICAgLy8gaWYgaXQgcHJlc2VudCBpbiB0aGUgc2V0LCBhZGQgc2xvdFR5cGVzIHRvIElNXG4gICAgICAgIGZvciAoY29uc3Qgc2xvdFR5cGVOYW1lIG9mIE9iamVjdC52YWx1ZXMoU2hhcmVkU2xvdFR5cGUpKSB7XG4gICAgICAgICAgICAvLyBUaGUgc2xvdFR5cGUgZ2V0IGZyb20gQ29udHJvbEludGVudCBpcyBqdXN0IGEgc2tlbGV0b24gd2l0aG91dCB2YWx1ZXNcbiAgICAgICAgICAgIC8vIFRoZSBjb21wbGV0ZSBkZWZpbml0aW9uIHNob3VsZCBiZSBmb3VuZCBpbiBjb250cm9sSU1EYXRhXG4gICAgICAgICAgICBpZiAocHJlc2VudFNsb3RUeXBlc1NldC5oYXMoc2xvdFR5cGVOYW1lKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHNsb3RUeXBlcyA9IGNvbnRyb2xJTURhdGEuc2xvdFR5cGVzLmZpbmQoKHNsb3RUeXBlKSA9PiBzbG90VHlwZS5uYW1lID09PSBzbG90VHlwZU5hbWUpO1xuICAgICAgICAgICAgICAgIGlmICghc2xvdFR5cGVzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgU2xvdFR5cGUgJHtzbG90VHlwZU5hbWV9IGRvZXNuJ3QgaGF2ZSB2YWx1ZXMgcmVnaXN0ZXJlZCBpbiB0aGUgTW9kZWxEYXRhLmApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLmFkZE9yTWVyZ2VTbG90VHlwZXMoc2xvdFR5cGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG59XG5cbi8vIENvbnZlcnQgSW50ZW50IHRvIERpYWxvZ0ludGVudFxuZnVuY3Rpb24gYnVpbGREaWFsb2dJbnRlbnQoaW50ZW50OiBJbnRlbnQpOiBEaWFsb2dJbnRlbnQge1xuICAgIGNvbnN0IGRpYWxvZ0ludGVudCA9IF8uY2xvbmVEZWVwKGludGVudCk7XG4gICAgZGVsZXRlIGRpYWxvZ0ludGVudC5zYW1wbGVzO1xuICAgIChkaWFsb2dJbnRlbnQgYXMgRGlhbG9nSW50ZW50KS5kZWxlZ2F0aW9uU3RyYXRlZ3kgPSAnU0tJTExfUkVTUE9OU0UnO1xuXG4gICAgcmV0dXJuIGRpYWxvZ0ludGVudDtcbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSBjb21wbGV0ZSBpbnRlbnQgd2l0aCBpbnRlbnQgc2FtcGxlcyBhdHRhY2hlZFxuICogQHBhcmFtIGNvbnRyb2xJbnRlbnRcbiAqIEBwYXJhbSBjb250cm9sSU1EYXRhXG4gKi9cbmZ1bmN0aW9uIGdlbmVyYXRlQ29tcGxldGVJbnRlbnQoY29udHJvbEludGVudDogQmFzZUNvbnRyb2xJbnRlbnQsIGNvbnRyb2xJTURhdGE6IE1vZGVsRGF0YSk6IEludGVudCB7XG5cbiAgICAvLyBTcGVjaWFsIGxvZ2ljIGZvciBTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnRcbiAgICBpZiAoY29udHJvbEludGVudC5uYW1lLmluY2x1ZGVzKCdWYWx1ZUNvbnRyb2xJbnRlbnQnKSkge1xuICAgICAgICByZXR1cm4gaGFuZGxlVmFsdWVDb250cm9sSW50ZW50KGNvbnRyb2xJbnRlbnQgYXMgU2luZ2xlVmFsdWVDb250cm9sSW50ZW50LCBjb250cm9sSU1EYXRhKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnRlbnQ6IEludGVudCA9IGNvbnRyb2xJbnRlbnQuZ2VuZXJhdGVJbnRlbnQoKTtcbiAgICBjb25zdCBzYW1wbGVzOiBzdHJpbmdbXSB8IHVuZGVmaW5lZCA9IGNvbnRyb2xJTURhdGEuaW50ZW50VmFsdWVzLmZpbmQoKGludGVudFZhbHVlKSA9PiBpbnRlbnRWYWx1ZS5uYW1lID09PSBjb250cm9sSW50ZW50Lm5hbWUpPy5zYW1wbGVzO1xuXG4gICAgaWYgKHNhbXBsZXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7Y29udHJvbEludGVudC5uYW1lfSBkb2Vzbid0IGhhdmUgc2FtcGxlcyByZWdpc3RlcmVkIGluIHRoZSBNb2RlbERhdGEuYCk7XG4gICAgfVxuXG4gICAgaW50ZW50LnNhbXBsZXMgPSBzYW1wbGVzO1xuXG4gICAgcmV0dXJuIGludGVudDtcbn1cblxuXG5mdW5jdGlvbiBoYW5kbGVWYWx1ZUNvbnRyb2xJbnRlbnQoY29udHJvbEludGVudDogU2luZ2xlVmFsdWVDb250cm9sSW50ZW50LCBjb250cm9sSU1EYXRhOiBNb2RlbERhdGEpOiBJbnRlbnQge1xuICAgIGNvbnN0IGludGVudDogSW50ZW50ID0gY29udHJvbEludGVudC5nZW5lcmF0ZUludGVudCgpO1xuICAgIGNvbnN0IHNhbXBsZXM6IHN0cmluZ1tdIHwgdW5kZWZpbmVkID0gY29udHJvbElNRGF0YS5pbnRlbnRWYWx1ZXMuZmluZCgoaW50ZW50VmFsdWUpID0+IGludGVudFZhbHVlLm5hbWUgPT09IFNpbmdsZVZhbHVlQ29udHJvbEludGVudC5uYW1lKT8uc2FtcGxlcztcbiAgICBpZiAoc2FtcGxlcyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ2FuIG5vdCBmaW5kIFNpbmdsZVZhbHVlQ29udHJvbEludGVudCBzYW1wbGVzIGluIE1vZGVsRGF0YScpO1xuICAgIH1cbiAgICBjb25zdCBzbG90VHlwZTogc3RyaW5nID0gY29udHJvbEludGVudC52YWx1ZVNsb3RUeXBlO1xuICAgIGNvbnN0IHJlcGxhY2VtZW50OiBzdHJpbmcgPSBgeyR7c2xvdFR5cGV9fWA7XG4gICAgaW50ZW50LnNhbXBsZXMgPSBpbnRlbnQuc2FtcGxlcyB8fCBbXTtcbiAgICBzYW1wbGVzLm1hcCgoc2FtcGxlKSA9PiB7XG4gICAgICAgIGludGVudC5zYW1wbGVzIS5wdXNoKHNhbXBsZS5yZXBsYWNlKCdbW3ZhbHVlU2xvdFR5cGVdXScsIHJlcGxhY2VtZW50KSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGludGVudDtcbn1cblxuLy8gVGhpcyBtZXRob2QgYWRkcyBhIGR1bW15IGRpYWxvZ01vZGVsIHNvIHRoYXQgRGlhbG9nIGRpcmVjdGl2ZXMgc3VjaCBhcyBEaWFsb2cuRWxpY2l0U2xvdERpcmVjdGl2ZSBjYW4gYmUgdXNlZC5cbi8vIDEuIEFkZCBkdW1teSB2YWxpZGF0aW9uIHJ1bGUgdG8gU2ltcGxlQ29udHJvbEludGVudCcgdGFyZ2V0IHNsb3Rcbi8vIDIuIEFkZCBkdW1teSBwcm9tcHRcbmZ1bmN0aW9uIGVuc3VyZURpYWxvZ01vZGVsKGdlbmVyYXRvcjogQ29udHJvbEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3IsIGludGVudHM6IEludGVudFtdKTogdm9pZCB7XG5cbiAgICAvLyBTaW5jZSBvbmUgZHVtbXkgdmFsaWRhdGlvbiBpcyBlbm91Z2ggdG8gbWVldCBzbG90RWxpY2l0YXRpb24gcmVxdWlyZW1lbnRcbiAgICAvLyBBbmQgYWxsIHRoZSBidWlsdGluIGNvbnRyb2xzIGludGVncmF0ZSB3aXRoIHRoZSBTaW1wbGVDb250cm9sSW50ZW50XG4gICAgLy8gVGh1cyBhZGQgdGhpcyBkdW1teSB2YWxpZGF0aW9uIHRvIHRoZSBmaXJzdCB0YXJnZXQgdHlwZSBzbG90VHlwZVxuICAgIGNvbnN0IHNpbXBsZUNvbnRyb2xJbnRlbnQgPSBpbnRlbnRzLmZpbmQoKGludGVudCkgPT4gaW50ZW50Lm5hbWUgPT09IEdlbmVyYWxDb250cm9sSW50ZW50Lm5hbWUpO1xuICAgIGlmICghc2ltcGxlQ29udHJvbEludGVudCkge1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIGNvbnN0IGRpYWxvZ1NpbXBsZUNvbnRyb2xJbnRlbnQgPSBidWlsZERpYWxvZ0ludGVudChzaW1wbGVDb250cm9sSW50ZW50KTtcbiAgICBnZW5lcmF0b3IuYWRkRGlhbG9nSW50ZW50cyhkaWFsb2dTaW1wbGVDb250cm9sSW50ZW50KTtcblxuICAgIGNvbnN0IHRhcmdldFNsb3QgPSBkaWFsb2dTaW1wbGVDb250cm9sSW50ZW50LnNsb3RzPy5maW5kKChzbG90KSA9PiBzbG90LnR5cGUgPT09ICd0YXJnZXQnKTtcbiAgICBpZiAodGFyZ2V0U2xvdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcigndGFyZ2V0IHNsb3QgaXMgbm90IHByZXNlbnQgaW4gU2ltcGxlQ29udHJvbEludGVudCcpO1xuICAgIH1cbiAgICBhZGREdW1teVZhbGlkYXRpb25SdWxlKHRhcmdldFNsb3QpO1xuICAgIGdlbmVyYXRvci5hZGRQcm9tcHRzKC4uLmR1bW15UHJvbXB0cyk7XG59XG5cbi8qKlxuICogIEFkZCBkdW1teSBkaWFsb2cgdmFsaWRhdGlvbiBydWxlIHRvIHRoZSBpbnB1dCBzbG90XG4gKiBAcGFyYW0gdGFyZ2V0U2xvdFxuICovXG5mdW5jdGlvbiBhZGREdW1teVZhbGlkYXRpb25SdWxlKHRhcmdldFNsb3Q6IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuRGlhbG9nU2xvdEl0ZW1zKTogdm9pZCB7XG4gICAgdGFyZ2V0U2xvdC5lbGljaXRhdGlvblJlcXVpcmVkID0gZmFsc2U7XG4gICAgdGFyZ2V0U2xvdC5jb25maXJtYXRpb25SZXF1aXJlZCA9IGZhbHNlO1xuICAgIC8vIFRoZSBwYXJ0aWN1bGFyIGR1bW15IG1vZGVsIGNvbXByaXNlcyBhIHNpbmdsZSBzbG90LXZhbGlkYXRpb24gdGhhdCB3aWxsIGFsd2F5cyBwYXNzLlxuICAgIHRhcmdldFNsb3QudmFsaWRhdGlvbnMgPSBbe1xuICAgICAgICB0eXBlOiBcImlzTm90SW5TZXRcIixcbiAgICAgICAgcHJvbXB0OiBcIlNsb3QuVmFsaWRhdGlvbi41NjQyNDYyMjM1NzkuMTQ2NzQxODA0NDI0OC42Nzg0NjEyMzA0OTVcIixcbiAgICAgICAgdmFsdWVzOiBbXG4gICAgICAgICAgICBcIlRoaXMgcHJvbXB0IGlzIGEgZHVtbXkgaW5jbHVkZWQgb25seSB0byBlbnN1cmUgdGhlcmUgaXMgYSBkaWFsb2cgbW9kZWwgcHJlc2VudC5cIlxuICAgICAgICBdXG4gICAgfV07XG59XG5cbi8qKlxuICogVmFsaWRhdGUgdGhlIHRhcmdldCBzbG90SWRzIGluIENvbnRyb2xzIGFyZSBwcmVzZW50IGluIEludGVyYWN0aW9uTW9kZWxcbiAqIEBwYXJhbSBpbnRlcmFjdGlvbk1vZGVsXG4gKiBAcGFyYW0gdGFyZ2V0U2xvdElEc1xuICovXG5mdW5jdGlvbiB2YWxpZGF0ZVRhcmdldFNsb3RzKGludGVyYWN0aW9uTW9kZWw6IEludGVyYWN0aW9uTW9kZWxEYXRhLCB0YXJnZXRTbG90SWRzOiBTZXQ8c3RyaW5nPik6IHZvaWQge1xuICAgIGNvbnN0IHByZXNlbnRTbG90VHlwZXM6IFNsb3RUeXBlW10gfCB1bmRlZmluZWQgPSBpbnRlcmFjdGlvbk1vZGVsLmludGVyYWN0aW9uTW9kZWw/Lmxhbmd1YWdlTW9kZWw/LnR5cGVzO1xuICAgIGZvciAoY29uc3QgdGFyZ2V0U2xvdElkIG9mIHRhcmdldFNsb3RJZHMpIHtcbiAgICAgICAgaWYgKHByZXNlbnRTbG90VHlwZXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgbG9nLndhcm4oYHRhcmdldCBzbG90IHdpdGggaWQgJHt0YXJnZXRTbG90SWR9IGlzIG5vdCBwcmVzZW50IGluIEludGVyYWN0aW9uTW9kZWwuYCk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1hdGNoID0gcHJlc2VudFNsb3RUeXBlcy5maW5kKChzbG90VHlwZSkgPT4gc2xvdFR5cGUudmFsdWVzPy5maW5kKCh2YWx1ZSkgPT4gdmFsdWUuaWQgPT09IHRhcmdldFNsb3RJZCkpO1xuXG4gICAgICAgIGlmIChtYXRjaCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBsb2cud2FybihgdGFyZ2V0IHNsb3Qgd2l0aCBpZCAke3RhcmdldFNsb3RJZH0gaXMgbm90IHByZXNlbnQgaW4gSW50ZXJhY3Rpb25Nb2RlbC5gKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuLyoqXG4gKiBHZW5lcmF0ZSB0aGUgbW9kZWxEYXRhIE9iamVjdCBieSByZWFkaW5nIHRoZSBpMThuIGluc3RhbmNlXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZU1vZGVsRGF0YSgpOiBNb2RlbERhdGEge1xuICAgIGNvbnN0IHNsb3RUeXBlczogU2xvdFR5cGVbXSA9IFtdO1xuICAgIHNsb3RUeXBlcy5wdXNoKGkxOG5leHQudCgnU0hBUkVEX1NMT1RfVFlQRVNfRkVFREJBQ0snLCB7IHJldHVybk9iamVjdHM6IHRydWUgfSkpO1xuICAgIHNsb3RUeXBlcy5wdXNoKGkxOG5leHQudCgnU0hBUkVEX1NMT1RfVFlQRVNfSEVBRCcsIHsgcmV0dXJuT2JqZWN0czogdHJ1ZSB9KSk7XG4gICAgc2xvdFR5cGVzLnB1c2goaTE4bmV4dC50KCdTSEFSRURfU0xPVF9UWVBFU19UQUlMJywgeyByZXR1cm5PYmplY3RzOiB0cnVlIH0pKTtcbiAgICBzbG90VHlwZXMucHVzaChpMThuZXh0LnQoJ1NIQVJFRF9TTE9UX1RZUEVTX0NPTkpVTkNUSU9OJywgeyByZXR1cm5PYmplY3RzOiB0cnVlIH0pKTtcbiAgICBzbG90VHlwZXMucHVzaChpMThuZXh0LnQoJ1NIQVJFRF9TTE9UX1RZUEVTX1BSRVBPU0lUSU9OJywgeyByZXR1cm5PYmplY3RzOiB0cnVlIH0pKTtcbiAgICBzbG90VHlwZXMucHVzaChpMThuZXh0LnQoJ1NIQVJFRF9TTE9UX1RZUEVTX0FDVElPTicsIHsgcmV0dXJuT2JqZWN0czogdHJ1ZSB9KSk7XG4gICAgc2xvdFR5cGVzLnB1c2goaTE4bmV4dC50KCdTSEFSRURfU0xPVF9UWVBFU19UQVJHRVQnLCB7IHJldHVybk9iamVjdHM6IHRydWUgfSkpO1xuXG4gICAgY29uc3QgaW50ZW50VmFsdWVzOiBJbnRlbnRVdHRlcmFuY2VzW10gPSBbXTtcbiAgICBpbnRlbnRWYWx1ZXMucHVzaCh7XG4gICAgICAgIG5hbWU6IENvbmp1bmN0aW9uQ29udHJvbEludGVudC5uYW1lLFxuICAgICAgICBzYW1wbGVzOiBpMThuZXh0LnQoJ0NPTkpVTkNUSU9OX0NPTlRST0xfSU5URU5UX1NBTVBMRVMnLCB7IHJldHVybk9iamVjdHM6IHRydWUgfSlcbiAgICB9KTtcbiAgICBpbnRlbnRWYWx1ZXMucHVzaCh7XG4gICAgICAgIG5hbWU6IERhdGVDb250cm9sSW50ZW50Lm5hbWUsXG4gICAgICAgIHNhbXBsZXM6IGkxOG5leHQudCgnREFURV9DT05UUk9MX0lOVEVOVF9TQU1QTEVTJywgeyByZXR1cm5PYmplY3RzOiB0cnVlIH0pXG4gICAgfSk7XG4gICAgaW50ZW50VmFsdWVzLnB1c2goe1xuICAgICAgICBuYW1lOiBEYXRlUmFuZ2VDb250cm9sSW50ZW50Lm5hbWUsXG4gICAgICAgIHNhbXBsZXM6IGkxOG5leHQudCgnREFURV9SQU5HRV9DT05UUk9MX0lOVEVOVF9TQU1QTEVTJywgeyByZXR1cm5PYmplY3RzOiB0cnVlIH0pXG4gICAgfSk7XG4gICAgaW50ZW50VmFsdWVzLnB1c2goe1xuICAgICAgICBuYW1lOiBHZW5lcmFsQ29udHJvbEludGVudC5uYW1lLFxuICAgICAgICBzYW1wbGVzOiBpMThuZXh0LnQoJ0dFTkVSQUxfQ09OVFJPTF9JTlRFTlRfU0FNUExFUycsIHsgcmV0dXJuT2JqZWN0czogdHJ1ZSB9KVxuICAgIH0pO1xuICAgIGludGVudFZhbHVlcy5wdXNoKHtcbiAgICAgICAgbmFtZTogTnVtYmVyQ29udHJvbEludGVudC5uYW1lLFxuICAgICAgICBzYW1wbGVzOiBpMThuZXh0LnQoJ05VTUJFUl9DT05UUk9MX0lOVEVOVF9TQU1QTEVTJywgeyByZXR1cm5PYmplY3RzOiB0cnVlIH0pXG4gICAgfSk7XG4gICAgaW50ZW50VmFsdWVzLnB1c2goe1xuICAgICAgICBuYW1lOiBPcmRpbmFsQ29udHJvbEludGVudC5uYW1lLFxuICAgICAgICBzYW1wbGVzOiBpMThuZXh0LnQoJ09SRElOQUxfQ09OVFJPTF9JTlRFTlRfU0FNUExFUycsIHsgcmV0dXJuT2JqZWN0czogdHJ1ZSB9KVxuICAgIH0pO1xuICAgIGludGVudFZhbHVlcy5wdXNoKHtcbiAgICAgICAgbmFtZTogU2luZ2xlVmFsdWVDb250cm9sSW50ZW50Lm5hbWUsXG4gICAgICAgIHNhbXBsZXM6IGkxOG5leHQudCgnU0lOR0xFX1ZBTFVFX0NPTlRST0xfSU5URU5UX1NBTVBMRVMnLCB7IHJldHVybk9iamVjdHM6IHRydWUgfSlcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIHNsb3RUeXBlcyxcbiAgICAgICAgaW50ZW50VmFsdWVzXG4gICAgfTtcbn1cblxuIl19