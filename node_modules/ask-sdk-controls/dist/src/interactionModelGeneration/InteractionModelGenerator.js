"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.InteractionModelGenerator = void 0;
const tslib_1 = require("tslib");
const fs_1 = tslib_1.__importDefault(require("fs"));
const lodash_1 = tslib_1.__importDefault(require("lodash"));
const path_1 = require("path");
const Logger_1 = require("../logging/Logger");
const log = new Logger_1.Logger('AskSdkControls:InteractionModelGenerator');
class InteractionModelGenerator {
    constructor() {
        this.intents = [];
        this.slotTypes = [];
        this.dialogIntents = [];
        this.prompts = [];
    }
    addIntent(intent) {
        // First Check whether the new intent has the same name as any existing intents
        // If intent has the same name already exist in the array,
        // then check whether these two intents are deeply equal to each other
        // skip adding new intent if they are exactly same, otherwise throw error
        const matchingIntent = this.intents.find(existIntent => existIntent.name === intent.name);
        if (matchingIntent === undefined) {
            this.intents.push(intent);
            return this;
        }
        if (lodash_1.default.isEqual(matchingIntent, intent)) {
            return this;
        }
        throw new Error(`Intent ${intent.name} is defined more than once and the definitions are not identical.`);
    }
    addIntents(...intents) {
        for (const intent of intents) {
            this.addIntent(intent);
        }
        return this;
    }
    addOrMergeSlotType(slotType) {
        var _a;
        const matchingSlotType = this.slotTypes.find(s => s.name === slotType.name);
        if (matchingSlotType === undefined) {
            // slot not yet present so just push it
            this.slotTypes.push(slotType);
            return this;
        }
        // slot present so add the values
        for (const value of (_a = slotType.values) !== null && _a !== void 0 ? _a : []) {
            mergeSlotTypeValues(matchingSlotType.values, value, matchingSlotType.name);
        }
        return this;
    }
    addOrMergeSlotTypes(...slotTypes) {
        for (const slotType of slotTypes) {
            this.addOrMergeSlotType(slotType);
        }
        return this;
    }
    addValuesToSlotType(slotName, ...values) {
        const slotType = this.slotTypes.find(s => s.name === slotName);
        if (!slotType) {
            throw new Error(`SlotType ${slotName} is not defined.`);
        }
        for (const value of values) {
            mergeSlotTypeValues(slotType.values, value, slotType.name);
        }
        return this;
    }
    addDialogIntent(dialogIntent) {
        const matchingIntent = this.dialogIntents.find(existIntent => existIntent.name === dialogIntent.name);
        if (matchingIntent === undefined) {
            this.dialogIntents.push(dialogIntent);
            return this;
        }
        if (lodash_1.default.isEqual(matchingIntent, dialogIntent)) {
            return this;
        }
        throw new Error(`DialogIntent ${dialogIntent.name} is defined more than once and the definitions are not identical.`);
    }
    addDialogIntents(...dialogIntents) {
        for (const dialogIntent of dialogIntents) {
            this.addDialogIntent(dialogIntent);
        }
        return this;
    }
    addDelegationStrategy(delegationStrategy) {
        this.delegationStrategy = delegationStrategy;
        return this;
    }
    addPrompt(prompt) {
        const matchingPrompt = this.prompts.find(existPrompt => existPrompt.id === prompt.id);
        if (matchingPrompt === undefined) {
            this.prompts.push(prompt);
            return this;
        }
        if (lodash_1.default.isEqual(matchingPrompt, prompt)) {
            return this;
        }
        throw new Error(`Prompt with id ${prompt.id} is defined more than once and the definitions are not identical.`);
    }
    addPrompts(...prompts) {
        for (const prompt of prompts) {
            this.addPrompt(prompt);
        }
        return this;
    }
    withInvocationName(name) {
        if (this.invocationName) {
            log.warn(`Skill invocation name ${this.invocationName} has been overwritten to ${name}.`);
        }
        this.invocationName = name;
        return this;
    }
    loadFromFile(inputPath) {
        if (!inputPath || !fs_1.default.existsSync(inputPath)) {
            throw new Error('Input path is not valid.');
        }
        // fetch all info from json
        // eslint-disable-next-line @typescript-eslint/no-var-requires
        const interactionModel = require(inputPath).interactionModel;
        const intents = interactionModel.languageModel.intents ? interactionModel.languageModel.intents : [];
        const slotTypes = interactionModel.languageModel.types ? interactionModel.languageModel.types : [];
        const invocationName = interactionModel.languageModel.invocationName;
        const prompts = interactionModel.prompts ? interactionModel.prompts : [];
        const dialog = interactionModel.dialog ? interactionModel.dialog : {};
        const dialogIntents = dialog.intents ? dialog.intents : [];
        const delegationStrategy = dialog.delegationStrategy;
        this.addIntents(...intents);
        this.addOrMergeSlotTypes(...slotTypes);
        this.addDialogIntents(...dialogIntents);
        if (delegationStrategy !== undefined) {
            this.addDelegationStrategy(delegationStrategy);
        }
        this.addPrompts(...prompts);
        this.withInvocationName(invocationName);
        return this;
    }
    build() {
        if (!this.invocationName) {
            console.warn('Invocation name is not defined');
        }
        const interactionModel = {
            languageModel: {},
            prompts: []
        };
        interactionModel.languageModel.types = this.slotTypes;
        interactionModel.languageModel.intents = this.intents;
        if (this.dialogIntents.length > 0 || this.delegationStrategy) {
            interactionModel.dialog = {};
        }
        if (this.dialogIntents.length > 0) {
            interactionModel.dialog.intents = this.dialogIntents;
        }
        if (this.delegationStrategy) {
            interactionModel.dialog.delegationStrategy = this.delegationStrategy;
        }
        interactionModel.prompts = this.prompts;
        interactionModel.languageModel.invocationName = this.invocationName;
        return {
            interactionModel,
        };
    }
    buildAndWrite(fileName) {
        const interactionModelJson = JSON.stringify(this.build(), null, 2);
        const path = path_1.join(process.cwd(), fileName);
        fs_1.default.writeFileSync(path, interactionModelJson);
    }
}
exports.InteractionModelGenerator = InteractionModelGenerator;
function mergeSlotTypeValues(slotTypeValues, newSlotValue, slotName) {
    var _a, _b, _c, _d, _e, _f, _g, _h;
    if (!slotTypeValues) {
        slotTypeValues = [newSlotValue];
        return;
    }
    const matchingValue = slotTypeValues.find(v => { var _a, _b; return ((_a = v.name) === null || _a === void 0 ? void 0 : _a.value) === ((_b = newSlotValue.name) === null || _b === void 0 ? void 0 : _b.value) || v.id === newSlotValue.id; });
    if (!matchingValue) {
        // value not yet present so just push it
        slotTypeValues.push(newSlotValue);
    }
    else {
        // value present, so add synonyms
        if (((_a = matchingValue.name) === null || _a === void 0 ? void 0 : _a.value) !== ((_b = newSlotValue.name) === null || _b === void 0 ? void 0 : _b.value)) {
            throw new Error(`Cannot merge slot type ${slotName}, as the value ${JSON.stringify(newSlotValue)} and ${JSON.stringify(matchingValue)} has the same id but different name.value.`);
        }
        if (matchingValue.id !== newSlotValue.id) {
            throw new Error(`Cannot merge slot type ${slotName}, as the value ${JSON.stringify(newSlotValue)} and ${JSON.stringify(matchingValue)} has the same name.value but different id.`);
        }
        for (const synonym of (_d = (_c = newSlotValue.name) === null || _c === void 0 ? void 0 : _c.synonyms) !== null && _d !== void 0 ? _d : []) {
            const matchingSynonym = (_f = (_e = matchingValue.name) === null || _e === void 0 ? void 0 : _e.synonyms) === null || _f === void 0 ? void 0 : _f.find(s => s === synonym);
            if (matchingSynonym === undefined) {
                // synonym not yet preset so just push it
                (_h = (_g = matchingValue.name) === null || _g === void 0 ? void 0 : _g.synonyms) === null || _h === void 0 ? void 0 : _h.push(synonym);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW50ZXJhY3Rpb25Nb2RlbEdlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9pbnRlcmFjdGlvbk1vZGVsR2VuZXJhdGlvbi9JbnRlcmFjdGlvbk1vZGVsR2VuZXJhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7QUFhQSxvREFBb0I7QUFDcEIsNERBQXVCO0FBQ3ZCLCtCQUE0QjtBQUM1Qiw4Q0FBMkM7QUFZM0MsTUFBTSxHQUFHLEdBQUcsSUFBSSxlQUFNLENBQUMsMENBQTBDLENBQUMsQ0FBQztBQUVuRSxNQUFhLHlCQUF5QjtJQUF0QztRQUVjLFlBQU8sR0FBYSxFQUFFLENBQUM7UUFDdkIsY0FBUyxHQUFlLEVBQUUsQ0FBQztRQUMzQixrQkFBYSxHQUFtQixFQUFFLENBQUM7UUFFbkMsWUFBTyxHQUFhLEVBQUUsQ0FBQztJQXNMckMsQ0FBQztJQWxMRyxTQUFTLENBQUMsTUFBYztRQUNwQiwrRUFBK0U7UUFDL0UsMERBQTBEO1FBQzFELHNFQUFzRTtRQUN0RSx5RUFBeUU7UUFDekUsTUFBTSxjQUFjLEdBQXVCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLElBQUksS0FBSyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUcsSUFBSSxjQUFjLEtBQUssU0FBUyxFQUFFO1lBQzlCLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzFCLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7UUFDRCxJQUFJLGdCQUFDLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsRUFBRTtZQUNuQyxPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsTUFBTSxJQUFJLEtBQUssQ0FBQyxVQUFVLE1BQU0sQ0FBQyxJQUFJLG1FQUFtRSxDQUFDLENBQUM7SUFDOUcsQ0FBQztJQUVELFVBQVUsQ0FBQyxHQUFHLE9BQWlC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USxrQkFBa0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsUUFBUSxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyw0Q0FBNEMsQ0FBQyxDQUFDO1NBQ3RMO1FBRUQsS0FBSyxNQUFNLE9BQU8sZ0JBQUksWUFBWSxDQUFDLElBQUksMENBQUUsUUFBUSxtQ0FBSSxFQUFFLEVBQUU7WUFDckQsTUFBTSxlQUFlLGVBQUcsYUFBYSxDQUFDLElBQUksMENBQUUsUUFBUSwwQ0FBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssT0FBTyxDQUFDLENBQUM7WUFDL0UsSUFBSSxlQUFlLEtBQUssU0FBUyxFQUFFO2dCQUMvQix5Q0FBeUM7Z0JBQ3pDLFlBQUEsYUFBYSxDQUFDLElBQUksMENBQUUsUUFBUSwwQ0FBRSxJQUFJLENBQUMsT0FBTyxFQUFFO2FBQy9DO1NBQ0o7S0FDSjtBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IDIwMTkgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuXG4gKiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBvciBpbiB0aGUgXCJsaWNlbnNlXCIgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWRcbiAqIG9uIGFuIFwiQVMgSVNcIiBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlclxuICogZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmdcbiAqIHBlcm1pc3Npb25zIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuaW1wb3J0IHsgdjEgfSBmcm9tICdhc2stc21hcGktbW9kZWwnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBqb2luIH0gZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9sb2dnaW5nL0xvZ2dlcic7XG5cbmltcG9ydCBJbnRlcmFjdGlvbk1vZGVsRGF0YSA9IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuSW50ZXJhY3Rpb25Nb2RlbERhdGE7XG5pbXBvcnQgSW50ZXJhY3Rpb25Nb2RlbFNjaGVtYSA9IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuSW50ZXJhY3Rpb25Nb2RlbFNjaGVtYTtcbmltcG9ydCBTbG90VHlwZSA9IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuU2xvdFR5cGU7XG5pbXBvcnQgVHlwZVZhbHVlID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5UeXBlVmFsdWU7XG5pbXBvcnQgSW50ZW50ID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5JbnRlbnQ7XG5pbXBvcnQgRGlhbG9nSW50ZW50ID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5EaWFsb2dJbnRlbnRzO1xuaW1wb3J0IERpYWxvZyA9IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuRGlhbG9nO1xuaW1wb3J0IERlbGVnYXRpb25TdHJhdGVneVR5cGUgPSB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLkRlbGVnYXRpb25TdHJhdGVneVR5cGU7XG5pbXBvcnQgUHJvbXB0ID0gdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5Qcm9tcHQ7XG5cbmNvbnN0IGxvZyA9IG5ldyBMb2dnZXIoJ0Fza1Nka0NvbnRyb2xzOkludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3InKTtcblxuZXhwb3J0IGNsYXNzIEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3Ige1xuXG4gICAgcHJvdGVjdGVkIGludGVudHM6IEludGVudFtdID0gW107XG4gICAgcHJvdGVjdGVkIHNsb3RUeXBlczogU2xvdFR5cGVbXSA9IFtdO1xuICAgIHByb3RlY3RlZCBkaWFsb2dJbnRlbnRzOiBEaWFsb2dJbnRlbnRbXSA9IFtdO1xuICAgIHByb3RlY3RlZCBkZWxlZ2F0aW9uU3RyYXRlZ3k6IERlbGVnYXRpb25TdHJhdGVneVR5cGU7XG4gICAgcHJvdGVjdGVkIHByb21wdHM6IFByb21wdFtdID0gW107XG4gICAgcHJvdGVjdGVkIGludm9jYXRpb25OYW1lOiBzdHJpbmc7XG5cblxuICAgIGFkZEludGVudChpbnRlbnQ6IEludGVudCk6IEludGVyYWN0aW9uTW9kZWxHZW5lcmF0b3Ige1xuICAgICAgICAvLyBGaXJzdCBDaGVjayB3aGV0aGVyIHRoZSBuZXcgaW50ZW50IGhhcyB0aGUgc2FtZSBuYW1lIGFzIGFueSBleGlzdGluZyBpbnRlbnRzXG4gICAgICAgIC8vIElmIGludGVudCBoYXMgdGhlIHNhbWUgbmFtZSBhbHJlYWR5IGV4aXN0IGluIHRoZSBhcnJheSxcbiAgICAgICAgLy8gdGhlbiBjaGVjayB3aGV0aGVyIHRoZXNlIHR3byBpbnRlbnRzIGFyZSBkZWVwbHkgZXF1YWwgdG8gZWFjaCBvdGhlclxuICAgICAgICAvLyBza2lwIGFkZGluZyBuZXcgaW50ZW50IGlmIHRoZXkgYXJlIGV4YWN0bHkgc2FtZSwgb3RoZXJ3aXNlIHRocm93IGVycm9yXG4gICAgICAgIGNvbnN0IG1hdGNoaW5nSW50ZW50OiBJbnRlbnQgfCB1bmRlZmluZWQgPSB0aGlzLmludGVudHMuZmluZChleGlzdEludGVudCA9PiBleGlzdEludGVudC5uYW1lID09PSBpbnRlbnQubmFtZSk7XG4gICAgICAgIGlmIChtYXRjaGluZ0ludGVudCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmludGVudHMucHVzaChpbnRlbnQpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKF8uaXNFcXVhbChtYXRjaGluZ0ludGVudCwgaW50ZW50KSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnRlbnQgJHtpbnRlbnQubmFtZX0gaXMgZGVmaW5lZCBtb3JlIHRoYW4gb25jZSBhbmQgdGhlIGRlZmluaXRpb25zIGFyZSBub3QgaWRlbnRpY2FsLmApO1xuICAgIH1cblxuICAgIGFkZEludGVudHMoLi4uaW50ZW50czogSW50ZW50W10pOiB0aGlzIHtcbiAgICAgICAgZm9yIChjb25zdCBpbnRlbnQgb2YgaW50ZW50cykge1xuICAgICAgICAgICAgdGhpcy5hZGRJbnRlbnQoaW50ZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZE9yTWVyZ2VTbG90VHlwZShzbG90VHlwZTogU2xvdFR5cGUpOiB0aGlzIHtcblxuICAgICAgICBjb25zdCBtYXRjaGluZ1Nsb3RUeXBlID0gdGhpcy5zbG90VHlwZXMuZmluZChzID0+IHMubmFtZSA9PT0gc2xvdFR5cGUubmFtZSk7XG4gICAgICAgIGlmIChtYXRjaGluZ1Nsb3RUeXBlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIC8vIHNsb3Qgbm90IHlldCBwcmVzZW50IHNvIGp1c3QgcHVzaCBpdFxuICAgICAgICAgICAgdGhpcy5zbG90VHlwZXMucHVzaChzbG90VHlwZSk7XG4gICAgICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgICAgfVxuICAgICAgICAvLyBzbG90IHByZXNlbnQgc28gYWRkIHRoZSB2YWx1ZXNcbiAgICAgICAgZm9yIChjb25zdCB2YWx1ZSBvZiBzbG90VHlwZS52YWx1ZXMgPz8gW10pIHtcbiAgICAgICAgICAgIG1lcmdlU2xvdFR5cGVWYWx1ZXMobWF0Y2hpbmdTbG90VHlwZS52YWx1ZXMsIHZhbHVlLCBtYXRjaGluZ1Nsb3RUeXBlLm5hbWUhKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBhZGRPck1lcmdlU2xvdFR5cGVzKC4uLnNsb3RUeXBlczogU2xvdFR5cGVbXSk6IHRoaXMge1xuICAgICAgICBmb3IgKGNvbnN0IHNsb3RUeXBlIG9mIHNsb3RUeXBlcykge1xuICAgICAgICAgICAgdGhpcy5hZGRPck1lcmdlU2xvdFR5cGUoc2xvdFR5cGUpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuXG4gICAgYWRkVmFsdWVzVG9TbG90VHlwZShzbG90TmFtZTogc3RyaW5nLCAuLi52YWx1ZXM6IFR5cGVWYWx1ZVtdKTogdGhpcyB7XG4gICAgICAgIGNvbnN0IHNsb3RUeXBlID0gdGhpcy5zbG90VHlwZXMuZmluZChzID0+IHMubmFtZSA9PT0gc2xvdE5hbWUpO1xuICAgICAgICBpZiAoIXNsb3RUeXBlKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFNsb3RUeXBlICR7c2xvdE5hbWV9IGlzIG5vdCBkZWZpbmVkLmApO1xuICAgICAgICB9XG4gICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgdmFsdWVzKSB7XG4gICAgICAgICAgICBtZXJnZVNsb3RUeXBlVmFsdWVzKHNsb3RUeXBlLnZhbHVlcywgdmFsdWUsIHNsb3RUeXBlLm5hbWUhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZERpYWxvZ0ludGVudChkaWFsb2dJbnRlbnQ6IERpYWxvZ0ludGVudCk6IHRoaXMge1xuICAgICAgICBjb25zdCBtYXRjaGluZ0ludGVudDogSW50ZW50IHwgdW5kZWZpbmVkID0gdGhpcy5kaWFsb2dJbnRlbnRzLmZpbmQoZXhpc3RJbnRlbnQgPT4gZXhpc3RJbnRlbnQubmFtZSA9PT0gZGlhbG9nSW50ZW50Lm5hbWUpO1xuICAgICAgICBpZiAobWF0Y2hpbmdJbnRlbnQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5kaWFsb2dJbnRlbnRzLnB1c2goZGlhbG9nSW50ZW50KTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICB9XG4gICAgICAgIGlmIChfLmlzRXF1YWwobWF0Y2hpbmdJbnRlbnQsIGRpYWxvZ0ludGVudCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRGlhbG9nSW50ZW50ICR7ZGlhbG9nSW50ZW50Lm5hbWV9IGlzIGRlZmluZWQgbW9yZSB0aGFuIG9uY2UgYW5kIHRoZSBkZWZpbml0aW9ucyBhcmUgbm90IGlkZW50aWNhbC5gKTtcbiAgICB9XG5cbiAgICBhZGREaWFsb2dJbnRlbnRzKC4uLmRpYWxvZ0ludGVudHM6IERpYWxvZ0ludGVudFtdKTogdGhpcyB7XG4gICAgICAgIGZvciAoY29uc3QgZGlhbG9nSW50ZW50IG9mIGRpYWxvZ0ludGVudHMpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkRGlhbG9nSW50ZW50KGRpYWxvZ0ludGVudCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBhZGREZWxlZ2F0aW9uU3RyYXRlZ3koZGVsZWdhdGlvblN0cmF0ZWd5OiBEZWxlZ2F0aW9uU3RyYXRlZ3lUeXBlKTogdGhpcyB7XG4gICAgICAgIHRoaXMuZGVsZWdhdGlvblN0cmF0ZWd5ID0gZGVsZWdhdGlvblN0cmF0ZWd5O1xuXG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cblxuICAgIGFkZFByb21wdChwcm9tcHQ6IFByb21wdCk6IHRoaXMge1xuICAgICAgICBjb25zdCBtYXRjaGluZ1Byb21wdCA9IHRoaXMucHJvbXB0cy5maW5kKGV4aXN0UHJvbXB0ID0+IGV4aXN0UHJvbXB0LmlkID09PSBwcm9tcHQuaWQpO1xuICAgICAgICBpZiAobWF0Y2hpbmdQcm9tcHQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5wcm9tcHRzLnB1c2gocHJvbXB0KTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICB9XG4gICAgICAgIGlmIChfLmlzRXF1YWwobWF0Y2hpbmdQcm9tcHQsIHByb21wdCkpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgUHJvbXB0IHdpdGggaWQgJHtwcm9tcHQuaWR9IGlzIGRlZmluZWQgbW9yZSB0aGFuIG9uY2UgYW5kIHRoZSBkZWZpbml0aW9ucyBhcmUgbm90IGlkZW50aWNhbC5gKTtcbiAgICB9XG5cbiAgICBhZGRQcm9tcHRzKC4uLnByb21wdHM6IFByb21wdFtdKTogdGhpcyB7XG4gICAgICAgIGZvciAoY29uc3QgcHJvbXB0IG9mIHByb21wdHMpIHtcbiAgICAgICAgICAgIHRoaXMuYWRkUHJvbXB0KHByb21wdCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICB3aXRoSW52b2NhdGlvbk5hbWUobmFtZTogc3RyaW5nKTogdGhpcyB7XG4gICAgICAgIGlmICh0aGlzLmludm9jYXRpb25OYW1lKSB7XG4gICAgICAgICAgICBsb2cud2FybihgU2tpbGwgaW52b2NhdGlvbiBuYW1lICR7dGhpcy5pbnZvY2F0aW9uTmFtZX0gaGFzIGJlZW4gb3ZlcndyaXR0ZW4gdG8gJHtuYW1lfS5gKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmludm9jYXRpb25OYW1lID0gbmFtZTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cblxuICAgIGxvYWRGcm9tRmlsZShpbnB1dFBhdGg6IHN0cmluZyk6IHRoaXMge1xuICAgICAgICBpZiAoIWlucHV0UGF0aCB8fCAhZnMuZXhpc3RzU3luYyhpbnB1dFBhdGgpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0lucHV0IHBhdGggaXMgbm90IHZhbGlkLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gZmV0Y2ggYWxsIGluZm8gZnJvbSBqc29uXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdmFyLXJlcXVpcmVzXG4gICAgICAgIGNvbnN0IGludGVyYWN0aW9uTW9kZWw6IEludGVyYWN0aW9uTW9kZWxTY2hlbWEgPSByZXF1aXJlKGlucHV0UGF0aCkuaW50ZXJhY3Rpb25Nb2RlbDtcbiAgICAgICAgY29uc3QgaW50ZW50czogSW50ZW50W10gPSBpbnRlcmFjdGlvbk1vZGVsLmxhbmd1YWdlTW9kZWwhLmludGVudHMgPyBpbnRlcmFjdGlvbk1vZGVsLmxhbmd1YWdlTW9kZWwhLmludGVudHMgOiBbXTtcbiAgICAgICAgY29uc3Qgc2xvdFR5cGVzOiBTbG90VHlwZVtdID0gaW50ZXJhY3Rpb25Nb2RlbC5sYW5ndWFnZU1vZGVsIS50eXBlcyA/IGludGVyYWN0aW9uTW9kZWwubGFuZ3VhZ2VNb2RlbCEudHlwZXMgOiBbXTtcbiAgICAgICAgY29uc3QgaW52b2NhdGlvbk5hbWU6IHN0cmluZyA9IGludGVyYWN0aW9uTW9kZWwubGFuZ3VhZ2VNb2RlbCEuaW52b2NhdGlvbk5hbWUhO1xuICAgICAgICBjb25zdCBwcm9tcHRzOiBQcm9tcHRbXSA9IGludGVyYWN0aW9uTW9kZWwucHJvbXB0cyA/IGludGVyYWN0aW9uTW9kZWwucHJvbXB0cyA6IFtdO1xuICAgICAgICBjb25zdCBkaWFsb2c6IERpYWxvZyA9IGludGVyYWN0aW9uTW9kZWwuZGlhbG9nID8gaW50ZXJhY3Rpb25Nb2RlbC5kaWFsb2cgOiB7fTtcblxuICAgICAgICBjb25zdCBkaWFsb2dJbnRlbnRzOiBEaWFsb2dJbnRlbnRbXSA9IGRpYWxvZy5pbnRlbnRzID8gZGlhbG9nLmludGVudHMgOiBbXTtcbiAgICAgICAgY29uc3QgZGVsZWdhdGlvblN0cmF0ZWd5OiBEZWxlZ2F0aW9uU3RyYXRlZ3lUeXBlIHwgdW5kZWZpbmVkID0gZGlhbG9nLmRlbGVnYXRpb25TdHJhdGVneTtcblxuICAgICAgICB0aGlzLmFkZEludGVudHMoLi4uaW50ZW50cyk7XG4gICAgICAgIHRoaXMuYWRkT3JNZXJnZVNsb3RUeXBlcyguLi5zbG90VHlwZXMpO1xuICAgICAgICB0aGlzLmFkZERpYWxvZ0ludGVudHMoLi4uZGlhbG9nSW50ZW50cyk7XG4gICAgICAgIGlmIChkZWxlZ2F0aW9uU3RyYXRlZ3kgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5hZGREZWxlZ2F0aW9uU3RyYXRlZ3koZGVsZWdhdGlvblN0cmF0ZWd5KTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmFkZFByb21wdHMoLi4ucHJvbXB0cyk7XG4gICAgICAgIHRoaXMud2l0aEludm9jYXRpb25OYW1lKGludm9jYXRpb25OYW1lKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICBidWlsZCgpOiBJbnRlcmFjdGlvbk1vZGVsRGF0YSB7XG4gICAgICAgIGlmICghdGhpcy5pbnZvY2F0aW9uTmFtZSkge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKCdJbnZvY2F0aW9uIG5hbWUgaXMgbm90IGRlZmluZWQnKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpbnRlcmFjdGlvbk1vZGVsOiBJbnRlcmFjdGlvbk1vZGVsU2NoZW1hID0ge1xuICAgICAgICAgICAgbGFuZ3VhZ2VNb2RlbDoge30sXG4gICAgICAgICAgICBwcm9tcHRzOiBbXVxuICAgICAgICB9O1xuXG4gICAgICAgIGludGVyYWN0aW9uTW9kZWwubGFuZ3VhZ2VNb2RlbCEudHlwZXMgPSB0aGlzLnNsb3RUeXBlcztcbiAgICAgICAgaW50ZXJhY3Rpb25Nb2RlbC5sYW5ndWFnZU1vZGVsIS5pbnRlbnRzID0gdGhpcy5pbnRlbnRzO1xuICAgICAgICBpZiAodGhpcy5kaWFsb2dJbnRlbnRzLmxlbmd0aCA+IDAgfHwgdGhpcy5kZWxlZ2F0aW9uU3RyYXRlZ3kpIHtcbiAgICAgICAgICAgIGludGVyYWN0aW9uTW9kZWwuZGlhbG9nID0ge307XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuZGlhbG9nSW50ZW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBpbnRlcmFjdGlvbk1vZGVsLmRpYWxvZyEuaW50ZW50cyA9IHRoaXMuZGlhbG9nSW50ZW50cztcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5kZWxlZ2F0aW9uU3RyYXRlZ3kpIHtcbiAgICAgICAgICAgIGludGVyYWN0aW9uTW9kZWwuZGlhbG9nIS5kZWxlZ2F0aW9uU3RyYXRlZ3kgPSB0aGlzLmRlbGVnYXRpb25TdHJhdGVneTtcbiAgICAgICAgfVxuICAgICAgICBpbnRlcmFjdGlvbk1vZGVsLnByb21wdHMgPSB0aGlzLnByb21wdHM7XG4gICAgICAgIGludGVyYWN0aW9uTW9kZWwubGFuZ3VhZ2VNb2RlbCEuaW52b2NhdGlvbk5hbWUgPSB0aGlzLmludm9jYXRpb25OYW1lO1xuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpbnRlcmFjdGlvbk1vZGVsLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGJ1aWxkQW5kV3JpdGUoZmlsZU5hbWU6IHN0cmluZykge1xuICAgICAgICBjb25zdCBpbnRlcmFjdGlvbk1vZGVsSnNvbjogc3RyaW5nID0gSlNPTi5zdHJpbmdpZnkodGhpcy5idWlsZCgpLCBudWxsLCAyKTtcbiAgICAgICAgY29uc3QgcGF0aDogc3RyaW5nID0gam9pbihwcm9jZXNzLmN3ZCgpLCBmaWxlTmFtZSk7XG4gICAgICAgIGZzLndyaXRlRmlsZVN5bmMocGF0aCwgaW50ZXJhY3Rpb25Nb2RlbEpzb24pO1xuICAgIH1cblxufVxuXG5mdW5jdGlvbiBtZXJnZVNsb3RUeXBlVmFsdWVzKHNsb3RUeXBlVmFsdWVzOiBUeXBlVmFsdWVbXSB8IHVuZGVmaW5lZCwgbmV3U2xvdFZhbHVlOiBUeXBlVmFsdWUsIHNsb3ROYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIXNsb3RUeXBlVmFsdWVzKSB7XG4gICAgICAgIHNsb3RUeXBlVmFsdWVzID0gW25ld1Nsb3RWYWx1ZV07XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgbWF0Y2hpbmdWYWx1ZSA9IHNsb3RUeXBlVmFsdWVzLmZpbmQodiA9PiB2Lm5hbWU/LnZhbHVlID09PSBuZXdTbG90VmFsdWUubmFtZT8udmFsdWUgfHwgdi5pZCA9PT0gbmV3U2xvdFZhbHVlLmlkKTtcbiAgICBpZiAoIW1hdGNoaW5nVmFsdWUpIHtcbiAgICAgICAgLy8gdmFsdWUgbm90IHlldCBwcmVzZW50IHNvIGp1c3QgcHVzaCBpdFxuICAgICAgICBzbG90VHlwZVZhbHVlcy5wdXNoKG5ld1Nsb3RWYWx1ZSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICAvLyB2YWx1ZSBwcmVzZW50LCBzbyBhZGQgc3lub255bXNcbiAgICAgICAgaWYgKG1hdGNoaW5nVmFsdWUubmFtZT8udmFsdWUgIT09IG5ld1Nsb3RWYWx1ZS5uYW1lPy52YWx1ZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgbWVyZ2Ugc2xvdCB0eXBlICR7c2xvdE5hbWV9LCBhcyB0aGUgdmFsdWUgJHtKU09OLnN0cmluZ2lmeShuZXdTbG90VmFsdWUpfSBhbmQgJHtKU09OLnN0cmluZ2lmeShtYXRjaGluZ1ZhbHVlKX0gaGFzIHRoZSBzYW1lIGlkIGJ1dCBkaWZmZXJlbnQgbmFtZS52YWx1ZS5gKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAobWF0Y2hpbmdWYWx1ZS5pZCAhPT0gbmV3U2xvdFZhbHVlLmlkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBtZXJnZSBzbG90IHR5cGUgJHtzbG90TmFtZX0sIGFzIHRoZSB2YWx1ZSAke0pTT04uc3RyaW5naWZ5KG5ld1Nsb3RWYWx1ZSl9IGFuZCAke0pTT04uc3RyaW5naWZ5KG1hdGNoaW5nVmFsdWUpfSBoYXMgdGhlIHNhbWUgbmFtZS52YWx1ZSBidXQgZGlmZmVyZW50IGlkLmApO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChjb25zdCBzeW5vbnltIG9mIG5ld1Nsb3RWYWx1ZS5uYW1lPy5zeW5vbnltcyA/PyBbXSkge1xuICAgICAgICAgICAgY29uc3QgbWF0Y2hpbmdTeW5vbnltID0gbWF0Y2hpbmdWYWx1ZS5uYW1lPy5zeW5vbnltcz8uZmluZChzID0+IHMgPT09IHN5bm9ueW0pO1xuICAgICAgICAgICAgaWYgKG1hdGNoaW5nU3lub255bSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgLy8gc3lub255bSBub3QgeWV0IHByZXNldCBzbyBqdXN0IHB1c2ggaXRcbiAgICAgICAgICAgICAgICBtYXRjaGluZ1ZhbHVlLm5hbWU/LnN5bm9ueW1zPy5wdXNoKHN5bm9ueW0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuIl19