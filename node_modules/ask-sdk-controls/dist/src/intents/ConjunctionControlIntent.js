"use strict";
/*
 * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConjunctionControlIntent = exports.generateActionTaskPairs = exports.areConjunctionIntentSlotsValid = exports.hasOneOrMoreActions = exports.hasOneOrMoreTargets = exports.unpackConjunctionControlIntent = void 0;
const IntentUtils_1 = require("../utils/IntentUtils");
const ModelTypes_1 = require("../interactionModelGeneration/ModelTypes");
const BaseControlIntent_1 = require("./BaseControlIntent");
function unpackConjunctionControlIntent(intent) {
    if (!intent.name.startsWith('ConjunctionControlIntent')) {
        throw new Error(`Not a compatible intent : ${intent.name}`);
    }
    let feedback;
    let action;
    let target;
    let actionA;
    let targetA;
    let actionB;
    let targetB;
    for (const [name, slot] of Object.entries(intent.slots)) {
        const slotObject = IntentUtils_1.getSlotResolutions(slot);
        const slotValue = slotObject ? slotObject.slotValue : undefined;
        switch (name) {
            case 'feedback':
                feedback = slotValue;
                break;
            case 'action':
                action = slotValue;
                break;
            case 'target':
                target = slotValue;
                break;
            case 'action.a':
                actionA = slotValue;
                break;
            case 'target.a':
                targetA = slotValue;
                break;
            case 'action.b':
                actionB = slotValue;
                break;
            case 'target.b':
                targetB = slotValue;
                break;
            case 'head': break;
            case 'tail': break;
            case 'preposition': break;
            case 'conjunction': break;
            default: throw new Error('not handled');
        }
    }
    return {
        feedback,
        action,
        target,
        'action.a': actionA,
        'target.a': targetA,
        'action.b': actionB,
        'target.b': targetB,
    };
}
exports.unpackConjunctionControlIntent = unpackConjunctionControlIntent;
function hasOneOrMoreTargets(input) {
    if (!input) {
        return false;
    }
    if (input.target !== undefined || input['target.a'] !== undefined || input['target.b'] !== undefined) {
        return true;
    }
    return false;
}
exports.hasOneOrMoreTargets = hasOneOrMoreTargets;
function hasOneOrMoreActions(input) {
    if (!input) {
        return false;
    }
    if (input['action.a'] !== undefined || input['action.b'] !== undefined || input.action !== undefined) {
        return true;
    }
    return false;
}
exports.hasOneOrMoreActions = hasOneOrMoreActions;
function areConjunctionIntentSlotsValid(input) {
    if (!input) {
        return false;
    }
    // priorityRule, when action / target , no actionA, actionB, no targetA, targetB
    if (input.action !== undefined) {
        if (input["action.a"] !== undefined || input["action.b"] !== undefined) {
            return false;
        }
    }
    if (input.target !== undefined) {
        if (input['target.a'] !== undefined || input['target.b'] !== undefined) {
            return false;
        }
    }
    // pairRule, if .a exist, then .b must exist. Vice versa
    if ((input['action.a'] !== undefined && input['action.b'] === undefined) || (input['action.b'] !== undefined && input['action.a'] === undefined)) {
        return false;
    }
    if ((input['target.a'] !== undefined && input['target.b'] === undefined) || (input['target.b'] !== undefined && input['target.a'] === undefined)) {
        return false;
    }
    // when only one target, don't allow two action
    if (input.target !== undefined && input["action.a"] !== undefined && input["action.b"] !== undefined) {
        return false;
    }
    // only target is not allowed
    if (input.action === undefined && input["action.a"] === undefined) {
        return false;
    }
    return true;
}
exports.areConjunctionIntentSlotsValid = areConjunctionIntentSlotsValid;
function generateActionTaskPairs(input) {
    const inputs = [];
    const inputA = {
        action: '',
        target: '',
    };
    const inputB = {
        action: '',
        target: '',
    };
    if (hasOneOrMoreActions(input)) {
        // 1. Action exist
        if (input.action !== undefined) {
            inputA.action = input.action;
            inputB.action = input.action;
        }
        else { // two action
            inputA.action = input['action.a'];
            inputB.action = input['action.b'];
        }
        if (hasOneOrMoreTargets(input)) {
            // 1.1 Target exist
            if (input.target !== undefined) {
                inputA.target = input.target;
                inputB.target = input.target;
            }
            else {
                inputA.target = input['target.a'];
                inputB.target = input['target.b'];
            }
        }
    }
    // remove duplicate
    if (inputA.action === inputB.action && inputA.target === inputB.target) {
        inputs.push(inputA);
    }
    else {
        inputs.push(inputA);
        inputs.push(inputB);
    }
    return inputs;
}
exports.generateActionTaskPairs = generateActionTaskPairs;
class ConjunctionControlIntent extends BaseControlIntent_1.BaseControlIntent {
    static of(slots) {
        return IntentUtils_1.IntentBuilder.of(this.prototype.constructor.name, slots);
    }
    generateIntent() {
        return {
            name: this.name,
            slots: this.generateSlots(),
            samples: []
        };
    }
    generateSlots() {
        const slots = [
            {
                name: 'feedback',
                type: ModelTypes_1.SharedSlotType.FEEDBACK
            },
            {
                name: 'action',
                type: ModelTypes_1.SharedSlotType.ACTION
            },
            {
                name: 'conjunction',
                type: ModelTypes_1.SharedSlotType.CONJUNCTION
            },
            {
                name: 'target.a',
                type: ModelTypes_1.SharedSlotType.TARGET
            },
            {
                name: 'target.b',
                type: ModelTypes_1.SharedSlotType.TARGET
            },
            {
                name: 'head',
                type: ModelTypes_1.SharedSlotType.HEAD
            },
            {
                name: 'tail',
                type: ModelTypes_1.SharedSlotType.TAIL
            }
        ];
        return slots;
    }
    generateSlotTypes() {
        return [];
    }
}
exports.ConjunctionControlIntent = ConjunctionControlIntent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29uanVuY3Rpb25Db250cm9sSW50ZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ludGVudHMvQ29uanVuY3Rpb25Db250cm9sSW50ZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7Ozs7R0FXRzs7O0FBS0gsc0RBQXlFO0FBQ3pFLHlFQUEwRTtBQUMxRSwyREFBd0Q7QUFheEQsU0FBZ0IsOEJBQThCLENBQUMsTUFBYztJQUN6RCxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsMEJBQTBCLENBQUMsRUFBRTtRQUNyRCxNQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztLQUMvRDtJQUVELElBQUksUUFBNEIsQ0FBQztJQUNqQyxJQUFJLE1BQTBCLENBQUM7SUFDL0IsSUFBSSxNQUEwQixDQUFDO0lBQy9CLElBQUksT0FBMkIsQ0FBQztJQUNoQyxJQUFJLE9BQTJCLENBQUM7SUFDaEMsSUFBSSxPQUEyQixDQUFDO0lBQ2hDLElBQUksT0FBMkIsQ0FBQztJQUVoQyxLQUFLLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBTSxDQUFDLEVBQUU7UUFDdEQsTUFBTSxVQUFVLEdBQUcsZ0NBQWtCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUMsTUFBTSxTQUFTLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDaEUsUUFBUSxJQUFJLEVBQUU7WUFDVixLQUFLLFVBQVU7Z0JBQUUsUUFBUSxHQUFHLFNBQVMsQ0FBQztnQkFBQyxNQUFNO1lBQzdDLEtBQUssUUFBUTtnQkFBRSxNQUFNLEdBQUcsU0FBUyxDQUFDO2dCQUFDLE1BQU07WUFDekMsS0FBSyxRQUFRO2dCQUFFLE1BQU0s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RUFBRTtTQUNkLENBQUM7SUFDTixDQUFDO0lBRUQsYUFBYTtRQUNULE1BQU0sS0FBSyxHQUErQztZQUN0RDtnQkFDSSxJQUFJLEVBQUUsVUFBVTtnQkFDaEIsSUFBSSxFQUFFLDJCQUFjLENBQUMsUUFBUTthQUNoQztZQUNEO2dCQUNJLElBQUksRUFBRSxRQUFRO2dCQUNkLElBQUksRUFBRSwyQkFBYyxDQUFDLE1BQU07YUFDOUI7WUFDRDtnQkFDSSxJQUFJLEVBQUUsYUFBYTtnQkFDbkIsSUFBSSxFQUFFLDJCQUFjLENBQUMsV0FBVzthQUNuQztZQUNEO2dCQUNJLElBQUksRUFBRSxVQUFVO2dCQUNoQixJQUFJLEVBQUUsMkJBQWMsQ0FBQyxNQUFNO2FBQzlCO1lBQ0Q7Z0JBQ0ksSUFBSSxFQUFFLFVBQVU7Z0JBQ2hCLElBQUksRUFBRSwyQkFBYyxDQUFDLE1BQU07YUFDOUI7WUFDRDtnQkFDSSxJQUFJLEVBQUUsTUFBTTtnQkFDWixJQUFJLEVBQUUsMkJBQWMsQ0FBQyxJQUFJO2FBQzVCO1lBQ0Q7Z0JBQ0ksSUFBSSxFQUFFLE1BQU07Z0JBQ1osSUFBSSxFQUFFLDJCQUFjLENBQUMsSUFBSTthQUM1QjtTQUNKLENBQUM7UUFFRixPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDO0lBRUQsaUJBQWlCO1FBQ2IsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDO0NBQ0o7QUFwREQsNERBb0RDIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE5IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLlxuICogWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogb3IgaW4gdGhlIFwibGljZW5zZVwiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkXG4gKiBvbiBhbiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXJcbiAqIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nXG4gKiBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0IHsgSW50ZW50IH0gZnJvbSBcImFzay1zZGstbW9kZWxcIjtcbmltcG9ydCB7IHYxIH0gZnJvbSAnYXNrLXNtYXBpLW1vZGVsJztcblxuaW1wb3J0IHsgZ2V0U2xvdFJlc29sdXRpb25zLCBJbnRlbnRCdWlsZGVyIH0gZnJvbSAnLi4vdXRpbHMvSW50ZW50VXRpbHMnO1xuaW1wb3J0IHsgU2hhcmVkU2xvdFR5cGUgfSBmcm9tICcuLi9pbnRlcmFjdGlvbk1vZGVsR2VuZXJhdGlvbi9Nb2RlbFR5cGVzJztcbmltcG9ydCB7IEJhc2VDb250cm9sSW50ZW50IH0gZnJvbSAnLi9CYXNlQ29udHJvbEludGVudCc7XG5pbXBvcnQgU2xvdFR5cGUgPSB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLlNsb3RUeXBlO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbmp1bmN0aW9uQ29udHJvbEludGVudFNsb3RzIHtcbiAgICBmZWVkYmFjaz86IHN0cmluZyxcbiAgICBhY3Rpb24/OiBzdHJpbmcsXG4gICAgdGFyZ2V0Pzogc3RyaW5nLFxuICAgICdhY3Rpb24uYSc/OiBzdHJpbmcsXG4gICAgJ3RhcmdldC5hJz86IHN0cmluZyxcbiAgICAnYWN0aW9uLmInPzogc3RyaW5nLFxuICAgICd0YXJnZXQuYic/OiBzdHJpbmcsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1bnBhY2tDb25qdW5jdGlvbkNvbnRyb2xJbnRlbnQoaW50ZW50OiBJbnRlbnQpOiBDb25qdW5jdGlvbkNvbnRyb2xJbnRlbnRTbG90cyB7XG4gICAgaWYgKCFpbnRlbnQubmFtZS5zdGFydHNXaXRoKCdDb25qdW5jdGlvbkNvbnRyb2xJbnRlbnQnKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vdCBhIGNvbXBhdGlibGUgaW50ZW50IDogJHtpbnRlbnQubmFtZX1gKTtcbiAgICB9XG5cbiAgICBsZXQgZmVlZGJhY2s6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBsZXQgYWN0aW9uOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgbGV0IHRhcmdldDogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGxldCBhY3Rpb25BOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gICAgbGV0IHRhcmdldEE6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBsZXQgYWN0aW9uQjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGxldCB0YXJnZXRCOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG5cbiAgICBmb3IgKGNvbnN0IFtuYW1lLCBzbG90XSBvZiBPYmplY3QuZW50cmllcyhpbnRlbnQuc2xvdHMhKSkge1xuICAgICAgICBjb25zdCBzbG90T2JqZWN0ID0gZ2V0U2xvdFJlc29sdXRpb25zKHNsb3QpO1xuICAgICAgICBjb25zdCBzbG90VmFsdWUgPSBzbG90T2JqZWN0ID8gc2xvdE9iamVjdC5zbG90VmFsdWUgOiB1bmRlZmluZWQ7XG4gICAgICAgIHN3aXRjaCAobmFtZSkge1xuICAgICAgICAgICAgY2FzZSAnZmVlZGJhY2snOiBmZWVkYmFjayA9IHNsb3RWYWx1ZTsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdhY3Rpb24nOiBhY3Rpb24gPSBzbG90VmFsdWU7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAndGFyZ2V0JzogdGFyZ2V0ID0gc2xvdFZhbHVlOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2FjdGlvbi5hJzogYWN0aW9uQSA9IHNsb3RWYWx1ZTsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICd0YXJnZXQuYSc6IHRhcmdldEEgPSBzbG90VmFsdWU7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnYWN0aW9uLmInOiBhY3Rpb25CID0gc2xvdFZhbHVlOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3RhcmdldC5iJzogdGFyZ2V0QiA9IHNsb3RWYWx1ZTsgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgJ2hlYWQnOiBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3RhaWwnOiBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ3ByZXBvc2l0aW9uJzogYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdjb25qdW5jdGlvbic6IGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDogdGhyb3cgbmV3IEVycm9yKCdub3QgaGFuZGxlZCcpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgICAgZmVlZGJhY2ssXG4gICAgICAgIGFjdGlvbixcbiAgICAgICAgdGFyZ2V0LFxuICAgICAgICAnYWN0aW9uLmEnOiBhY3Rpb25BLFxuICAgICAgICAndGFyZ2V0LmEnOiB0YXJnZXRBLFxuICAgICAgICAnYWN0aW9uLmInOiBhY3Rpb25CLFxuICAgICAgICAndGFyZ2V0LmInOiB0YXJnZXRCLFxuICAgIH07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNPbmVPck1vcmVUYXJnZXRzKGlucHV0OiBDb25qdW5jdGlvbkNvbnRyb2xJbnRlbnRTbG90cyB8IG51bGwpOiBib29sZWFuIHtcbiAgICBpZiAoIWlucHV0KSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKGlucHV0LnRhcmdldCAhPT0gdW5kZWZpbmVkIHx8IGlucHV0Wyd0YXJnZXQuYSddICE9PSB1bmRlZmluZWQgfHwgaW5wdXRbJ3RhcmdldC5iJ10gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG5cbmV4cG9ydCBmdW5jdGlvbiBoYXNPbmVPck1vcmVBY3Rpb25zKGlucHV0OiBDb25qdW5jdGlvbkNvbnRyb2xJbnRlbnRTbG90cyB8IG51bGwpOiBib29sZWFuIHtcbiAgICBpZiAoIWlucHV0KSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgaWYgKGlucHV0WydhY3Rpb24uYSddICE9PSB1bmRlZmluZWQgfHwgaW5wdXRbJ2FjdGlvbi5iJ10gIT09IHVuZGVmaW5lZCB8fCBpbnB1dC5hY3Rpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXJlQ29uanVuY3Rpb25JbnRlbnRTbG90c1ZhbGlkKGlucHV0OiBDb25qdW5jdGlvbkNvbnRyb2xJbnRlbnRTbG90cyB8IG51bGwpOiBib29sZWFuIHtcbiAgICBpZiAoIWlucHV0KSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgLy8gcHJpb3JpdHlSdWxlLCB3aGVuIGFjdGlvbiAvIHRhcmdldCAsIG5vIGFjdGlvbkEsIGFjdGlvbkIsIG5vIHRhcmdldEEsIHRhcmdldEJcbiAgICBpZiAoaW5wdXQuYWN0aW9uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKGlucHV0W1wiYWN0aW9uLmFcIl0gIT09IHVuZGVmaW5lZCB8fCBpbnB1dFtcImFjdGlvbi5iXCJdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBpZiAoaW5wdXQudGFyZ2V0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaWYgKGlucHV0Wyd0YXJnZXQuYSddICE9PSB1bmRlZmluZWQgfHwgaW5wdXRbJ3RhcmdldC5iJ10gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gcGFpclJ1bGUsIGlmIC5hIGV4aXN0LCB0aGVuIC5iIG11c3QgZXhpc3QuIFZpY2UgdmVyc2FcbiAgICBpZiAoKGlucHV0WydhY3Rpb24uYSddICE9PSB1bmRlZmluZWQgJiYgaW5wdXRbJ2FjdGlvbi5iJ10gPT09IHVuZGVmaW5lZCkgfHwgKGlucHV0WydhY3Rpb24uYiddICE9PSB1bmRlZmluZWQgJiYgaW5wdXRbJ2FjdGlvbi5hJ10gPT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoKGlucHV0Wyd0YXJnZXQuYSddICE9PSB1bmRlZmluZWQgJiYgaW5wdXRbJ3RhcmdldC5iJ10gPT09IHVuZGVmaW5lZCkgfHwgKGlucHV0Wyd0YXJnZXQuYiddICE9PSB1bmRlZmluZWQgJiYgaW5wdXRbJ3RhcmdldC5hJ10gPT09IHVuZGVmaW5lZCkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIHdoZW4gb25seSBvbmUgdGFyZ2V0LCBkb24ndCBhbGxvdyB0d28gYWN0aW9uXG4gICAgaWYgKGlucHV0LnRhcmdldCAhPT0gdW5kZWZpbmVkICYmIGlucHV0W1wiYWN0aW9uLmFcIl0gIT09IHVuZGVmaW5lZCAmJiBpbnB1dFtcImFjdGlvbi5iXCJdICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIG9ubHkgdGFyZ2V0IGlzIG5vdCBhbGxvd2VkXG4gICAgaWYgKGlucHV0LmFjdGlvbiA9PT0gdW5kZWZpbmVkICYmIGlucHV0W1wiYWN0aW9uLmFcIl0gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWN0aW9uQW5kVGFzayB7XG4gICAgYWN0aW9uOiBzdHJpbmcsXG4gICAgdGFyZ2V0OiBzdHJpbmcsXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZUFjdGlvblRhc2tQYWlycyhpbnB1dDogQ29uanVuY3Rpb25Db250cm9sSW50ZW50U2xvdHMpOiBBY3Rpb25BbmRUYXNrW10ge1xuICAgIGNvbnN0IGlucHV0czogQWN0aW9uQW5kVGFza1tdID0gW107XG4gICAgY29uc3QgaW5wdXRBOiBBY3Rpb25BbmRUYXNrID0ge1xuICAgICAgICBhY3Rpb246ICcnLFxuICAgICAgICB0YXJnZXQ6ICcnLFxuICAgIH07XG5cbiAgICBjb25zdCBpbnB1dEI6IEFjdGlvbkFuZFRhc2sgPSB7XG4gICAgICAgIGFjdGlvbjogJycsXG4gICAgICAgIHRhcmdldDogJycsXG4gICAgfTtcblxuICAgIGlmIChoYXNPbmVPck1vcmVBY3Rpb25zKGlucHV0KSkge1xuICAgICAgICAvLyAxLiBBY3Rpb24gZXhpc3RcbiAgICAgICAgaWYgKGlucHV0LmFjdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBpbnB1dEEuYWN0aW9uID0gaW5wdXQuYWN0aW9uO1xuICAgICAgICAgICAgaW5wdXRCLmFjdGlvbiA9IGlucHV0LmFjdGlvbjtcbiAgICAgICAgfSBlbHNlIHsgLy8gdHdvIGFjdGlvblxuICAgICAgICAgICAgaW5wdXRBLmFjdGlvbiA9IGlucHV0WydhY3Rpb24uYSddITtcbiAgICAgICAgICAgIGlucHV0Qi5hY3Rpb24gPSBpbnB1dFsnYWN0aW9uLmInXSE7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGhhc09uZU9yTW9yZVRhcmdldHMoaW5wdXQpKSB7XG4gICAgICAgICAgICAvLyAxLjEgVGFyZ2V0IGV4aXN0XG4gICAgICAgICAgICBpZiAoaW5wdXQudGFyZ2V0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICBpbnB1dEEudGFyZ2V0ID0gaW5wdXQudGFyZ2V0O1xuICAgICAgICAgICAgICAgIGlucHV0Qi50YXJnZXQgPSBpbnB1dC50YXJnZXQ7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlucHV0QS50YXJnZXQgPSBpbnB1dFsndGFyZ2V0LmEnXSE7XG4gICAgICAgICAgICAgICAgaW5wdXRCLnRhcmdldCA9IGlucHV0Wyd0YXJnZXQuYiddITtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgfVxuICAgIC8vIHJlbW92ZSBkdXBsaWNhdGVcbiAgICBpZiAoaW5wdXRBLmFjdGlvbiA9PT0gaW5wdXRCLmFjdGlvbiAmJiBpbnB1dEEudGFyZ2V0ID09PSBpbnB1dEIudGFyZ2V0KSB7XG4gICAgICAgIGlucHV0cy5wdXNoKGlucHV0QSk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgaW5wdXRzLnB1c2goaW5wdXRBKTtcbiAgICAgICAgaW5wdXRzLnB1c2goaW5wdXRCKTtcbiAgICB9XG5cbiAgICByZXR1cm4gaW5wdXRzO1xufVxuXG5leHBvcnQgY2xhc3MgQ29uanVuY3Rpb25Db250cm9sSW50ZW50IGV4dGVuZHMgQmFzZUNvbnRyb2xJbnRlbnQge1xuXG4gICAgc3RhdGljIG9mKHNsb3RzOiBDb25qdW5jdGlvbkNvbnRyb2xJbnRlbnRTbG90cyk6IEludGVudCB7XG4gICAgICAgIHJldHVybiBJbnRlbnRCdWlsZGVyLm9mKHRoaXMucHJvdG90eXBlLmNvbnN0cnVjdG9yLm5hbWUsIHNsb3RzKTtcbiAgICB9XG5cbiAgICBnZW5lcmF0ZUludGVudCgpOiB2MS5za2lsbC5pbnRlcmFjdGlvbk1vZGVsLkludGVudCB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgICAgICBzbG90czogdGhpcy5nZW5lcmF0ZVNsb3RzKCksXG4gICAgICAgICAgICBzYW1wbGVzOiBbXVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGdlbmVyYXRlU2xvdHMoKTogdjEuc2tpbGwuaW50ZXJhY3Rpb25Nb2RlbC5TbG90RGVmaW5pdGlvbltdIHtcbiAgICAgICAgY29uc3Qgc2xvdHM6IHYxLnNraWxsLmludGVyYWN0aW9uTW9kZWwuU2xvdERlZmluaXRpb25bXSA9IFtcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnZmVlZGJhY2snLFxuICAgICAgICAgICAgICAgIHR5cGU6IFNoYXJlZFNsb3RUeXBlLkZFRURCQUNLXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG5hbWU6ICdhY3Rpb24nLFxuICAgICAgICAgICAgICAgIHR5cGU6IFNoYXJlZFNsb3RUeXBlLkFDVElPTlxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnY29uanVuY3Rpb24nLFxuICAgICAgICAgICAgICAgIHR5cGU6IFNoYXJlZFNsb3RUeXBlLkNPTkpVTkNUSU9OXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG5hbWU6ICd0YXJnZXQuYScsXG4gICAgICAgICAgICAgICAgdHlwZTogU2hhcmVkU2xvdFR5cGUuVEFSR0VUXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG5hbWU6ICd0YXJnZXQuYicsXG4gICAgICAgICAgICAgICAgdHlwZTogU2hhcmVkU2xvdFR5cGUuVEFSR0VUXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG5hbWU6ICdoZWFkJyxcbiAgICAgICAgICAgICAgICB0eXBlOiBTaGFyZWRTbG90VHlwZS5IRUFEXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG5hbWU6ICd0YWlsJyxcbiAgICAgICAgICAgICAgICB0eXBlOiBTaGFyZWRTbG90VHlwZS5UQUlMXG4gICAgICAgICAgICB9XG4gICAgICAgIF07XG5cbiAgICAgICAgcmV0dXJuIHNsb3RzO1xuICAgIH1cblxuICAgIGdlbmVyYXRlU2xvdFR5cGVzKCk6IFNsb3RUeXBlW10ge1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxufSJdfQ==