"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.VariableControlsManager = exports.MyMultiControl = exports.MyMultiControlState = void 0;
/*
 * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License").
 * You may not use this file except in compliance with the License.
 * A copy of the License is located at
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * or in the "license" file accompanying this file. This file is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
 * express or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */
const chai_1 = require("chai");
const mocha_1 = require("mocha");
const src_1 = require("../src");
const ContainerControl_1 = require("../src/controls/ContainerControl");
const ControlManager_1 = require("../src/controls/ControlManager");
const GeneralControlIntent_1 = require("../src/intents/GeneralControlIntent");
const ControlHandler_1 = require("../src/runtime/ControlHandler");
const ArrayUtils_1 = require("../src/utils/ArrayUtils");
const SkillInvoker_1 = require("../src/utils/testSupport/SkillInvoker");
const SkillWrapper_1 = require("../src/utils/testSupport/SkillWrapper");
const TestingUtils_1 = require("../src/utils/testSupport/TestingUtils");
TestingUtils_1.waitForDebugger();
/**
 * An example of a container than manages a variable number of child controls.
 */
mocha_1.suite("== dynamic controls ==", () => {
    mocha_1.test("e2e", async () => {
        let response;
        const requestHandler = new ControlHandler_1.ControlHandler(new VariableControlsManager());
        const skill = new SkillInvoker_1.SkillInvoker(SkillWrapper_1.wrapRequestHandlerAsSkill(requestHandler));
        // Note: this test demonstrates SkillInvoker.invoke() directly to observe all the surface form details of the response.
        response = await skill.invoke(TestingUtils_1.TestInput.of(GeneralControlIntent_1.GeneralControlIntent.of({ action: "set" }))); // TODO: Update tests to better demonstrate dynamic trees support.
        chai_1.expect(response.prompt).equals("I have 1 child control. What value for number 1?");
        response = await skill.invoke(TestingUtils_1.TestInput.of(GeneralControlIntent_1.GeneralControlIntent.of({ action: "addAnother" })));
        chai_1.expect(response.prompt).equals("I have 2 child controls. What value for number 1?");
        response = await skill.invoke(TestingUtils_1.TestInput.of(src_1.SingleValueControlIntent.of('CUSTOM.name', { 'CUSTOM.name': 'bob' })));
        chai_1.expect(response.prompt).equals("OK. I have 2 child controls. What value for number 2?");
        response = await skill.invoke(TestingUtils_1.TestInput.of(src_1.SingleValueControlIntent.of('CUSTOM.name', { 'CUSTOM.name': 'frank' })));
        chai_1.expect(response.prompt).equals("OK. I have 2 child controls.");
        chai_1.expect(response.reprompt).equals("OK. I have 2 child controls.");
    });
});
class MyMultiControlState extends ContainerControl_1.ContainerControlState {
}
exports.MyMultiControlState = MyMultiControlState;
class MyMultiControl extends ContainerControl_1.ContainerControl {
    constructor(props, initialState) {
        super(props);
        this.state = initialState !== null && initialState !== void 0 ? initialState : new MyMultiControlState();
    }
    async canHandle(input) {
        const request = input.request;
        if (request.type !== 'IntentRequest') {
            return false;
        }
        const intent = request.intent;
        const unpacked = (intent.name === 'GeneralControlIntent')
            ? GeneralControlIntent_1.unpackGeneralControlIntent(intent)
            : src_1.unpackSingleValueControlIntent(intent);
        if (unpacked.action === 'addAnother') {
            return true;
        }
        return this.canHandleByChild(input);
    }
    async handle(input, resultBuilder) {
        const request = input.request;
        if (request.type !== 'IntentRequest') {
            throw new Error();
        }
        const intent = request.intent;
        const unpacked = (intent.name === 'GeneralControlIntent')
            ? GeneralControlIntent_1.unpackGeneralControlIntent(intent)
            : src_1.unpackSingleValueControlIntent(intent);
        /*
         * Special behavior #1: Always include the content act to state how many controls we currently have.
         * Special behavior #2: If the action is addAnother, then handle it directly
         * Default behavior: do the usual containerControl handling. and merge with Special behavior #1.
         */
        if (unpacked.action === 'addAnother') {
            this.state.count = this.state.count + 1;
            resultBuilder.addAct(this.createContentAct(this.state.count));
            this.children.push(MyMultiControl.makeValueControl(this.state.count));
            return;
        }
        resultBuilder.addAct(this.createContentAct(this.state.count));
        await this.handleByChild(input, resultBuilder);
        /*
         * [1] Because handleByChild can produce multiple acts, after the merge we may end up with a strange ordering
         * .. so we detect it and fix it.
         *     [ contentAct, valueSetAct, <initiativeAct> ]
         *        ^-- reorder these --^
         */
        if (resultBuilder.acts[0] instanceof src_1.LiteralContentAct && resultBuilder.acts[1] instanceof src_1.ValueSetAct) {
            ArrayUtils_1.moveArrayItem(resultBuilder.acts, 1, 0);
        }
        return;
    }
    createContentAct(count) {
        return new src_1.LiteralContentAct(this, { promptFragment: `I have ${count} child control${count === 1 ? '' : 's'}.` });
    }
    static makeValueControl(index) {
        return new MyValueControl({
            id: `value${index.toString()}`,
            slotType: 'CUSTOM.name',
            prompts: {
                requestValue: act => `What value for number ${act.control.index}?`,
                valueSet: 'OK.'
            },
            reprompts: {
                requestValue: act => `What value for number ${act.control.index}?`,
                valueSet: 'OK.'
            },
            interactionModel: { targets: ['name'] },
            index
        });
    }
}
exports.MyMultiControl = MyMultiControl;
class VariableControlsManager extends ControlManager_1.ControlManager {
    createControlTree(state) {
        const controlCount = state.multiValueContainer !== undefined ? state.multiValueContainer.count !== undefined ? state.multiValueContainer.count : 1 : 1;
        const topControl = new MyMultiControl({ id: 'multiValueContainer' }, { count: 1 });
        for (let i = 1; i <= controlCount; i++) {
            topControl.addChild(MyMultiControl.makeValueControl(i));
        }
        return topControl;
    }
}
exports.VariableControlsManager = VariableControlsManager;
class MyValueControlState extends src_1.ValueControlState {
}
class MyValueControl extends src_1.ValueControl {
    constructor(props) {
        super(props);
        this.index = props.index;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1pY19jb250cm9scy5zcGVjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdGVzdC9keW5hbWljX2NvbnRyb2xzLnNwZWMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7QUFDSCwrQkFBOEI7QUFDOUIsaUNBQW9DO0FBQ3BDLGdDQUFzSztBQUV0Syx1RUFBMkY7QUFHM0YsbUVBQWdFO0FBRWhFLDhFQUF1RztBQUN2RyxrRUFBK0Q7QUFDL0Qsd0RBQXdEO0FBQ3hELHdFQUFxRTtBQUNyRSx3RUFBa0Y7QUFDbEYsd0VBQW1GO0FBR25GLDhCQUFlLEVBQUUsQ0FBQztBQUVsQjs7R0FFRztBQUNILGFBQUssQ0FBQyx3QkFBd0IsRUFBRSxHQUFHLEVBQUU7SUFDakMsWUFBSSxDQUFDLEtBQUssRUFBRSxLQUFLLElBQUksRUFBRTtRQUNuQixJQUFJLFFBQVEsQ0FBQztRQUViLE1BQU0sY0FBYyxHQUFHLElBQUksK0JBQWMsQ0FBQyxJQUFJLHVCQUF1QixFQUFFLENBQUMsQ0FBQztRQUN6RSxNQUFNLEtBQUssR0FBRyxJQUFJLDJCQUFZLENBQUMsd0NBQXlCLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQztRQUUxRSx1SEFBdUg7UUFFdkgsUUFBUSxHQUFHLE1BQU0sS0FBSyxDQUFDLE1BQU0sQ0FBQyx3QkFBUyxDQUFDLEVBQUUsQ0FBQywyQ0FBb0IsQ0FBQyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxrRUFBa0U7UUFDMUosYUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsa0RBQWtELENBQUMsQ0FBQztRQUVuRixRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsTUFBTSxDQUFDLHdCQUFTLENBQUMsRUFBRSxDQUFDLDJDQUFvQixDQUFDLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvRixhQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxtREFBbUQsQ0FBQyxDQUFDO1FBRXBGLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxNQUFNLENBQUMsd0JBQVMsQ0FBQyxFQUFFLENBQUMsOEJBQXdCLENBQUMsRUFBRSxDQUFDLGFBQWEsRUFBRSxFQUFFLGFBQWEsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsSCxhQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyx1REFBdUQsQ0FBQyxDQUFDO1FBRXhGLFFBQVEsR0FBRyxNQUFNLEtBQUssQ0FBQyxNQUFNLENBQUMsd0JBQVMsQ0FBQyxFQUFFLENBQUMsOEJBQXdCLENBQUMsRUFBRSxDQUFDLGFBQWEsRUFBRSxFQUFFLGFBQWEsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwSCxhQUFNLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1FBQy9ELGFBQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLDhCQUE4QixDQUFDLENBQUM7SUFDckUsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQztBQUVILE1BQWEsbUJBQW9CLFNBQVEsd0NBQXFCO0NBRTdEO0FBRkQsa0RBRUM7QUFFRCxNQUFhLGNBQWUsU0FBUSxtQ0FBZ0I7SUFJaEQsWUFBWSxLQUFxQixFQUFFLFlBQWtDO1FBQ2pFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNiLElBQUksQ0FBQyxLQUFLLEdBQUcsWUFBWSxhQUFaLFlBQVksY0FBWixZQUFZLEdBQUksSUFBSSxtQkFBbUIsRUFBRSxDQUFDO0lBQzNELENBQUM7SUFFRCxLQUFLLENBQUMsU0FBUyxDQUFDLEtBQW1CO1FBQy9CLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7UUFDOUIsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLGVBQWUsRUFBRTtZQUNsQyxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUNELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFFOUIsTUFBTSxRQUFRLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLHNCQUFzQixDQUFDO1lBQ3JELENBQUMsQ0FBQyxpREFBMEIsQ0FBQyxNQUFNLENBQUM7WUFDcEMsQ0FBQyxDQUFDLG9DQUE4QixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTdDLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxZQUFZLEVBQUU7WUFDbEMsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUVELE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQW1CLEVBQUUsYUFBbUM7UUFDakUsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztRQUM5QixJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssZUFBZSxFQUFFO1lBQ2xDLE1BQU0sSUFBSSxLQUFLLEVBQUUsQ0FBQztTQUNyQjtRQUNELE1BQU0sTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFDOUIsTUFBTSxRQUFRLEdBQUcsQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLHNCQUFzQixDQUFDO1lBQ3JELENBQUMsQ0FBQyxpREFBMEIsQ0FBQyxNQUFNLENBQUM7WUFDcEMsQ0FBQyxDQUFDLG9DQUE4QixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTdDOzs7O1dBSUc7UUFFSCxJQUFJLFFBQVEsQ0FBQyxNQUFNLEtBQUssWUFBWSxFQUFFO1lBQ2xDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQztZQUN4QyxhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7WUFDOUQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUN0RSxPQUFPO1NBQ1Y7UUFFRCxhQUFhLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDOUQsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxhQUFhLENBQUMsQ0FBQztRQUUvQzs7Ozs7V0FLRztRQUNILElBQUksYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsWUFBWSx1QkFBaUIsSUFBSSxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxZQUFZLGlCQUFXLEVBQUU7WUFDcEcsMEJBQWEsQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUMzQztRQUVELE9BQU87SUFDWCxDQUFDO0lBRUQsZ0JBQWdCLENBQUMsS0FBYTtRQUMxQixPQUFPLElBQUksdUJBQWlCLENBQUMsSUFBSSxFQUFFLEVBQUMsY0FBYyxFQUFFLFVBQVUsS0FBSyxpQkFBaUIsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsRUFBQyxDQUFDLENBQUM7SUFDcEgsQ0FBQztJQUVNLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFhO1FBQ3hDLE9BQU8sSUFBSSxjQUFjLENBQUM7WUFDdEIsRUFBRSxFQUFFLFFBQVEsS0FBSyxDQUFDLFFBQVEsRUFBRSxFQUFFO1lBQzlCLFFBQVEsRUFBRSxhQUFhO1lBQ3ZCLE9BQU8sRUFBRTtnQkFDTCxZQUFZLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyx5QkFBMEIsR0FBRyxDQUFDLE9BQTBCLENBQUMsS0FBSyxHQUFHO2dCQUN0RixRQUFRLEVBQUUsS0FBSzthQUNsQjtZQUNELFNBQVMsRUFBRTtnQkFDUCxZQUFZLEVBQUUsR0FBRyxDQUFDLEVBQUUsQ0FBQyx5QkFBMEIsR0FBRyxDQUFDLE9BQTBCLENBQUMsS0FBSyxHQUFHO2dCQUN0RixRQUFRLEVBQUUsS0FBSzthQUNsQjtZQUNELGdCQUFnQixFQUFFLEVBQUUsT0FBTyxFQUFFLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDdkMsS0FBSztTQUNSLENBQUMsQ0FBQztJQUNQLENBQUM7Q0FDSjtBQXRGRCx3Q0FzRkM7QUFFRCxNQUFhLHVCQUF3QixTQUFRLCtCQUFjO0lBRWhELGlCQUFpQixDQUFDLEtBQVU7UUFFL0IsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLG1CQUFtQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZKLE1BQU0sVUFBVSxHQUFHLElBQUksY0FBYyxDQUNqQyxFQUFFLEVBQUUsRUFBRSxxQkFBcUIsRUFBRSxFQUM3QixFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FDZixDQUFDO1FBRUYsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLFlBQVksRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNwQyxVQUFVLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQzNEO1FBRUQsT0FBTyxVQUFVLENBQUM7SUFDdEIsQ0FBQztDQUVKO0FBakJELDBEQWlCQztBQVFELE1BQU0sbUJBQW9CLFNBQVEsdUJBQWlCO0NBRWxEO0FBRUQsTUFBTSxjQUFlLFNBQVEsa0JBQVk7SUFLckMsWUFBWSxLQUEwQjtRQUNsQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDYixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUM7SUFDN0IsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIENvcHlyaWdodCAyMDE5IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLlxuICogWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogb3IgaW4gdGhlIFwibGljZW5zZVwiIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkXG4gKiBvbiBhbiBcIkFTIElTXCIgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXJcbiAqIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nXG4gKiBwZXJtaXNzaW9ucyBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cbmltcG9ydCB7IGV4cGVjdCB9IGZyb20gXCJjaGFpXCI7XG5pbXBvcnQgeyBzdWl0ZSwgdGVzdCB9IGZyb20gXCJtb2NoYVwiO1xuaW1wb3J0IHsgTGl0ZXJhbENvbnRlbnRBY3QsIFNpbmdsZVZhbHVlQ29udHJvbEludGVudCwgdW5wYWNrU2luZ2xlVmFsdWVDb250cm9sSW50ZW50LCBWYWx1ZUNvbnRyb2wsIFZhbHVlQ29udHJvbFByb3BzLCBWYWx1ZUNvbnRyb2xTdGF0ZSwgVmFsdWVTZXRBY3QgfSBmcm9tICcuLi9zcmMnO1xuaW1wb3J0IHsgU3RyaW5ncyBhcyAkIH0gZnJvbSBcIi4uL3NyYy9jb25zdGFudHMvU3RyaW5nc1wiO1xuaW1wb3J0IHsgQ29udGFpbmVyQ29udHJvbCwgQ29udGFpbmVyQ29udHJvbFN0YXRlIH0gZnJvbSAnLi4vc3JjL2NvbnRyb2xzL0NvbnRhaW5lckNvbnRyb2wnO1xuaW1wb3J0IHsgQ29udHJvbCB9IGZyb20gJy4uL3NyYy9jb250cm9scy9Db250cm9sJztcbmltcG9ydCB7IENvbnRyb2xJbnB1dCB9IGZyb20gJy4uL3NyYy9jb250cm9scy9Db250cm9sSW5wdXQnO1xuaW1wb3J0IHsgQ29udHJvbE1hbmFnZXIgfSBmcm9tICcuLi9zcmMvY29udHJvbHMvQ29udHJvbE1hbmFnZXInO1xuaW1wb3J0IHsgQ29udHJvbFJlc3VsdEJ1aWxkZXIgfSBmcm9tICcuLi9zcmMvY29udHJvbHMvQ29udHJvbFJlc3VsdCc7XG5pbXBvcnQgeyBHZW5lcmFsQ29udHJvbEludGVudCwgdW5wYWNrR2VuZXJhbENvbnRyb2xJbnRlbnQgfSBmcm9tICcuLi9zcmMvaW50ZW50cy9HZW5lcmFsQ29udHJvbEludGVudCc7XG5pbXBvcnQgeyBDb250cm9sSGFuZGxlciB9IGZyb20gJy4uL3NyYy9ydW50aW1lL0NvbnRyb2xIYW5kbGVyJztcbmltcG9ydCB7IG1vdmVBcnJheUl0ZW0gfSBmcm9tICcuLi9zcmMvdXRpbHMvQXJyYXlVdGlscyc7XG5pbXBvcnQgeyBTa2lsbEludm9rZXIgfSBmcm9tICcuLi9zcmMvdXRpbHMvdGVzdFN1cHBvcnQvU2tpbGxJbnZva2VyJztcbmltcG9ydCB7IHdyYXBSZXF1ZXN0SGFuZGxlckFzU2tpbGwgfSBmcm9tICcuLi9zcmMvdXRpbHMvdGVzdFN1cHBvcnQvU2tpbGxXcmFwcGVyJztcbmltcG9ydCB7IFRlc3RJbnB1dCwgd2FpdEZvckRlYnVnZ2VyIH0gZnJvbSAnLi4vc3JjL3V0aWxzL3Rlc3RTdXBwb3J0L1Rlc3RpbmdVdGlscyc7XG5cblxud2FpdEZvckRlYnVnZ2VyKCk7XG5cbi8qKlxuICogQW4gZXhhbXBsZSBvZiBhIGNvbnRhaW5lciB0aGFuIG1hbmFnZXMgYSB2YXJpYWJsZSBudW1iZXIgb2YgY2hpbGQgY29udHJvbHMuXG4gKi9cbnN1aXRlKFwiPT0gZHluYW1pYyBjb250cm9scyA9PVwiLCAoKSA9PiB7XG4gICAgdGVzdChcImUyZVwiLCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCByZXNwb25zZTtcblxuICAgICAgICBjb25zdCByZXF1ZXN0SGFuZGxlciA9IG5ldyBDb250cm9sSGFuZGxlcihuZXcgVmFyaWFibGVDb250cm9sc01hbmFnZXIoKSk7XG4gICAgICAgIGNvbnN0IHNraWxsID0gbmV3IFNraWxsSW52b2tlcih3cmFwUmVxdWVzdEhhbmRsZXJBc1NraWxsKHJlcXVlc3RIYW5kbGVyKSk7XG5cbiAgICAgICAgLy8gTm90ZTogdGhpcyB0ZXN0IGRlbW9uc3RyYXRlcyBTa2lsbEludm9rZXIuaW52b2tlKCkgZGlyZWN0bHkgdG8gb2JzZXJ2ZSBhbGwgdGhlIHN1cmZhY2UgZm9ybSBkZXRhaWxzIG9mIHRoZSByZXNwb25zZS5cblxuICAgICAgICByZXNwb25zZSA9IGF3YWl0IHNraWxsLmludm9rZShUZXN0SW5wdXQub2YoR2VuZXJhbENvbnRyb2xJbnRlbnQub2YoeyBhY3Rpb246IFwic2V0XCJ9KSkpOyAvLyBUT0RPOiBVcGRhdGUgdGVzdHMgdG8gYmV0dGVyIGRlbW9uc3RyYXRlIGR5bmFtaWMgdHJlZXMgc3VwcG9ydC5cbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnByb21wdCkuZXF1YWxzKFwiSSBoYXZlIDEgY2hpbGQgY29udHJvbC4gV2hhdCB2YWx1ZSBmb3IgbnVtYmVyIDE/XCIpO1xuXG4gICAgICAgIHJlc3BvbnNlID0gYXdhaXQgc2tpbGwuaW52b2tlKFRlc3RJbnB1dC5vZihHZW5lcmFsQ29udHJvbEludGVudC5vZih7IGFjdGlvbjogXCJhZGRBbm90aGVyXCIgfSkpKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnByb21wdCkuZXF1YWxzKFwiSSBoYXZlIDIgY2hpbGQgY29udHJvbHMuIFdoYXQgdmFsdWUgZm9yIG51bWJlciAxP1wiKTtcblxuICAgICAgICByZXNwb25zZSA9IGF3YWl0IHNraWxsLmludm9rZShUZXN0SW5wdXQub2YoU2luZ2xlVmFsdWVDb250cm9sSW50ZW50Lm9mKCdDVVNUT00ubmFtZScsIHsgJ0NVU1RPTS5uYW1lJzogJ2JvYicgfSkpKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnByb21wdCkuZXF1YWxzKFwiT0suIEkgaGF2ZSAyIGNoaWxkIGNvbnRyb2xzLiBXaGF0IHZhbHVlIGZvciBudW1iZXIgMj9cIik7XG5cbiAgICAgICAgcmVzcG9uc2UgPSBhd2FpdCBza2lsbC5pbnZva2UoVGVzdElucHV0Lm9mKFNpbmdsZVZhbHVlQ29udHJvbEludGVudC5vZignQ1VTVE9NLm5hbWUnLCB7ICdDVVNUT00ubmFtZSc6ICdmcmFuaycgfSkpKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnByb21wdCkuZXF1YWxzKFwiT0suIEkgaGF2ZSAyIGNoaWxkIGNvbnRyb2xzLlwiKTtcbiAgICAgICAgZXhwZWN0KHJlc3BvbnNlLnJlcHJvbXB0KS5lcXVhbHMoXCJPSy4gSSBoYXZlIDIgY2hpbGQgY29udHJvbHMuXCIpO1xuICAgIH0pO1xufSk7XG5cbmV4cG9ydCBjbGFzcyBNeU11bHRpQ29udHJvbFN0YXRlIGV4dGVuZHMgQ29udGFpbmVyQ29udHJvbFN0YXRlIHtcbiAgICBjb3VudDogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgTXlNdWx0aUNvbnRyb2wgZXh0ZW5kcyBDb250YWluZXJDb250cm9sIHtcblxuICAgIHN0YXRlOiBNeU11bHRpQ29udHJvbFN0YXRlO1xuXG4gICAgY29uc3RydWN0b3IocHJvcHM6IHsgaWQ6IHN0cmluZyB9LCBpbml0aWFsU3RhdGU/OiBNeU11bHRpQ29udHJvbFN0YXRlKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgdGhpcy5zdGF0ZSA9IGluaXRpYWxTdGF0ZSA/PyBuZXcgTXlNdWx0aUNvbnRyb2xTdGF0ZSgpO1xuICAgIH1cblxuICAgIGFzeW5jIGNhbkhhbmRsZShpbnB1dDogQ29udHJvbElucHV0KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSBpbnB1dC5yZXF1ZXN0O1xuICAgICAgICBpZiAocmVxdWVzdC50eXBlICE9PSAnSW50ZW50UmVxdWVzdCcpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBpbnRlbnQgPSByZXF1ZXN0LmludGVudDtcblxuICAgICAgICBjb25zdCB1bnBhY2tlZCA9IChpbnRlbnQubmFtZSA9PT0gJ0dlbmVyYWxDb250cm9sSW50ZW50JylcbiAgICAgICAgICAgID8gdW5wYWNrR2VuZXJhbENvbnRyb2xJbnRlbnQoaW50ZW50KVxuICAgICAgICAgICAgOiB1bnBhY2tTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQoaW50ZW50KTtcblxuICAgICAgICBpZiAodW5wYWNrZWQuYWN0aW9uID09PSAnYWRkQW5vdGhlcicpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuY2FuSGFuZGxlQnlDaGlsZChpbnB1dCk7XG4gICAgfVxuXG4gICAgYXN5bmMgaGFuZGxlKGlucHV0OiBDb250cm9sSW5wdXQsIHJlc3VsdEJ1aWxkZXI6IENvbnRyb2xSZXN1bHRCdWlsZGVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSBpbnB1dC5yZXF1ZXN0O1xuICAgICAgICBpZiAocmVxdWVzdC50eXBlICE9PSAnSW50ZW50UmVxdWVzdCcpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGludGVudCA9IHJlcXVlc3QuaW50ZW50O1xuICAgICAgICBjb25zdCB1bnBhY2tlZCA9IChpbnRlbnQubmFtZSA9PT0gJ0dlbmVyYWxDb250cm9sSW50ZW50JylcbiAgICAgICAgICAgID8gdW5wYWNrR2VuZXJhbENvbnRyb2xJbnRlbnQoaW50ZW50KVxuICAgICAgICAgICAgOiB1bnBhY2tTaW5nbGVWYWx1ZUNvbnRyb2xJbnRlbnQoaW50ZW50KTtcblxuICAgICAgICAvKlxuICAgICAgICAgKiBTcGVjaWFsIGJlaGF2aW9yICMxOiBBbHdheXMgaW5jbHVkZSB0aGUgY29udGVudCBhY3QgdG8gc3RhdGUgaG93IG1hbnkgY29udHJvbHMgd2UgY3VycmVudGx5IGhhdmUuXG4gICAgICAgICAqIFNwZWNpYWwgYmVoYXZpb3IgIzI6IElmIHRoZSBhY3Rpb24gaXMgYWRkQW5vdGhlciwgdGhlbiBoYW5kbGUgaXQgZGlyZWN0bHlcbiAgICAgICAgICogRGVmYXVsdCBiZWhhdmlvcjogZG8gdGhlIHVzdWFsIGNvbnRhaW5lckNvbnRyb2wgaGFuZGxpbmcuIGFuZCBtZXJnZSB3aXRoIFNwZWNpYWwgYmVoYXZpb3IgIzEuXG4gICAgICAgICAqL1xuXG4gICAgICAgIGlmICh1bnBhY2tlZC5hY3Rpb24gPT09ICdhZGRBbm90aGVyJykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZS5jb3VudCA9IHRoaXMuc3RhdGUuY291bnQgKyAxO1xuICAgICAgICAgICAgcmVzdWx0QnVpbGRlci5hZGRBY3QodGhpcy5jcmVhdGVDb250ZW50QWN0KHRoaXMuc3RhdGUuY291bnQpKTtcbiAgICAgICAgICAgIHRoaXMuY2hpbGRyZW4ucHVzaChNeU11bHRpQ29udHJvbC5tYWtlVmFsdWVDb250cm9sKHRoaXMuc3RhdGUuY291bnQpKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJlc3VsdEJ1aWxkZXIuYWRkQWN0KHRoaXMuY3JlYXRlQ29udGVudEFjdCh0aGlzLnN0YXRlLmNvdW50KSk7XG4gICAgICAgIGF3YWl0IHRoaXMuaGFuZGxlQnlDaGlsZChpbnB1dCwgcmVzdWx0QnVpbGRlcik7XG5cbiAgICAgICAgLypcbiAgICAgICAgICogWzFdIEJlY2F1c2UgaGFuZGxlQnlDaGlsZCBjYW4gcHJvZHVjZSBtdWx0aXBsZSBhY3RzLCBhZnRlciB0aGUgbWVyZ2Ugd2UgbWF5IGVuZCB1cCB3aXRoIGEgc3RyYW5nZSBvcmRlcmluZ1xuICAgICAgICAgKiAuLiBzbyB3ZSBkZXRlY3QgaXQgYW5kIGZpeCBpdC5cbiAgICAgICAgICogICAgIFsgY29udGVudEFjdCwgdmFsdWVTZXRBY3QsIDxpbml0aWF0aXZlQWN0PiBdXG4gICAgICAgICAqICAgICAgICBeLS0gcmVvcmRlciB0aGVzZSAtLV5cbiAgICAgICAgICovXG4gICAgICAgIGlmIChyZXN1bHRCdWlsZGVyLmFjdHNbMF0gaW5zdGFuY2VvZiBMaXRlcmFsQ29udGVudEFjdCAmJiByZXN1bHRCdWlsZGVyLmFjdHNbMV0gaW5zdGFuY2VvZiBWYWx1ZVNldEFjdCkge1xuICAgICAgICAgICAgbW92ZUFycmF5SXRlbShyZXN1bHRCdWlsZGVyLmFjdHMsIDEsIDApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNyZWF0ZUNvbnRlbnRBY3QoY291bnQ6IG51bWJlcik6IExpdGVyYWxDb250ZW50QWN0IHtcbiAgICAgICAgcmV0dXJuIG5ldyBMaXRlcmFsQ29udGVudEFjdCh0aGlzLCB7cHJvbXB0RnJhZ21lbnQ6IGBJIGhhdmUgJHtjb3VudH0gY2hpbGQgY29udHJvbCR7Y291bnQgPT09IDEgPyAnJyA6ICdzJ30uYH0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBzdGF0aWMgbWFrZVZhbHVlQ29udHJvbChpbmRleDogbnVtYmVyKTogQ29udHJvbCB7XG4gICAgICAgIHJldHVybiBuZXcgTXlWYWx1ZUNvbnRyb2woe1xuICAgICAgICAgICAgaWQ6IGB2YWx1ZSR7aW5kZXgudG9TdHJpbmcoKX1gLFxuICAgICAgICAgICAgc2xvdFR5cGU6ICdDVVNUT00ubmFtZScsXG4gICAgICAgICAgICBwcm9tcHRzOiB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdFZhbHVlOiBhY3QgPT4gYFdoYXQgdmFsdWUgZm9yIG51bWJlciAkeyhhY3QuY29udHJvbCBhcyBNeVZhbHVlQ29udHJvbCkuaW5kZXh9P2AsXG4gICAgICAgICAgICAgICAgdmFsdWVTZXQ6ICdPSy4nXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgcmVwcm9tcHRzOiB7XG4gICAgICAgICAgICAgICAgcmVxdWVzdFZhbHVlOiBhY3QgPT4gYFdoYXQgdmFsdWUgZm9yIG51bWJlciAkeyhhY3QuY29udHJvbCBhcyBNeVZhbHVlQ29udHJvbCkuaW5kZXh9P2AsXG4gICAgICAgICAgICAgICAgdmFsdWVTZXQ6ICdPSy4nXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgaW50ZXJhY3Rpb25Nb2RlbDogeyB0YXJnZXRzOiBbJ25hbWUnXSB9LFxuICAgICAgICAgICAgaW5kZXhcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgVmFyaWFibGVDb250cm9sc01hbmFnZXIgZXh0ZW5kcyBDb250cm9sTWFuYWdlciB7XG5cbiAgICBwdWJsaWMgY3JlYXRlQ29udHJvbFRyZWUoc3RhdGU6IGFueSk6IENvbnRyb2wge1xuXG4gICAgICAgIGNvbnN0IGNvbnRyb2xDb3VudCA9IHN0YXRlLm11bHRpVmFsdWVDb250YWluZXIgIT09IHVuZGVmaW5lZCA/IHN0YXRlLm11bHRpVmFsdWVDb250YWluZXIuY291bnQgIT09IHVuZGVmaW5lZCA/IHN0YXRlLm11bHRpVmFsdWVDb250YWluZXIuY291bnQgOiAxIDogMTtcbiAgICAgICAgY29uc3QgdG9wQ29udHJvbCA9IG5ldyBNeU11bHRpQ29udHJvbChcbiAgICAgICAgICAgIHsgaWQ6ICdtdWx0aVZhbHVlQ29udGFpbmVyJyB9LFxuICAgICAgICAgICAgeyBjb3VudDogMSB9XG4gICAgICAgICk7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gY29udHJvbENvdW50OyBpKyspIHtcbiAgICAgICAgICAgIHRvcENvbnRyb2wuYWRkQ2hpbGQoTXlNdWx0aUNvbnRyb2wubWFrZVZhbHVlQ29udHJvbChpKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdG9wQ29udHJvbDtcbiAgICB9XG5cbn1cblxuXG5cbmludGVyZmFjZSBNeVZhbHVlQ29udHJvbFByb3BzIGV4dGVuZHMgVmFsdWVDb250cm9sUHJvcHMge1xuICAgIGluZGV4OiBudW1iZXI7XG59XG5cbmNsYXNzIE15VmFsdWVDb250cm9sU3RhdGUgZXh0ZW5kcyBWYWx1ZUNvbnRyb2xTdGF0ZSB7XG4gICAgY291bnQ6IG51bWJlcjtcbn1cblxuY2xhc3MgTXlWYWx1ZUNvbnRyb2wgZXh0ZW5kcyBWYWx1ZUNvbnRyb2wge1xuICAgIGluZGV4OiBudW1iZXI7XG5cbiAgICBzdGF0ZTogTXlWYWx1ZUNvbnRyb2xTdGF0ZTtcblxuICAgIGNvbnN0cnVjdG9yKHByb3BzOiBNeVZhbHVlQ29udHJvbFByb3BzKSB7XG4gICAgICAgIHN1cGVyKHByb3BzKTtcbiAgICAgICAgdGhpcy5pbmRleCA9IHByb3BzLmluZGV4O1xuICAgIH1cbn0iXX0=